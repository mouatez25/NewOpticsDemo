
using Microsoft.Reporting.WinForms;
using NewOptics.Administrateur;
using NewOptics.Caisse;
using NewOptics.Stock;
using System;
using Nut;
using System.Collections;
using System.Collections.Generic;
using System.ComponentModel;
using System.Drawing.Imaging;
using System.Drawing.Printing;
using System.IO;
using System.Linq;
using System.ServiceModel;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Shapes;
using System.Windows.Threading;
using NewOptics.Commande;

namespace NewOptics.ClientA
{
    /// <summary>
    /// Interaction logic for MontureClient.xaml
    /// </summary>
    public partial class MontureClient :Window
    {
        SVC.ServiceCliniqueClient proxy;
        ICallback callback;
        SVC.MembershipOptic memberuser;
        SVC.ClientV Clientvv;
        private delegate void FaultedInvokerMonture();
        SVC.Monture MontureClass;
        bool nouvellemonture = false;
        bool anciennemonture = false;
        bool montureversementzero = false;
        List<SVC.MontureSupplement> listsupp1;
        List<SVC.MontureSupplement> listsupp2;
        List<SVC.MontureSupplement> listsupp3;
        List<SVC.MontureSupplement> listsupp4;
        List<SVC.MontureSupplement> anciennelistsupp1;
        List<SVC.MontureSupplement> anciennelistsupp2;
        List<SVC.MontureSupplement> anciennelistsupp3;
        List<SVC.MontureSupplement> anciennelistsupp4;
        int interfaceimpressionmonture = 0;
        bool visualiser = false;
        private IList<Stream> m_streams;
        private int m_currentPageIndex;
        Window dialog1;
        SVC.Param selectedparam;


        
        bool factureopern = false;
        SVC.F1 ancienneF1;
        SVC.F1 selectedF1;
        
        SVC.F1 nouveauF1;
        bool facturenew = false;
        bool facturemodif = false;
        private delegate void FaultedInvokerListePatient();
        List<SVC.Facture> factureselectedl;
        List<SVC.Facture> anciennefactureselectedl;
        List<SVC.Prodf> produitavendre = new List<SVC.Prodf>();
        
        int documenttype = 0;
       
        bool fermer = false;
       
    
       
        int interfacefacturation = 0;
        
       
        SVC.Prodf selectedtropuvé;
        SVC.Produit selectedtropuvéNONSTOCK;
       
       
        bool visualiserFacture = false;
        int interfaceimpressionfacture = 0;
        bool tunisie = false;
        bool facturenonstock = false;
        public MontureClient(SVC.ServiceCliniqueClient proxyrecu, ICallback callbackrecu, SVC.MembershipOptic memberrecu, SVC.ClientV clientrecu, SVC.Monture MONTURERECU)
        {
            try
            {
                InitializeComponent();

                proxy = proxyrecu;

                callback = callbackrecu;
                memberuser = memberrecu;
                Clientvv = clientrecu;
                selectedparam = proxy.GetAllParamétre();
                /******************************Monture***************************************/
                this.Title = "Dossier Monture : " + Clientvv.Raison;
                MontureDatagrid.ItemsSource = proxy.GetAllMonturebycode(Clientvv.Id).OrderBy(n => n.Date);
                if(MONTURERECU!=null)
                {
                    MontureClass = MONTURERECU;
                    montureexiste(MontureClass);
                    MontureDatagrid.SelectedItem = MONTURERECU;
                }
             //   else
               // {

                //}
               
               

                tsdfsdfgent.IsSelected = true;
                if (MontureClass.StatutVente == false)
                {
                    btnvente.IsEnabled = true;
                    txtMontantTotalENC.IsEnabled = true;
                }
                else
                {
                    btnvente.IsEnabled = false;
                    txtMontantTotalENC.IsEnabled = false;
                }
                /*  *********************************   */
                if (selectedparam.AffichPrixAchatVente == true)
                {
                    NomenclatureProduit.Columns[3].Visibility = Visibility.Visible;
                     ReceptDatagrid.Columns[9].Visibility = Visibility.Visible;
                }
                else
                {
                    NomenclatureProduit.Columns[3].Visibility = Visibility.Collapsed;
                     ReceptDatagrid.Columns[9].Visibility = Visibility.Collapsed;

                }
                if (selectedparam.ModiPrix == true)
                {
                    ReceptDatagrid.Columns[2].IsReadOnly = false;
                }
                else
                {
                    ReceptDatagrid.Columns[2].IsReadOnly = true;
                }
                if (selectedparam.modidate == true)
                {
                    txtDateOper.IsEnabled = true;
                }
                if (selectedparam.affiben == true)
                {
                    Bénéfice.Visibility = Visibility.Visible;
                    Bénéficemont.Visibility = Visibility.Visible;
 
                }
                /********************************Facturation*****************///////
                ListeDesDocuments.ItemsSource = proxy.GetAllF1Bycode(Clientvv.Id).Where(n => n.nfact.Substring(0, 2) != "Co").OrderBy(n => n.date);
                callbackrecu.InsertProdfListCallbackevent += new ICallback.CallbackEventHandler10(callbackrecuprodf_Refresh);
                callbackrecu.InsertProdfCallbackEvent += new ICallback.CallbackEventHandler21(callbackrecuprodf_Refresh);
                /***************************************/
                callbackrecu.InsertMontureCallbackevent += new ICallback.CallbackEventHandler34(callbackrecumonture_Refresh);

                /****************************Historique************************************************/
                callbackrecu.InsertF1CallbackEvent += new ICallback.CallbackEventHandler6(callbackrecu_Refresh);

                callbackrecu.InsertFactureVentefListCallbackevent += new ICallback.CallbackEventHandler11(callbackrecuFactureList_Refresh);
                callbackrecu.InsertF1ListCallbackEvent += new ICallback.CallbackEventHandler27(callbackrecuF1List_Refresh);
                /*****************************************************************/
                proxy.InnerDuplexChannel.Faulted += new EventHandler(InnerDuplexChannel_Faulted);

                proxy.InnerDuplexChannel.Closed += new EventHandler(InnerDuplexChannel_Closed);
            }
            catch (Exception ex)
            {
                HandleProxy();
            }
        }
        void callbackrecuFactureList_Refresh(object source, CallbackEventInsertListfacturevente e)
        {
            Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
            {
                AddRefreshFactureListVente(e.clientleav);
            }));
        }
        public void AddRefreshFactureListVente(List<SVC.Facture> memberfacture)
        {

            try
            {
                if (memberfacture.First().codeclient == Clientvv.Id && nouveauF1 != null)
                {
                    /*******************************************************************************************/
                    if (facturemodif == true && facturenew == false && nouveauF1.cle == memberfacture.First().cle)
                    {

                        ReceptDatagrid.ItemsSource = memberfacture;

                    }

                }

            }
            catch (Exception ex)
            {
                MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }



        }

    
        void callbackrecu_Refresh(object source, CallbackEventInsertF1 e)
        {
            Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
            {
                AddRefresh(e.clientleav, e.operleav);
            }));
        }
        public void AddRefresh(SVC.F1 listmembership, int oper)
        {

            try
            {
                //   MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show("i'm here", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                /*******************************************************************************************/
                if (listmembership.codeclient == Clientvv.Id || listmembership.cle == Clientvv.cle)
                {
                   /*****************facturation grid************/
                    var LISTITEM22 = ListeDesDocuments.ItemsSource as IEnumerable<SVC.F1>;
                    List<SVC.F1> LISTITEM2 = LISTITEM22.ToList();
                    if (listmembership.cle == Clientvv.cle || listmembership.codeclient == Clientvv.Id)
                    {
                        if (oper == 1)
                        {
                            LISTITEM2.Add(listmembership);

                        }
                        else
                        {
                            if (oper == 2)
                            {




                                var objectmodifed = LISTITEM2.Find(n => n.Id == listmembership.Id);
                                //objectmodifed = listmembership;
                                var index = LISTITEM2.IndexOf(objectmodifed);
                                if (index != -1)
                                    LISTITEM2[index] = listmembership;

                            }
                            else
                            {
                                if (oper == 3)
                                {
                                    var deleterendez = LISTITEM2.Where(n => n.Id == listmembership.Id).First();
                                    LISTITEM2.Remove(deleterendez);
                                }
                            }
                        }

                    }

                    ListeDesDocuments.ItemsSource = LISTITEM2.OrderBy(r => r.date);
                    if (oper == 1)
                    {
                        ListeDesDocuments.SelectedItem = listmembership;
                    }

                }
            }
            catch (Exception ex)
            {
                MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }



        }

        void callbackrecuF1List_Refresh(object source, CallbackEventInsertF1List e)
        {
            Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
            {
                AddRefreshF1ListVente(e.clientleav);
            }));
        }
        public void AddRefreshF1ListVente(List<SVC.F1> memberfacture)
        {

            try
            {


                try
                {
                    foreach (SVC.F1 listmembership in memberfacture)
                    {
                        //  MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show("i'm here3", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                        /*******************************************************************************************/
                        if (listmembership.codeclient == Clientvv.Id)
                        {
                         
                            var LISTITEM22 = ListeDesDocuments.ItemsSource as IEnumerable<SVC.F1>;
                            List<SVC.F1> LISTITEM2 = LISTITEM22.ToList();
                            if (listmembership.cle == Clientvv.cle || listmembership.codeclient == Clientvv.Id)
                            {





                                var objectmodifed = LISTITEM2.Find(n => n.Id == listmembership.Id);
                                //objectmodifed = listmembership;
                                var index = LISTITEM2.IndexOf(objectmodifed);
                                if (index != -1)
                                    LISTITEM2[index] = listmembership;




                            }

                            ListeDesDocuments.ItemsSource = LISTITEM2.OrderBy(r => r.date);


                        }
                    }
                }
                catch (Exception ex)
                {
                    MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                }
            }
            catch (Exception ex)
            {
                MessageBoxResult results = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }



        }

        void callbackrecuprodf_Refresh(object source, CallbackEventInsertProdf e)
        {
            try
            {
                Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
                {
                    AddRefreshProdf(e.clientleav, e.operleav);
                }));
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        public void AddRefreshProdf(SVC.Prodf listMembershipOptic, int oper)
        {
            try
            {
                if (factureopern == true)
                {
                    var LISTITEM1 = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;
                    List<SVC.Prodf> LISTITEM = LISTITEM1.ToList();

                    if (oper == 1)
                    {
                        LISTITEM.Add(listMembershipOptic);
                    }
                    else
                    {
                        if (oper == 2)
                        {

                            var objectmodifed = LISTITEM.Find(n => n.Id == listMembershipOptic.Id);
                            var index = LISTITEM.IndexOf(objectmodifed);
                            if (index != -1)
                                LISTITEM[index] = listMembershipOptic;
                        }
                        else
                        {
                            if (oper == 3)
                            {
                                var deleterendez = LISTITEM.Where(n => n.Id == listMembershipOptic.Id).First();
                                LISTITEM.Remove(deleterendez);
                            }
                        }
                    }

                    NomenclatureProduit.ItemsSource = LISTITEM;
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }

        }

        void callbackrecuprodf_Refresh(object source, CallbackEventInsertListProdf e)
        {
            try
            {
                Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
                {
                    AddRefreshProdfListe(e.clientleav, e.operleav);
                }));
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        public void AddRefreshProdfListe(List<SVC.Prodf> listMembershipOpticlist, int oper)
        {
            try
            {
                if (factureopern == true)
                {
                    var LISTITEM1 = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;


                    List<SVC.Prodf> LISTITEM = LISTITEM1.ToList();

                    foreach (var listMembershipOptic in listMembershipOpticlist)
                    {

                        if (oper == 1)
                        {
                            LISTITEM.Add(listMembershipOptic);
                        }
                        else
                        {
                            if (oper == 2 || oper == 4)
                            {



                                var objectmodifed = LISTITEM.Find(n => n.Id == listMembershipOptic.Id);
                                var index = LISTITEM.IndexOf(objectmodifed);
                                if (index != -1)
                                    LISTITEM[index] = listMembershipOptic;
                            }
                            else
                            {
                                if (oper == 3)
                                {
                                    var deleterendez = LISTITEM.Where(n => n.Id == listMembershipOptic.Id).First();
                                    LISTITEM.Remove(deleterendez);
                                }
                            }
                        }

                        NomenclatureProduit.ItemsSource = LISTITEM;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }

        }

        void callbackrecumonture_Refresh(object source, CallbackEventInsertMonture e)
        {
            try
            {
                Dispatcher.BeginInvoke(DispatcherPriority.Normal, new Action(delegate
                {
                    AddRefreshMonture(e.clientleav, e.operleav);
                }));
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        public void AddRefreshMonture(SVC.Monture listmembership, int oper)
        {
            try
            {

                var LISTITEM1 = MontureDatagrid.ItemsSource as IEnumerable<SVC.Monture>;
                List<SVC.Monture> LISTITEM = LISTITEM1.ToList();

                if (oper == 1)
                {
                    LISTITEM.Add(listmembership);
                }
                else
                {
                    if (oper == 2)
                    {
                        //   var objectmodifed = LISTITEM.Find(n => n.Id == listmembership.Id);
                        //  objectmodifed = listmembership;

                        var objectmodifed = LISTITEM.Find(n => n.Id == listmembership.Id);
                        //objectmodifed = listmembership;
                        var index = LISTITEM.IndexOf(objectmodifed);
                        if (index != -1)
                            LISTITEM[index] = listmembership;
                    }
                    else
                    {
                        if (oper == 3)
                        {
                            //    MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show("Supp rendezvous :"+ listmembership.Id.ToString(), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
                            var deleterendez = LISTITEM.Where(n => n.Id == listmembership.Id).First();
                            LISTITEM.Remove(deleterendez);
                        }
                    }
                }

                MontureDatagrid.ItemsSource = LISTITEM;


            }
            catch (Exception ex)
            {
                MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }

        }

        void InnerDuplexChannel_Closed(object sender, EventArgs e)
        {
            if (!this.Dispatcher.CheckAccess())
            {
                this.Dispatcher.BeginInvoke(DispatcherPriority.Normal, new FaultedInvokerMonture(HandleProxy));
                return;
            }
            HandleProxy();
        }




        private void chimpression_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                visualiser = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void chimpression_Unchecked(object sender, RoutedEventArgs e)
        {

            try
            {
                visualiser = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }

        }
        private void HandleProxy()
        {
            if (proxy != null)
            {
                switch (this.proxy.State)
                {
                    case CommunicationState.Closed:
                        proxy = null;
                        this.Close();
                        break;
                    case CommunicationState.Closing:
                        break;
                    case CommunicationState.Created:
                        break;
                    case CommunicationState.Faulted:
                        proxy.Abort();
                        proxy = null;
                        this.Close();

                        break;
                    case CommunicationState.Opened:


                        break;
                    case CommunicationState.Opening:
                        break;
                    default:
                        break;
                }
            }

        }
        void InnerDuplexChannel_Faulted(object sender, EventArgs e)
        {
            if (!this.Dispatcher.CheckAccess())
            {
                this.Dispatcher.BeginInvoke(DispatcherPriority.Normal, new FaultedInvokerMonture(HandleProxy));
                return;
            }
            HandleProxy();
        }

        private void btnNew_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (memberuser.CreationDossierClient == true)
                {
                    MontureClass = new SVC.Monture
                    {
                        Date = DateTime.Now,
                        UserName = memberuser.Username,
                        Délivre = false,
                        Monte = false,
                        RaisonClient = Clientvv.Raison,
                        StatutDevis = true,
                        StatutVente = false,
                        IdClient = Clientvv.Id,
                        EnMontage = false,
                        DroiteCylindrePlus = true,
                        DroiteCylindreMoin = false,
                        GaucheCylindreMoin = false,
                        GaucheCylindrePlus = true,
                        AccessoiresQuantite1 = 0,
                        AccessoiresQuantite2 = 0,
                        AccessoiresPrix1 = 0,
                        AccessoiresPrix2 = 0,
                        GaucheFleshBas = false,
                        GaucheFleshHaut = true,
                        GaucheFleshDroite = true,
                        GaucheFleshGauche = false,
                        DroiteFleshBas = false,
                        DroiteFleshHaut = true,
                        DroiteFleshDroite = true,
                        DroiteFleshGauche = false,
                        DroitPrixVerreLoin = 0,
                        Encaissé = 0,
                        Reste = 0,
                        Interm = true,
                        Loin = true,
                        Pres = true,
                        Dates = DateTime.Now,
                        DroitPrixVerrePres = 0,

                        GauchePrixVerreLoin = 0,
                        GauchePrixVerrePres = 0,
                        PrixMontureLoin = 0,
                        PrixMonturePres = 0,
                        Remise = 0,
                    };
                    GridMonture.DataContext = MontureClass;
                    GridMonture.IsEnabled = true;
                    TxtStatutGlobal.Content = "Devis";
                    TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;

                    nouvellemonture = true;
                    anciennemonture = false;
                    txtDroiteFleshHaut.Visibility = Visibility.Visible;
                    DroiteFleshBas.Visibility = Visibility.Collapsed;
                    txtDroiteFleshDroite.Visibility = Visibility.Visible;
                    txtDroiteFleshGauche.Visibility = Visibility.Collapsed;

                    txtGaucheFleshHaut.Visibility = Visibility.Visible;
                    txtGaucheFleshBas.Visibility = Visibility.Collapsed;
                    txtGaucheFleshDroite.Visibility = Visibility.Visible;
                    txtGaucheFleshGauche.Visibility = Visibility.Collapsed;

                    listsupp1 = new List<SVC.MontureSupplement>();
                    listsupp2 = new List<SVC.MontureSupplement>();
                    listsupp3 = new List<SVC.MontureSupplement>();
                    listsupp4 = new List<SVC.MontureSupplement>();
                    txtMontantTotalENC.IsEnabled = true;
                    btnvente.IsEnabled = false;
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }


        }

        private void btnSupp_Click(object sender, RoutedEventArgs e)
        {
            if (memberuser.SupressionDossierClient == true && MontureDatagrid.SelectedItem != null)
            {
                var selectedmonture = MontureDatagrid.SelectedItem as SVC.Monture;
                if (selectedmonture.StatutVente == false)
                {
                    bool sucees = false;
                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                    {

                        proxy.DeleteMonture(selectedmonture);
                        ts.Complete();
                        sucees = true;
                    }
                    if (sucees == true)
                    {
                        proxy.AjouterMontureRefresh(Clientvv.Id);
                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                    }

                }
                else
                {
                    if (selectedmonture.StatutVente == true)
                    {
                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez tout d'abord supprimer le document de vente associé", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                    }
                }
            }
        }

        private void btnEdit_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (MontureDatagrid.SelectedItem != null && memberuser.ModificationDossierClient == true)
                {
                    MontureClass = MontureDatagrid.SelectedItem as SVC.Monture;
                    GridMonture.DataContext = MontureClass;
                    GridMonture.IsEnabled = true;
                    nouvellemonture = false;
                    anciennemonture = true;
                    if (MontureClass.StatutVente == false)
                    {
                        btnvente.IsEnabled = true;
                        txtMontantTotalENC.IsEnabled = true;
                    }
                    else
                    {
                        btnvente.IsEnabled = false;
                        txtMontantTotalENC.IsEnabled = false;
                    }

                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";

                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }


                    if (MontureClass.DroiteFleshHaut == true)
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Visible;
                        DroiteFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Collapsed;
                        DroiteFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.DroiteFleshDroite == true)
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Visible;
                        txtDroiteFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Collapsed;
                        txtDroiteFleshGauche.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshHaut == true)
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Visible;
                        txtGaucheFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Collapsed;
                        txtGaucheFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshDroite == true)
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Visible;
                        txtGaucheFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Collapsed;
                        txtGaucheFleshGauche.Visibility = Visibility.Visible;
                    }
                    /**************************************************************/
                    if (MontureClass.Loin == true && MontureClass.Pres == true)
                    {
                        ODLOIN.Text = "Loin";
                        ODITERM.Text = "Interm.";
                        ODPRES.Text = "Près";
                        OGLOIN.Text = "Loin";
                        OGINTERM.Text = "Interm.";
                        OGPRES.Text = "Près";
                        MonturePresLabel.Text = "PRES";
                        MontureLoinLabel.Text = "LOIN";
                    }
                    else
                    {
                        if (MontureClass.Loin == true && MontureClass.Pres == false)
                        {
                            ODLOIN.Text = "Loin";
                            ODITERM.Text = "Loin";
                            ODPRES.Text = "Près";
                            OGLOIN.Text = "Loin";
                            OGINTERM.Text = "Loin";
                            OGPRES.Text = "Près";
                            MonturePresLabel.Text = "LOIN";
                            MontureLoinLabel.Text = "LOIN";
                        }
                        else
                        {
                            if (MontureClass.Loin == false && MontureClass.Pres == true)
                            {
                                ODLOIN.Text = "Loin";
                                ODITERM.Text = "Près";
                                ODPRES.Text = "Près";
                                OGLOIN.Text = "Loin";
                                OGINTERM.Text = "Près";
                                OGPRES.Text = "Près";
                                MonturePresLabel.Text = "PRES";
                                MontureLoinLabel.Text = "PRES";
                            }
                        }
                    }
                    if (MontureClass.Encaissé != 0)
                    {
                        montureversementzero = true;
                    }
                    else
                    {
                        montureversementzero = false;
                    }
                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";
                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }
                    listsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                    listsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                    listsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                    listsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
                    anciennelistsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                    anciennelistsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                    anciennelistsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                    anciennelistsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void btnImprimer_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                try
                {
                    if (MontureDatagrid.SelectedItem != null)
                    {
                        dialog1 = new Window();
                        dialog1.Title = "Impression";
                        dialog1.Template = Resources["template5"] as ControlTemplate;

                        // dialog1.Content = Resources["content"];
                        dialog1.ResizeMode = ResizeMode.NoResize;
                        dialog1.Width = 350;
                        dialog1.Height = 250;
                        dialog1.WindowStartupLocation = WindowStartupLocation.CenterScreen;
                        dialog1.ShowDialog();
                        interfaceimpressionmonture = 0;
                    }
                }
                catch (Exception ex)
                {
                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                }

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void RadioButton_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionmonture = 1;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void RadioButton_Checked_1(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionmonture = 2;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void RadioButton_Checked_2(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionmonture = 3;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void RadioButton_Checked_3(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionmonture = 4;

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void RunAtelierDouble(List<SVC.Monture> monture, List<SVC.ClientV> CLIENRECU)
        {
            try
            {

                LocalReport reportViewer1 = new LocalReport();


                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.FicheAtelierMontureDouble), false);
                // LocalReport reportViewer1 = new LocalReport();
                reportViewer1.LoadReportDefinition(MyRptStream);


                //reportViewer1.LoadReportDefinition(MyRptStream);

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                rds.Value = monture;
                reportViewer1.DataSources.Add(rds);
                var selpara = new List<SVC.Param>();
                SVC.Param paramlocal = (proxy.GetAllParamétre());
                paramlocal.logo = "D/Logo.jpg";
                selpara.Add((paramlocal));


                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", selpara));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", CLIENRECU));

                if (proxy.GetAllParamétre().logo != "")
                {

                    if (proxy.DownloadDocumentIsHere(proxy.GetAllParamétre().logo.ToString()) == true)
                    {
                        reportViewer1.EnableExternalImages = true;

                        String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                        ReportParameter paramLogo = new ReportParameter();
                        paramLogo.Name = "ImagePath";
                        //  paramLogo.Values.Add(@"file:///C:\Logo.png");
                        paramLogo.Values.Add(@"file:///" + photolocation);
                        reportViewer1.SetParameters(paramLogo);
                        // reportViewer1.LocalReport.SetParameters(parameter);
                    }

                }
                reportViewer1.Refresh();

                ExportA4(reportViewer1);
                Print(false);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void Print(bool landscape)
        {
            try
            {
                if (m_streams == null || m_streams.Count == 0)
                    throw new Exception("Error: no stream to print.");
                PrintDocument printdoc = new PrintDocument();
                if (!printdoc.PrinterSettings.IsValid)
                {
                    throw new Exception("Error: cannot find the default printer.");
                }
                else
                {
                    printdoc.DefaultPageSettings.Landscape = landscape;
                    printdoc.PrintPage += new PrintPageEventHandler(PrintPage);
                    m_currentPageIndex = 0;
                    printdoc.DocumentName = Clientvv.Raison;
                    printdoc.Print();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void PrintPage(object sender, PrintPageEventArgs ev)
        {
            try
            {
                Metafile pageImage = new
                   Metafile(m_streams[m_currentPageIndex]);

                // Adjust rectangular area with printer margins.
                System.Drawing.Rectangle adjustedRect = new System.Drawing.Rectangle(
                    ev.PageBounds.Left - (int)ev.PageSettings.HardMarginX,
                    ev.PageBounds.Top - (int)ev.PageSettings.HardMarginY,
                    ev.PageBounds.Width,
                    ev.PageBounds.Height);

                // Draw a white background for the report
                ev.Graphics.FillRectangle(new System.Drawing.SolidBrush(System.Drawing.Color.White), adjustedRect);

                // Draw the report content
                ev.Graphics.DrawImage(pageImage, adjustedRect);

                // Prepare for the next page. Make sure we haven't hit the end.
                m_currentPageIndex++;
                ev.HasMorePages = (m_currentPageIndex < m_streams.Count);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void ExportA4(LocalReport report)
        {
            try
            {
                string deviceInfo =
                  @"<DeviceInfo>
                <OutputFormat>EMF</OutputFormat>
                <PageWidth>5,708661in</PageWidth>
                <PageHeight>8,26772in</PageHeight>
                <MarginTop>0in</MarginTop>
                <MarginLeft>0in</MarginLeft>
                <MarginRight>0in</MarginRight>
                <MarginBottom>0in</MarginBottom>
            </DeviceInfo>";
                Warning[] warnings;
                m_streams = new List<Stream>();
                report.Render("Image", deviceInfo, CreateStream,
                   out warnings);
                foreach (Stream stream in m_streams)
                    stream.Position = 0;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }


        private void btnCreerImpression_Click(object sender, RoutedEventArgs e)
        {
            try
            {

                if (visualiser == true)
                {

                    switch (interfaceimpressionmonture)
                    {
                        case 1:
                            if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                            {
                                SVC.Monture selectedmont = MontureDatagrid.SelectedItem as SVC.Monture;
                                List<SVC.Monture> mm = new List<SVC.Monture>();
                                mm.Add(selectedmont);
                                List<SVC.ClientV> clientvvv = new List<SVC.ClientV>();
                                clientvvv.Add(Clientvv);
                                ImpressionFicheAtelier cl = new ImpressionFicheAtelier(proxy, mm, clientvvv, interfaceimpressionmonture);
                                cl.Show();
                                dialog1.Close();
                                interfaceimpressionmonture = 0;
                                visualiser = false;
                            }
                            break;
                        case 4:
                            if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                            {
                                SVC.Monture selectedmont = MontureDatagrid.SelectedItem as SVC.Monture;
                                List<SVC.Monture> mm = new List<SVC.Monture>();
                                mm.Add(selectedmont);
                                List<SVC.ClientV> clientvvv = new List<SVC.ClientV>();
                                clientvvv.Add(Clientvv);
                                ImpressionFicheAtelier cl = new ImpressionFicheAtelier(proxy, mm, clientvvv, interfaceimpressionmonture);
                                cl.Show();

                                dialog1.Close();
                                interfaceimpressionmonture = 0;
                                visualiser = false;
                            }
                            break;
                        case 3:
                            if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                            {
                                SVC.Monture selecedmonture = MontureDatagrid.SelectedItem as SVC.Monture;

                                if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == true)
                                {

                                    List<SVC.Monture> listmonture = new List<SVC.Monture>();
                                    listmonture.Add(selecedmonture);
                                    var VisiteApayerexiste = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).Any();
                                    if (VisiteApayerexiste == true)
                                    {
                                        SVC.F1 VisiteApayer = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).First();
                                        var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                        if (dpfexiste == true)
                                        {
                                            /* List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                             List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                             listedepaiem.Add(dpf.First());*/

                                            List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                            List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                            dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                            listedepaiem.Add(dpf.Last());

                                            List<SVC.F1> listevisite = new List<SVC.F1>();
                                            listevisite.Add(VisiteApayer);
                                            List<SVC.ClientV> listclient = new List<SVC.ClientV>();
                                            listclient.Add(Clientvv);
                                            ImpressionMonturePaiement cl = new ImpressionMonturePaiement(proxy, listmonture, listclient, interfaceimpressionmonture, listevisite, listedepaiem);
                                            cl.Show();
                                            dialog1.Close();
                                            interfaceimpressionmonture = 0;
                                            visualiser = false;
                                        }
                                        else
                                        {
                                            MessageBoxResult dresult = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                        }
                                    }
                                }
                                else
                                {
                                    if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == false)
                                    {
                                        List<SVC.Monture> listmonture = new List<SVC.Monture>();
                                        listmonture.Add(selecedmonture);

                                        var dpfexiste = proxy.GetAllDepeimentByF1(selecedmonture.Cle).Any();
                                        if (dpfexiste == true)
                                        {
                                            /* List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                             List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                             listedepaiem.Add(dpf.First());*/

                                            List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(selecedmonture.Cle);
                                            List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                            dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                            listedepaiem.Add(dpf.Last());

                                            List<SVC.F1> listevisite = new List<SVC.F1>();
                                            SVC.F1 VisiteApayer = new SVC.F1
                                            {
                                                codeclient = selecedmonture.IdClient,
                                                raison = selecedmonture.RaisonClient,
                                            };
                                            listevisite.Add(VisiteApayer);
                                            List<SVC.ClientV> listclient = new List<SVC.ClientV>();
                                            listclient.Add(Clientvv);
                                            ImpressionMonturePaiement cl = new ImpressionMonturePaiement(proxy, listmonture, listclient, interfaceimpressionmonture, listevisite, listedepaiem);
                                            cl.Show();
                                            dialog1.Close();
                                            interfaceimpressionmonture = 0;
                                            visualiser = false;
                                        }
                                        else
                                        {
                                            MessageBoxResult dresult = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                        }
                                    }
                                    else
                                    {
                                        MessageBoxResult dresult = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                    }

                                }
                            }
                            break;
                        case 2:
                            if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                            {
                                SVC.Monture selecedmonture = MontureDatagrid.SelectedItem as SVC.Monture;
                                if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == true)
                                {
                                    var VisiteApayerexiste = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).Any();
                                    if (VisiteApayerexiste == true)
                                    {
                                        SVC.F1 VisiteApayer = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).First();
                                        var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                        if (dpfexiste == true)
                                        {
                                            //  var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                            List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                            List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                            dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                            listedepaiem.Add(dpf.Last());
                                            List<SVC.F1> listevisite = new List<SVC.F1>();
                                            listevisite.Add(VisiteApayer);
                                            ImpressionRecu cl = new ImpressionRecu(proxy, listedepaiem, listevisite);
                                            cl.Show();
                                            dialog1.Close();
                                            interfaceimpressionmonture = 0;
                                            visualiser = false;
                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }
                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                    }
                                }
                                else
                                {
                                    if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == false)
                                    {

                                        var dpfexiste = proxy.GetAllDepeimentByF1(selecedmonture.Cle).Any();
                                        if (dpfexiste == true)
                                        {
                                            //  var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                            List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(selecedmonture.Cle);
                                            List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                            dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                            listedepaiem.Add(dpf.Last());
                                            List<SVC.F1> listevisite = new List<SVC.F1>();
                                            SVC.F1 VisiteApayer = new SVC.F1
                                            {
                                                codeclient = selecedmonture.IdClient,
                                                raison = selecedmonture.RaisonClient,
                                            };
                                            listevisite.Add(VisiteApayer);
                                            ImpressionRecu cl = new ImpressionRecu(proxy, listedepaiem, listevisite);
                                            cl.Show();
                                            dialog1.Close();
                                            interfaceimpressionmonture = 0;
                                            visualiser = false;
                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }

                                    }
                                }
                            }
                            break;

                    }

                }
                else
                {
                    if (visualiser == false)
                    {
                        switch (interfaceimpressionmonture)
                        {
                            case 1:
                                if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                                {
                                    SVC.Monture selectedmont = MontureDatagrid.SelectedItem as SVC.Monture;
                                    List<SVC.Monture> mm = new List<SVC.Monture>();
                                    mm.Add(selectedmont);
                                    List<SVC.ClientV> clientvvv = new List<SVC.ClientV>();
                                    clientvvv.Add(Clientvv);
                                    RunAtelier(mm, clientvvv);
                                    visualiser = false;
                                    dialog1.Close();
                                    interfaceimpressionmonture = 0;
                                    visualiser = false;

                                }
                                break;
                            case 4:
                                if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                                {
                                    SVC.Monture selectedmont = MontureDatagrid.SelectedItem as SVC.Monture;
                                    List<SVC.Monture> mm = new List<SVC.Monture>();
                                    mm.Add(selectedmont);
                                    List<SVC.ClientV> clientvvv = new List<SVC.ClientV>();
                                    clientvvv.Add(Clientvv);
                                    RunAtelierDouble(mm, clientvvv);
                                    visualiser = false;
                                    dialog1.Close();
                                    interfaceimpressionmonture = 0;
                                    visualiser = false;
                                }
                                break;
                            case 3:
                                if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                                {
                                    SVC.Monture selecedmonture = MontureDatagrid.SelectedItem as SVC.Monture;
                                    if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == true)
                                    {
                                        List<SVC.Monture> listmonture = new List<SVC.Monture>();
                                        listmonture.Add(selecedmonture);
                                        var VisiteApayerexiste = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).Any();
                                        if (VisiteApayerexiste == true)
                                        {
                                            SVC.F1 VisiteApayer = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).First();
                                            var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                            if (dpfexiste == true)
                                            {
                                                /* List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                                 List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                 listedepaiem.Add(dpf.First());*/

                                                List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                                List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                                listedepaiem.Add(dpf.Last());

                                                List<SVC.F1> listevisite = new List<SVC.F1>();
                                                listevisite.Add(VisiteApayer);
                                                List<SVC.ClientV> listclient = new List<SVC.ClientV>();
                                                listclient.Add(Clientvv);
                                                RunMonturePaiement(listmonture, listclient, listevisite, listedepaiem);
                                                visualiser = false;
                                                dialog1.Close();
                                                interfaceimpressionmonture = 0;
                                                visualiser = false;
                                            }
                                            else
                                            {
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }
                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }
                                    }
                                    else
                                    {
                                        if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == false)
                                        {
                                            List<SVC.Monture> listmonture = new List<SVC.Monture>();
                                            listmonture.Add(selecedmonture);

                                            var dpfexiste = proxy.GetAllDepeimentByF1(selecedmonture.Cle).Any();
                                            if (dpfexiste == true)
                                            {
                                                /* List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                                 List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                 listedepaiem.Add(dpf.First());*/

                                                List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(selecedmonture.Cle);
                                                List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                                listedepaiem.Add(dpf.Last());

                                                List<SVC.F1> listevisite = new List<SVC.F1>();
                                                SVC.F1 VisiteApayer = new SVC.F1
                                                {
                                                    codeclient = selecedmonture.IdClient,
                                                    raison = selecedmonture.RaisonClient,
                                                };
                                                listevisite.Add(VisiteApayer);
                                                List<SVC.ClientV> listclient = new List<SVC.ClientV>();
                                                listclient.Add(Clientvv);
                                                RunMonturePaiement(listmonture, listclient, listevisite, listedepaiem);
                                                visualiser = false;
                                                dialog1.Close();
                                                interfaceimpressionmonture = 0;
                                                visualiser = false;
                                            }
                                            else
                                            {
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }

                                        }
                                    }
                                }
                                break;
                            case 2:
                                if (MontureDatagrid.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                                {
                                    SVC.Monture selecedmonture = MontureDatagrid.SelectedItem as SVC.Monture;
                                    if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == true)
                                    {
                                        var VisiteApayerexiste = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).Any();
                                        if (VisiteApayerexiste == true)
                                        {
                                            SVC.F1 VisiteApayer = proxy.GetAllF1ByCleDossier(selecedmonture.Cle).First();
                                            var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                            if (dpfexiste == true)
                                            {
                                                //  var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                                List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(VisiteApayer.cle);
                                                List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                                listedepaiem.Add(dpf.Last());
                                                List<SVC.F1> listevisite = new List<SVC.F1>();
                                                listevisite.Add(VisiteApayer);
                                                RunRecu(listedepaiem, listevisite);

                                                dialog1.Close();
                                                interfaceimpressionmonture = 0;
                                                visualiser = false;
                                            }
                                            else
                                            {
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }
                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }
                                    }
                                    else
                                    {
                                        if (selecedmonture.StatutDevis == true && selecedmonture.StatutVente == false)
                                        {

                                            var dpfexiste = proxy.GetAllDepeimentByF1(selecedmonture.Cle).Any();
                                            if (dpfexiste == true)
                                            {
                                                //  var dpfexiste = proxy.GetAllDepeimentByF1(VisiteApayer.cle).Any();
                                                List<SVC.Depeiment> dpf = proxy.GetAllDepeimentByF1(selecedmonture.Cle);
                                                List<SVC.Depeiment> listedepaiem = new List<SVC.Depeiment>();
                                                dpf.Last().montant = dpf.AsEnumerable().Sum(n => n.montant);
                                                listedepaiem.Add(dpf.Last());
                                                List<SVC.F1> listevisite = new List<SVC.F1>();
                                                SVC.F1 VisiteApayer = new SVC.F1
                                                {
                                                    codeclient = selecedmonture.IdClient,
                                                    raison = selecedmonture.RaisonClient,
                                                };
                                                listevisite.Add(VisiteApayer);
                                                RunRecu(listedepaiem, listevisite);

                                                dialog1.Close();
                                                interfaceimpressionmonture = 0;
                                                visualiser = false;
                                            }
                                            else
                                            {
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Paiement inéxistant", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }

                                        }
                                    }
                                }
                                break;

                        }
                    }
                }






            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void RunRecu(List<SVC.Depeiment> listerecu, List<SVC.F1> listevisite)
        {
            try
            {

                LocalReport reportViewer1 = new LocalReport();


                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.RecuDePaiement), false);
                // LocalReport reportViewer1 = new LocalReport();
                reportViewer1.LoadReportDefinition(MyRptStream);


                //reportViewer1.LoadReportDefinition(MyRptStream);

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                rds.Value = listerecu;
                reportViewer1.DataSources.Add(rds);
                var selpara = new List<SVC.Param>();
                SVC.Param paramlocal = (proxy.GetAllParamétre());
                paramlocal.logo = "D/Logo.jpg";
                selpara.Add((paramlocal));


                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", selpara));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", listevisite));

                if (proxy.GetAllParamétre().logo != "")
                {

                    if (proxy.DownloadDocumentIsHere(proxy.GetAllParamétre().logo.ToString()) == true)
                    {
                        reportViewer1.EnableExternalImages = true;

                        String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                        ReportParameter paramLogo = new ReportParameter();
                        paramLogo.Name = "ImagePath";
                        //  paramLogo.Values.Add(@"file:///C:\Logo.png");
                        paramLogo.Values.Add(@"file:///" + photolocation);
                        reportViewer1.SetParameters(paramLogo);
                        // reportViewer1.LocalReport.SetParameters(parameter);
                    }

                }
                reportViewer1.Refresh();

                Export(reportViewer1);
                Print(true);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void ExportLand(LocalReport report)
        {
            try
            {

                /* string deviceInfo =
                   @"<DeviceInfo>
                 <OutputFormat>EMF</OutputFormat>
                  <PageWidth>& w / 100 & "in</PageWidth>
                 <PageHeight>& h / 100 & </PageHeight>
                 <MarginTop>0.cm</MarginTop>
                 <MarginLeft>0in</MarginLeft>
                 <MarginRight>0in</MarginRight>
                 <MarginBottom>0in</MarginBottom>
             </DeviceInfo>";*/

                string deviceInfo =
                     @"<DeviceInfo>
                <OutputFormat>EMF</OutputFormat>
                 <PageWidth>8.5inin</PageWidth>
                <PageHeight>5.87in</PageHeight>
                <MarginTop>0in</MarginTop>
                <MarginLeft>0in</MarginLeft>
                <MarginRight>0in</MarginRight>
                <MarginBottom>0in</MarginBottom>
            </DeviceInfo>";


                Warning[] warnings;
                m_streams = new List<Stream>();
                report.Render("Image", deviceInfo, CreateStream,
                   out warnings);
                foreach (Stream stream in m_streams)
                    stream.Position = 0;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void Export(LocalReport report)
        {
            try
            {

                /* string deviceInfo =
                   @"<DeviceInfo>
                 <OutputFormat>EMF</OutputFormat>
                  <PageWidth>& w / 100 & "in</PageWidth>
                 <PageHeight>& h / 100 & </PageHeight>
                 <MarginTop>0.cm</MarginTop>
                 <MarginLeft>0in</MarginLeft>
                 <MarginRight>0in</MarginRight>
                 <MarginBottom>0in</MarginBottom>
             </DeviceInfo>";*/

                string deviceInfo =
                     @"<DeviceInfo>
                <OutputFormat>EMF</OutputFormat>
                 <PageWidth>5.87in</PageWidth>
                <PageHeight>8.5in</PageHeight>
                <MarginTop>0.5cm</MarginTop>
                <MarginLeft>0in</MarginLeft>
                <MarginRight>0in</MarginRight>
                <MarginBottom>0.39in</MarginBottom>
            </DeviceInfo>";


                Warning[] warnings;
                m_streams = new List<Stream>();
                report.Render("Image", deviceInfo, CreateStream,
                   out warnings);
                foreach (Stream stream in m_streams)
                    stream.Position = 0;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private Stream CreateStream(string name,
string fileNameExtension, Encoding encoding,
string mimeType, bool willSeek)
        {
            Stream stream = new MemoryStream();
            m_streams.Add(stream);
            return stream;
        }
        private void RunMonturePaiement(List<SVC.Monture> monture, List<SVC.ClientV> CLIENRECU, List<SVC.F1> listevisite, List<SVC.Depeiment> listerecu)
        {
            try
            {

                LocalReport reportViewer1 = new LocalReport();


                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.ImpressionFicheAtelierMontureRecu), false);
                // LocalReport reportViewer1 = new LocalReport();
                reportViewer1.LoadReportDefinition(MyRptStream);


                //reportViewer1.LoadReportDefinition(MyRptStream);

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                rds.Value = monture;
                reportViewer1.DataSources.Add(rds);
                var selpara = new List<SVC.Param>();
                SVC.Param paramlocal = (proxy.GetAllParamétre());
                paramlocal.logo = "D/Logo.jpg";
                selpara.Add((paramlocal));


                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", selpara));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", CLIENRECU));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet4", listerecu));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet5", listevisite));
                if (proxy.GetAllParamétre().logo != "")
                {

                    if (proxy.DownloadDocumentIsHere(proxy.GetAllParamétre().logo.ToString()) == true)
                    {
                        reportViewer1.EnableExternalImages = true;

                        String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                        ReportParameter paramLogo = new ReportParameter();
                        paramLogo.Name = "ImagePath";
                        //  paramLogo.Values.Add(@"file:///C:\Logo.png");
                        paramLogo.Values.Add(@"file:///" + photolocation);
                        reportViewer1.SetParameters(paramLogo);
                        // reportViewer1.LocalReport.SetParameters(parameter);
                    }

                }
                reportViewer1.Refresh();

                ExportA4(reportViewer1);
                Print(false);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void RunAtelier(List<SVC.Monture> monture, List<SVC.ClientV> CLIENRECU)
        {
            try
            {

                LocalReport reportViewer1 = new LocalReport();


                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.FicheAtelierMonture), false);
                // LocalReport reportViewer1 = new LocalReport();
                reportViewer1.LoadReportDefinition(MyRptStream);


                //reportViewer1.LoadReportDefinition(MyRptStream);

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                rds.Value = monture;
                reportViewer1.DataSources.Add(rds);
                var selpara = new List<SVC.Param>();
                SVC.Param paramlocal = (proxy.GetAllParamétre());
                paramlocal.logo = "D/Logo.jpg";
                selpara.Add((paramlocal));


                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", selpara));
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", CLIENRECU));

                if (proxy.GetAllParamétre().logo != "")
                {

                    if (proxy.DownloadDocumentIsHere(proxy.GetAllParamétre().logo.ToString()) == true)
                    {
                        reportViewer1.EnableExternalImages = true;

                        String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                        ReportParameter paramLogo = new ReportParameter();
                        paramLogo.Name = "ImagePath";
                        //  paramLogo.Values.Add(@"file:///C:\Logo.png");
                        paramLogo.Values.Add(@"file:///" + photolocation);
                        reportViewer1.SetParameters(paramLogo);
                        // reportViewer1.LocalReport.SetParameters(parameter);
                    }

                }
                reportViewer1.Refresh();

                ExportLand(reportViewer1);
                Print(true);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }


        private void MontureDatagrid_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (MontureDatagrid.SelectedItem != null && memberuser.ModificationDossierClient == true)
                {
                    MontureClass = MontureDatagrid.SelectedItem as SVC.Monture;
                    GridMonture.DataContext = MontureClass;
                    GridMonture.IsEnabled = true;
                    nouvellemonture = false;
                    anciennemonture = true;
                    if (MontureClass.StatutVente == false)
                    {
                        btnvente.IsEnabled = true;
                        txtMontantTotalENC.IsEnabled = true;
                    }
                    else
                    {
                        btnvente.IsEnabled = false;
                        txtMontantTotalENC.IsEnabled = false;
                    }

                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";

                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }


                    if (MontureClass.DroiteFleshHaut == true)
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Visible;
                        DroiteFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Collapsed;
                        DroiteFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.DroiteFleshDroite == true)
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Visible;
                        txtDroiteFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Collapsed;
                        txtDroiteFleshGauche.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshHaut == true)
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Visible;
                        txtGaucheFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Collapsed;
                        txtGaucheFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshDroite == true)
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Visible;
                        txtGaucheFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Collapsed;
                        txtGaucheFleshGauche.Visibility = Visibility.Visible;
                    }
                    /**************************************************************/
                    if (MontureClass.Loin == true && MontureClass.Pres == true)
                    {

                        ODLOIN.Text = "Loin";
                        ODITERM.Text = "Interm.";
                        ODPRES.Text = "Près";
                        OGLOIN.Text = "Loin";
                        OGINTERM.Text = "Interm.";
                        OGPRES.Text = "Près";
                        MonturePresLabel.Text = "PRES";
                        MontureLoinLabel.Text = "LOIN";


                    }
                    else
                    {
                        if (MontureClass.Loin == true && MontureClass.Pres == false)
                        {


                            ODLOIN.Text = "Loin";
                            ODITERM.Text = "Loin";
                            ODPRES.Text = "Près";
                            OGLOIN.Text = "Loin";
                            OGINTERM.Text = "Loin";
                            OGPRES.Text = "Près";
                            MonturePresLabel.Text = "LOIN";
                            MontureLoinLabel.Text = "LOIN";


                        }
                        else
                        {
                            if (MontureClass.Loin == false && MontureClass.Pres == true)
                            {
                                ODLOIN.Text = "Loin";
                                ODITERM.Text = "Près";
                                ODPRES.Text = "Près";
                                OGLOIN.Text = "Loin";
                                OGINTERM.Text = "Près";
                                OGPRES.Text = "Près";
                                MonturePresLabel.Text = "PRES";
                                MontureLoinLabel.Text = "PRES";
                            }
                        }
                    }
                    if (MontureClass.Encaissé != 0)
                    {
                        montureversementzero = true;
                    }
                    else
                    {
                        montureversementzero = false;
                    }
                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";

                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }

                }
                listsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                listsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                listsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                listsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
                anciennelistsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                anciennelistsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                anciennelistsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                anciennelistsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void btnformule_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                /********************GroiteLoin*************************************/
                if (txtLoinSphereDroite.Text != "" && txtLoinCylindreDroite.Text != "" && txtLoinAxeDroite.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtLoinSphereDroite.Text != "")
                    {
                        if (decimal.TryParse(txtLoinSphereDroite.Text, out sphere))
                            sphere = Convert.ToDecimal(txtLoinSphereDroite.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtLoinSphereDroite.Text = "";
                        sphere = 0;
                    }
                    if (txtLoinCylindreDroite.Text != "")
                    {
                        if (decimal.TryParse(txtLoinCylindreDroite.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtLoinCylindreDroite.Text);
                            if (cylindre > 0)
                            {
                                MontureClass.DroiteCylindrePlus = true;
                                MontureClass.DroiteCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.DroiteCylindrePlus = false;
                                    MontureClass.DroiteCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtLoinCylindreDroite.Text = "";
                        cylindre = 0;
                    }

                    if (txtLoinAxeDroite.Text != "")
                    {
                        if (int.TryParse(txtLoinAxeDroite.Text, out axe))
                            axe = Convert.ToInt16(txtLoinAxeDroite.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtLoinAxeDroite.Text = "";
                        axe = 0;
                    }
                    txtLoinCylindreDroite.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtLoinSphereDroite.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.DroiteCylindrePlus == true && MontureClass.DroiteCylindreMoin == false)
                    {
                        txtLoinAxeDroite.Text = (axe + 90).ToString();
                        MontureClass.DroiteCylindrePlus = false;
                        MontureClass.DroiteCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.DroiteCylindrePlus == false && MontureClass.DroiteCylindreMoin == true)
                        {
                            txtLoinAxeDroite.Text = (axe - 90).ToString();
                            MontureClass.DroiteCylindrePlus = true;
                            MontureClass.DroiteCylindreMoin = false;
                        }
                    }
                }
                /********************GroiteIntermediaire*************************************/
                if (txtIntermSphereDroite.Text != "" && txtIntermCylindreDroite.Text != "" && txtIntermAxeDroite.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtIntermSphereDroite.Text != "")
                    {
                        if (decimal.TryParse(txtIntermSphereDroite.Text, out sphere))
                            sphere = Convert.ToDecimal(txtIntermSphereDroite.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtIntermSphereDroite.Text = "";
                        sphere = 0;
                    }
                    if (txtIntermCylindreDroite.Text != "")
                    {
                        if (decimal.TryParse(txtIntermCylindreDroite.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtIntermCylindreDroite.Text);

                            if (cylindre > 0)
                            {
                                MontureClass.DroiteCylindrePlus = true;
                                MontureClass.DroiteCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.DroiteCylindrePlus = false;
                                    MontureClass.DroiteCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtIntermCylindreDroite.Text = "";
                        cylindre = 0;
                    }

                    if (txtIntermAxeDroite.Text != "")
                    {
                        if (int.TryParse(txtIntermAxeDroite.Text, out axe))
                            axe = Convert.ToInt16(txtIntermAxeDroite.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtIntermAxeDroite.Text = "";
                        axe = 0;
                    }
                    txtIntermCylindreDroite.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtIntermSphereDroite.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.DroiteCylindrePlus == true && MontureClass.DroiteCylindreMoin == false)
                    {
                        txtIntermAxeDroite.Text = (axe + 90).ToString();
                        MontureClass.DroiteCylindrePlus = false;
                        MontureClass.DroiteCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.DroiteCylindrePlus == false && MontureClass.DroiteCylindreMoin == true)
                        {
                            txtIntermAxeDroite.Text = (axe - 90).ToString();
                            MontureClass.DroiteCylindrePlus = true;
                            MontureClass.DroiteCylindreMoin = false;
                        }
                    }
                }

                /********************GroitePres*************************************/
                if (txtPresSphereDroite.Text != "" && txtPresCylindreDroite.Text != "" && txtPresAxeDroite.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtPresSphereDroite.Text != "")
                    {
                        if (decimal.TryParse(txtPresSphereDroite.Text, out sphere))
                            sphere = Convert.ToDecimal(txtPresSphereDroite.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtPresSphereDroite.Text = "";
                        sphere = 0;
                    }
                    if (txtPresCylindreDroite.Text != "")
                    {
                        if (decimal.TryParse(txtPresCylindreDroite.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtPresCylindreDroite.Text);
                            if (cylindre > 0)
                            {
                                MontureClass.DroiteCylindrePlus = true;
                                MontureClass.DroiteCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.DroiteCylindrePlus = false;
                                    MontureClass.DroiteCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtPresCylindreDroite.Text = "";
                        cylindre = 0;
                    }

                    if (txtPresAxeDroite.Text != "")
                    {
                        if (int.TryParse(txtPresAxeDroite.Text, out axe))
                            axe = Convert.ToInt16(txtPresAxeDroite.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtPresAxeDroite.Text = "";
                        axe = 0;
                    }
                    txtPresCylindreDroite.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtPresSphereDroite.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.DroiteCylindrePlus == true && MontureClass.DroiteCylindreMoin == false)
                    {
                        txtPresAxeDroite.Text = (axe + 90).ToString();
                        MontureClass.DroiteCylindrePlus = false;
                        MontureClass.DroiteCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.DroiteCylindrePlus == false && MontureClass.DroiteCylindreMoin == true)
                        {
                            txtPresAxeDroite.Text = (axe - 90).ToString();
                            MontureClass.DroiteCylindrePlus = true;
                            MontureClass.DroiteCylindreMoin = false;
                        }
                    }
                }
                /*****************************GAUUUUUUUUUCHHHHHHHHHHHHHHEEEEE*****************************/
                /********************GaucheLoin*************************************/
                if (txtLoinSphereGauche.Text != "" && txtLoinCylindreGauche.Text != "" && txtLoinAxeGauche.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtLoinSphereGauche.Text != "")
                    {
                        if (decimal.TryParse(txtLoinSphereGauche.Text, out sphere))
                            sphere = Convert.ToDecimal(txtLoinSphereGauche.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtLoinSphereGauche.Text = "";
                        sphere = 0;
                    }
                    if (txtLoinCylindreGauche.Text != "")
                    {
                        if (decimal.TryParse(txtLoinCylindreGauche.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtLoinCylindreGauche.Text);
                            if (cylindre > 0)
                            {
                                MontureClass.GaucheCylindrePlus = true;
                                MontureClass.GaucheCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.GaucheCylindrePlus = false;
                                    MontureClass.GaucheCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtLoinCylindreGauche.Text = "";
                        cylindre = 0;
                    }

                    if (txtLoinAxeGauche.Text != "")
                    {
                        if (int.TryParse(txtLoinAxeGauche.Text, out axe))
                            axe = Convert.ToInt16(txtLoinAxeGauche.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtLoinAxeGauche.Text = "";
                        axe = 0;
                    }
                    txtLoinCylindreGauche.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtLoinSphereGauche.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.GaucheCylindrePlus == true && MontureClass.GaucheCylindreMoin == false)
                    {
                        txtLoinAxeGauche.Text = (axe + 90).ToString();
                        MontureClass.GaucheCylindrePlus = false;
                        MontureClass.GaucheCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.GaucheCylindrePlus == false && MontureClass.GaucheCylindreMoin == true)
                        {
                            txtLoinAxeGauche.Text = (axe - 90).ToString();
                            MontureClass.GaucheCylindrePlus = true;
                            MontureClass.GaucheCylindreMoin = false;
                        }
                    }
                }
                /********************GaucheIntermediarire*************************************/
                if (txtIntermSphereGauche.Text != "" && txtIntermCylindreGauche.Text != "" && txtIntermAxeGauche.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtIntermSphereGauche.Text != "")
                    {
                        if (decimal.TryParse(txtIntermSphereGauche.Text, out sphere))
                            sphere = Convert.ToDecimal(txtIntermSphereGauche.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtIntermSphereGauche.Text = "";
                        sphere = 0;
                    }
                    if (txtIntermCylindreGauche.Text != "")
                    {
                        if (decimal.TryParse(txtIntermCylindreGauche.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtIntermCylindreGauche.Text);
                            if (cylindre > 0)
                            {
                                MontureClass.GaucheCylindrePlus = true;
                                MontureClass.GaucheCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.GaucheCylindrePlus = false;
                                    MontureClass.GaucheCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtIntermCylindreGauche.Text = "";
                        cylindre = 0;
                    }

                    if (txtIntermAxeGauche.Text != "")
                    {
                        if (int.TryParse(txtIntermAxeGauche.Text, out axe))
                            axe = Convert.ToInt16(txtIntermAxeGauche.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtIntermAxeGauche.Text = "";
                        axe = 0;
                    }
                    txtIntermCylindreGauche.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtIntermSphereGauche.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.GaucheCylindrePlus == true && MontureClass.GaucheCylindreMoin == false)
                    {
                        txtIntermAxeGauche.Text = (axe + 90).ToString();
                        MontureClass.GaucheCylindrePlus = false;
                        MontureClass.GaucheCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.GaucheCylindrePlus == false && MontureClass.GaucheCylindreMoin == true)
                        {
                            txtIntermAxeGauche.Text = (axe - 90).ToString();
                            MontureClass.GaucheCylindrePlus = true;
                            MontureClass.GaucheCylindreMoin = false;
                        }
                    }
                }
                /********************GauchePres*************************************/
                if (txtPresSphereGauche.Text != "" && txtPresCylindreGauche.Text != "" && txtPresAxeGauche.Text != "")
                {

                    int axe = 0;
                    decimal sphere, cylindre = 0;

                    if (txtPresSphereGauche.Text != "")
                    {
                        if (decimal.TryParse(txtPresSphereGauche.Text, out sphere))
                            sphere = Convert.ToDecimal(txtPresSphereGauche.Text);
                        else
                            sphere = 0;
                    }
                    else
                    {
                        txtPresSphereGauche.Text = "";
                        sphere = 0;
                    }
                    if (txtPresCylindreGauche.Text != "")
                    {
                        if (decimal.TryParse(txtPresCylindreGauche.Text, out cylindre))
                        {
                            cylindre = Convert.ToDecimal(txtPresCylindreGauche.Text);
                            if (cylindre > 0)
                            {
                                MontureClass.GaucheCylindrePlus = true;
                                MontureClass.GaucheCylindreMoin = false;
                            }
                            else
                            {
                                if (cylindre < 0)
                                {
                                    MontureClass.GaucheCylindrePlus = false;
                                    MontureClass.GaucheCylindreMoin = true;
                                }
                            }
                        }
                        else
                        {
                            cylindre = 0;
                        }
                    }
                    else
                    {
                        txtPresCylindreGauche.Text = "";
                        cylindre = 0;
                    }

                    if (txtPresAxeGauche.Text != "")
                    {
                        if (int.TryParse(txtPresAxeGauche.Text, out axe))
                            axe = Convert.ToInt16(txtPresAxeGauche.Text);
                        else
                            axe = 0;
                    }
                    else
                    {
                        txtPresAxeGauche.Text = "";
                        axe = 0;
                    }
                    txtPresCylindreGauche.Text = ((-cylindre)).ToString("+#.##;-#.##;0");
                    txtPresSphereGauche.Text = (sphere + cylindre).ToString("+#.##;-#.##;0");
                    if (MontureClass.GaucheCylindrePlus == true && MontureClass.GaucheCylindreMoin == false)
                    {
                        txtPresAxeGauche.Text = (axe + 90).ToString();
                        MontureClass.GaucheCylindrePlus = false;
                        MontureClass.GaucheCylindreMoin = true;

                    }
                    else
                    {
                        if (MontureClass.GaucheCylindrePlus == false && MontureClass.GaucheCylindreMoin == true)
                        {
                            txtPresAxeGauche.Text = (axe - 90).ToString();
                            MontureClass.GaucheCylindrePlus = true;
                            MontureClass.GaucheCylindreMoin = false;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
        System.Int64 DoWork(string _numbers)
        {
            Random random = new Random();
            StringBuilder builder = new StringBuilder(13);
            string numberAsString = "";
            System.Int64 numberAsNumber = 0;

            for (var i = 0; i < 13; i++)
            {
                builder.Append(_numbers[random.Next(0, _numbers.Length)]);
            }

            numberAsString = builder.ToString();
            numberAsNumber = System.Int64.Parse(numberAsString);
            return numberAsNumber;
        }
        /*  private void ValiderMonture_Click(object sender, RoutedEventArgs e)
          {
              try
              {

                  if (nouvellemonture == true && anciennemonture == false && memberuser.CreationDossierClient == true)
                  {
                      //                    string _numbers = MontureClass.IdClient.ToString() + MontureClass.MontantTotal.ToString() + DateTime.Now.Day.ToString()+MontureClass.DroitPrixVerreLoin.ToString()+MontureClass.DroitPrixVerrePres.ToString();

                      int interfacecreationmonture = 0;
                      bool creationmonture, creationcaisse, creationdepaiement = false;
                      MontureClass.StatutDevis = true;
                      MontureClass.StatutVente = false;
                      string _numbers = Convert.ToString(MontureClass.IdClient) + Convert.ToString(DateTime.Now.Year) + Convert.ToString(DateTime.Now.Month) + Convert.ToString(DateTime.Now.Day) + Convert.ToString(DateTime.Now.Hour) + Convert.ToString(DateTime.Now.Minute) + Convert.ToString(DateTime.Now.Second) + Convert.ToString(DateTime.Now.Millisecond);

                      MessageBoxResult resul0333 = Xceed.Wpf.Toolkit.MessageBox.Show(Convert.ToString(DoWork(_numbers)), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                      MontureClass.NCommande = Convert.ToString(DoWork(_numbers));

                      SVC.Depense CAISSEMONTURE;
                      SVC.Depeiment PAIEMENTMONTURE;
                      if (txtMontantTotalENC.Text != "")
                      {
                          if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                          {
                              MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                              MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                          }
                          else
                          {
                              MontureClass.Encaissé = 0;
                              MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                          }
                      }
                      else
                      {
                          MontureClass.Encaissé = 0;
                          MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                      }
                      MontureClass.Cle = Clientvv.Id + Clientvv.Raison + MontureClass.MontantTotal + DateTime.Now.TimeOfDay;
                      if (txtAccessoiresQuantite1.Text != "")
                      {
                          if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                          {
                              MontureClass.Accessoires1 = "";
                              MontureClass.AccessoiresPrix1 = null;
                              txtAccessoires1.Text = "";
                              txtAccessoiresPrix1.Text = "0";
                          }
                      }
                      if (txtAccessoiresQuantite2.Text != "")
                      {
                          if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                          {
                              MontureClass.Accessoires2 = "";
                              MontureClass.AccessoiresPrix2 = null;
                              txtAccessoires2.Text = "";
                              txtAccessoiresPrix2.Text = "0";
                          }
                      }
                      if (MontureClass.Encaissé != 0)
                      {


                          PAIEMENTMONTURE = new SVC.Depeiment
                          {
                              date = MontureClass.Date,
                              montant = Convert.ToDecimal(MontureClass.Encaissé),
                              paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                              oper = memberuser.Username,
                              dates = MontureClass.Dates,
                              banque = "Caisse",
                              nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                              amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                              cle = MontureClass.Cle,
                              cp = MontureClass.Id,
                              Multiple = false,
                              CodeClient = MontureClass.IdClient,
                              RaisonClient = MontureClass.RaisonClient,

                          };
                          CAISSEMONTURE = new SVC.Depense
                          {
                              cle = MontureClass.Cle,
                              Auto = true,
                              Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                              CompteDébité = "Caisse",
                              Crédit = true,
                              DateDebit = MontureClass.Date,
                              DateSaisie = MontureClass.Dates,
                              Débit = false,
                              ModePaiement = "ESPECES",
                              Montant = 0,
                              MontantCrédit = MontureClass.Encaissé,
                              NumCheque = Convert.ToString(MontureClass.Id),
                              Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                              RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                              Username = memberuser.Username,

                          };
                          interfacecreationmonture = 1;



                          using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                          {

                              proxy.InsertMonture(MontureClass);
                              creationmonture = true;


                              proxy.InsertDepense(CAISSEMONTURE);
                              creationcaisse = true;
                              proxy.InsertDepeiment(PAIEMENTMONTURE);
                              creationdepaiement = true;

                              if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                              {
                                  ts.Complete();
                              }
                          }
                          if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                          {
                              proxy.AjouterTransactionPaiementRefresh();
                              proxy.AjouterDepenseRefresh();
                              proxy.AjouterMontureRefresh(Clientvv.Id);
                              GridMonture.IsEnabled = false;
                              GridMonture.DataContext = null;
                              montureversementzero = false;
                              MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                          }
                      }
                      else
                      {
                          using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                          {


                              proxy.InsertMonture(MontureClass);
                              ts.Complete();
                              creationmonture = true;







                          }
                          if (creationmonture == true)
                          {
                              proxy.AjouterTransactionPaiementRefresh();
                              proxy.AjouterDepenseRefresh();
                              proxy.AjouterMontureRefresh(Clientvv.Id);
                              GridMonture.IsEnabled = false;
                              GridMonture.DataContext = null;
                              montureversementzero = false;
                              MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                          }
                      }


                  }
                  else
                  {
                      if (nouvellemonture == false && anciennemonture == true && memberuser.ModificationDossierClient == true)
                      {
                          int interfacecreationmonture = 0;
                          bool creationmonture, creationcaisse, creationdepaiement = false;

                          // MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotalENC.Text);
                          SVC.Depense CAISSEMONTURE;
                          SVC.Depeiment PAIEMENTMONTURE;


                          if (txtMontantTotalENC.Text != "")
                          {
                              if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                              {
                                  MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                                  MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;

                              }
                              else
                              {
                                  MontureClass.Encaissé = 0;
                                  MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;

                              }

                          }
                          else
                          {
                              MontureClass.Encaissé = 0;
                              MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;

                          }
                          if (txtAccessoiresQuantite1.Text != "")
                          {
                              if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                              {

                                  MontureClass.Accessoires1 = "";
                                  MontureClass.AccessoiresPrix1 = null;
                                  txtAccessoires1.Text = "";
                                  txtAccessoiresPrix1.Text = "0";

                              }
                          }
                          if (txtAccessoiresQuantite2.Text != "")
                          {
                              if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                              {
                                  MontureClass.Accessoires2 = "";
                                  MontureClass.AccessoiresPrix2 = null;
                                  txtAccessoires2.Text = "";
                                  txtAccessoiresPrix2.Text = "0";
                              }
                          }
                          if (montureversementzero == false)
                          {
                              if (MontureClass.Encaissé != 0)
                              {


                                  PAIEMENTMONTURE = new SVC.Depeiment
                                  {
                                      date = MontureClass.Date,
                                      montant = Convert.ToDecimal(MontureClass.Encaissé),
                                      paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                                      oper = memberuser.Username,
                                      dates = MontureClass.Dates,
                                      banque = "Caisse",
                                      nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                                      amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                                      cle = MontureClass.Cle,
                                      cp = MontureClass.Id,
                                      Multiple = false,
                                      CodeClient = MontureClass.IdClient,
                                      RaisonClient = MontureClass.RaisonClient,

                                  };
                                  CAISSEMONTURE = new SVC.Depense
                                  {
                                      cle = MontureClass.Cle,
                                      Auto = true,
                                      Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                      CompteDébité = "Caisse",
                                      Crédit = true,
                                      DateDebit = MontureClass.Date,
                                      DateSaisie = MontureClass.Dates,
                                      Débit = false,
                                      ModePaiement = "ESPECES",
                                      Montant = 0,
                                      MontantCrédit = MontureClass.Encaissé,
                                      NumCheque = Convert.ToString(MontureClass.Id),
                                      Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                                      RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                      Username = memberuser.Username,

                                  };
                                  interfacecreationmonture = 1;
                                  using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                  {

                                      proxy.UpdateMonture(MontureClass);
                                      creationmonture = true;


                                      proxy.InsertDepense(CAISSEMONTURE);
                                      creationcaisse = true;
                                      proxy.InsertDepeiment(PAIEMENTMONTURE);
                                      creationdepaiement = true;

                                      if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                      {
                                          ts.Complete();
                                      }
                                  }
                                  if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                  {
                                      proxy.AjouterTransactionPaiementRefresh();
                                      proxy.AjouterDepenseRefresh();
                                      proxy.AjouterMontureRefresh(Clientvv.Id);
                                      GridMonture.IsEnabled = false;
                                      GridMonture.DataContext = null;
                                      montureversementzero = false;

                                      MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                  }
                              }
                              else
                              {
                                  using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                  {


                                      proxy.UpdateMonture(MontureClass);
                                      ts.Complete();
                                      creationmonture = true;







                                  }
                                  if (creationmonture == true)
                                  {
                                      proxy.AjouterTransactionPaiementRefresh();
                                      proxy.AjouterDepenseRefresh();
                                      proxy.AjouterMontureRefresh(Clientvv.Id);
                                      GridMonture.IsEnabled = false;
                                      GridMonture.DataContext = null;
                                      montureversementzero = false;

                                      MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                  }
                              }
                          }
                          else
                          {
                              if (montureversementzero == true)
                              {
                                  if (MontureClass.Encaissé == 0)
                                  {
                                      CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                      PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                      using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                      {

                                          proxy.UpdateMonture(MontureClass);
                                          creationmonture = true;


                                          proxy.DeleteDepense(CAISSEMONTURE);
                                          creationcaisse = true;
                                          proxy.DeleteDepeiment(PAIEMENTMONTURE);
                                          creationdepaiement = true;

                                          if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                          {
                                              ts.Complete();
                                          }
                                      }
                                      if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                      {
                                          proxy.AjouterTransactionPaiementRefresh();
                                          proxy.AjouterDepenseRefresh();
                                          proxy.AjouterMontureRefresh(Clientvv.Id);
                                          GridMonture.IsEnabled = false;
                                          GridMonture.DataContext = null;
                                          montureversementzero = false;
                                          MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                      }
                                  }
                                  else
                                  {
                                      if (MontureClass.Encaissé != 0)
                                      {
                                          CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                          CAISSEMONTURE.MontantCrédit = MontureClass.Encaissé;
                                          PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                          PAIEMENTMONTURE.montant = Convert.ToDecimal(MontureClass.Encaissé);
                                          using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                          {

                                              proxy.UpdateMonture(MontureClass);
                                              creationmonture = true;


                                              proxy.UpdateDepense(CAISSEMONTURE);
                                              creationcaisse = true;
                                              proxy.UpdateDepeiment(PAIEMENTMONTURE);
                                              creationdepaiement = true;

                                              if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                              {
                                                  ts.Complete();
                                              }
                                          }
                                          if (creationcaisse == true && creationmonture == true && creationdepaiement == true)
                                          {
                                              proxy.AjouterTransactionPaiementRefresh();
                                              proxy.AjouterDepenseRefresh();
                                              proxy.AjouterMontureRefresh(Clientvv.Id);
                                              GridMonture.IsEnabled = false;
                                              GridMonture.DataContext = null;
                                              montureversementzero = false;
                                              MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                          }
                                      }
                                  }
                              }
                          }
                      }
                  }


              }
              catch (Exception ex)
              {
                  MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
              }
          }*/

        /*  private void ValiderMonture_Click(object sender, RoutedEventArgs e)
          {
              try
              {
                  /****************création monture**************************/
        /*   if (nouvellemonture == true && anciennemonture == false && memberuser.CreationDossierClient == true)
           {
               //                    string _numbers = MontureClass.IdClient.ToString() + MontureClass.MontantTotal.ToString() + DateTime.Now.Day.ToString()+MontureClass.DroitPrixVerreLoin.ToString()+MontureClass.DroitPrixVerrePres.ToString();

               int interfacecreationmonture = 0;
               bool creationmonture, creationcaisse, creationdepaiement = false;
               bool creationsuppmonture1 = false;
               bool creationsuppmonture2 = false;
               bool creationsuppmonture3 = false;
               bool creationsuppmonture4 = false;
               MontureClass.StatutDevis = true;
               MontureClass.StatutVente = false;
               string _numbers = Convert.ToString(MontureClass.IdClient) + Convert.ToString(MontureClass.MontantTotal)+ Convert.ToString(DateTime.Now.Year) + Convert.ToString(DateTime.Now.Month) + Convert.ToString(DateTime.Now.Day) + Convert.ToString(DateTime.Now.Hour) + Convert.ToString(DateTime.Now.Minute) + Convert.ToString(DateTime.Now.Second) + Convert.ToString(DateTime.Now.Millisecond);

               //    MessageBoxResult resul0333 = Xceed.Wpf.Toolkit.MessageBox.Show(Convert.ToString(DoWork(_numbers)), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
               MontureClass.NCommande = Convert.ToString(DoWork(_numbers));

               SVC.Depense CAISSEMONTURE;
               SVC.Depeiment PAIEMENTMONTURE;
               if (txtMontantTotalENC.Text != "")
               {
                   if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                   {
                       MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                       MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                   }
                   else
                   {
                       MontureClass.Encaissé = 0;
                       MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                   }
               }
               else
               {
                   MontureClass.Encaissé = 0;
                   MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
               }
               MontureClass.Cle = Clientvv.Id + Clientvv.Raison + MontureClass.MontantTotal + DateTime.Now.TimeOfDay;
               if (txtAccessoiresQuantite1.Text != "")
               {
                   if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                   {
                       MontureClass.Accessoires1 = "";
                       MontureClass.AccessoiresPrix1 = null;
                       txtAccessoires1.Text = "";
                       txtAccessoiresPrix1.Text = "0";
                   }
               }
               if (txtAccessoiresQuantite2.Text != "")
               {
                   if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                   {
                       MontureClass.Accessoires2 = "";
                       MontureClass.AccessoiresPrix2 = null;
                       txtAccessoires2.Text = "";
                       txtAccessoiresPrix2.Text = "0";
                   }
               }
               if (MontureClass.Encaissé != 0)
               {

                   PAIEMENTMONTURE = new SVC.Depeiment
                   {
                       date = MontureClass.Date,
                       montant = Convert.ToDecimal(MontureClass.Encaissé),
                       paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                       oper = memberuser.Username,
                       dates = MontureClass.Dates,
                       banque = "Caisse",
                       nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                       amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                       cle = MontureClass.Cle,
                       cp = MontureClass.Id,
                       Multiple = false,
                       CodeClient = MontureClass.IdClient,
                       RaisonClient = MontureClass.RaisonClient,

                   };
                   CAISSEMONTURE = new SVC.Depense
                   {
                       cle = MontureClass.Cle,
                       Auto = true,
                       Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                       CompteDébité = "Caisse",
                       Crédit = true,
                       DateDebit = MontureClass.Date,
                       DateSaisie = MontureClass.Dates,
                       Débit = false,
                       ModePaiement = "ESPECES",
                       Montant = 0,
                       MontantCrédit = MontureClass.Encaissé,
                       NumCheque = Convert.ToString(MontureClass.Id),
                       Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                       RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                       Username = memberuser.Username,

                   };
                   interfacecreationmonture = 1;



                   using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                   {
                       /**********sup1********//////
                                               /*        if (listsupp1 != null)
                                                       {
                                                           if (listsupp1.Count > 0)
                                                           {
                                                               foreach (var itemsupp in listsupp1)
                                                               {
                                                                   creationsuppmonture1 = false;
                                                                   itemsupp.cle = MontureClass.Cle;
                                                                   itemsupp.interfaceMonture = 1;
                                                                   proxy.InsertMontureSupplement(itemsupp);
                                                                   creationsuppmonture1 = true;
                                                               }
                                                           }
                                                           else
                                                           {
                                                               creationsuppmonture1 = true;
                                                           }
                                                       }
                                                       else
                                                       {
                                                           creationsuppmonture1 = true;
                                                       }
                                                       /*************sup2*//////
                                                                           /*   if (listsupp2 != null)
                                                                              {
                                                                                  if (listsupp2.Count > 0)
                                                                                  {
                                                                                      foreach (var itemsupp in listsupp2)
                                                                                      {
                                                                                          creationsuppmonture1 = false;
                                                                                          itemsupp.cle = MontureClass.Cle;
                                                                                          itemsupp.interfaceMonture = 2;
                                                                                          proxy.InsertMontureSupplement(itemsupp);
                                                                                          creationsuppmonture1 = true;
                                                                                      }
                                                                                  }
                                                                                  else
                                                                                  {
                                                                                      creationsuppmonture2 = true;
                                                                                  }
                                                                              }
                                                                              else
                                                                              {
                                                                                  creationsuppmonture2 = true;
                                                                              }
                                                                              /***********supp3***************/
                                                                           /*   if (listsupp3 != null)
                                                                              {
                                                                                  if (listsupp3.Count > 0)
                                                                                  {
                                                                                      foreach (var itemsupp in listsupp3)
                                                                                      {
                                                                                          creationsuppmonture3 = false;
                                                                                          itemsupp.cle = MontureClass.Cle;
                                                                                          itemsupp.interfaceMonture = 3;
                                                                                          proxy.InsertMontureSupplement(itemsupp);
                                                                                          creationsuppmonture3 = true;
                                                                                      }
                                                                                  }
                                                                                  else
                                                                                  {
                                                                                      creationsuppmonture3 = true;
                                                                                  }
                                                                              }
                                                                              else
                                                                              {
                                                                                  creationsuppmonture3 = true;
                                                                              }
                                                                              /*******************sup4************/
                                                                           /*   if (listsupp4 != null)
                                                                              {
                                                                                  if (listsupp4.Count > 0)
                                                                                  {
                                                                                      foreach (var itemsupp in listsupp4)
                                                                                      {
                                                                                          creationsuppmonture4 = false;
                                                                                          itemsupp.cle = MontureClass.Cle;
                                                                                          itemsupp.interfaceMonture = 4;
                                                                                          proxy.InsertMontureSupplement(itemsupp);
                                                                                          creationsuppmonture4 = true;
                                                                                      }
                                                                                  }
                                                                                  else
                                                                                  {
                                                                                      creationsuppmonture4 = true;
                                                                                  }
                                                                              }
                                                                              else
                                                                              {
                                                                                  creationsuppmonture4 = true;
                                                                              }
                                                                              /***********************************/
                                                                           /*  proxy.InsertMonture(MontureClass);
                                                                             creationmonture = true;


                                                                             proxy.InsertDepense(CAISSEMONTURE);
                                                                             creationcaisse = true;
                                                                             proxy.InsertDepeiment(PAIEMENTMONTURE);
                                                                             creationdepaiement = true;

                                                                             if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                             {
                                                                                 ts.Complete();
                                                                             }
                                                                         }
                                                                         if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                         {
                                                                             proxy.AjouterTransactionPaiementRefresh();
                                                                             proxy.AjouterDepenseRefresh();
                                                                             proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                             proxy.AjouterMontureSupplementRefresh(MontureClass.Cle);
                                                                             GridMonture.IsEnabled = false;
                                                                             GridMonture.DataContext = null;
                                                                             montureversementzero = false;
                                                                             MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                                                         }
                                                                     }
                                                                     else
                                                                     {
                                                                         // MessageBoxResult resul03s = Xceed.Wpf.Toolkit.MessageBox.Show("Im here", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                                                         using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                                                         {

                                                                             /**********sup1********//////
                                                                                                     /*  if (listsupp1 != null)
                                                                                                       {
                                                                                                           if (listsupp1.Count > 0)
                                                                                                           {
                                                                                                               foreach (var itemsupp in listsupp1)
                                                                                                               {
                                                                                                                   creationsuppmonture1 = false;
                                                                                                                   itemsupp.cle = MontureClass.Cle;
                                                                                                                   itemsupp.interfaceMonture = 1;
                                                                                                                   proxy.InsertMontureSupplement(itemsupp);
                                                                                                                   creationsuppmonture1 = true;
                                                                                                               }
                                                                                                           }
                                                                                                           else
                                                                                                           {
                                                                                                               creationsuppmonture1 = true;
                                                                                                           }
                                                                                                       }
                                                                                                       else
                                                                                                       {
                                                                                                           creationsuppmonture1 = true;
                                                                                                       }
                                                                                                       /*************sup2*//////
                                                                                                                           /*    if (listsupp2 != null)
                                                                                                                               {
                                                                                                                                   if (listsupp2.Count > 0)
                                                                                                                                   {
                                                                                                                                       foreach (var itemsupp in listsupp2)
                                                                                                                                       {
                                                                                                                                           creationsuppmonture1 = false;
                                                                                                                                           itemsupp.cle = MontureClass.Cle;
                                                                                                                                           itemsupp.interfaceMonture = 2;
                                                                                                                                           proxy.InsertMontureSupplement(itemsupp);
                                                                                                                                           creationsuppmonture1 = true;
                                                                                                                                       }
                                                                                                                                   }
                                                                                                                                   else
                                                                                                                                   {
                                                                                                                                       creationsuppmonture2 = true;
                                                                                                                                   }
                                                                                                                               }
                                                                                                                               else
                                                                                                                               {
                                                                                                                                   creationsuppmonture2 = true;
                                                                                                                               }
                                                                                                                               /***********supp3***************/
                                                                                                                           /*  if (listsupp3 != null)
                                                                                                                             {
                                                                                                                                 if (listsupp3.Count > 0)
                                                                                                                                 {
                                                                                                                                     foreach (var itemsupp in listsupp3)
                                                                                                                                     {
                                                                                                                                         creationsuppmonture3 = false;
                                                                                                                                         itemsupp.cle = MontureClass.Cle;
                                                                                                                                         itemsupp.interfaceMonture = 3;
                                                                                                                                         proxy.InsertMontureSupplement(itemsupp);
                                                                                                                                         creationsuppmonture3 = true;
                                                                                                                                     }
                                                                                                                                 }
                                                                                                                                 else
                                                                                                                                 {
                                                                                                                                     creationsuppmonture3 = true;
                                                                                                                                 }
                                                                                                                             }
                                                                                                                             else
                                                                                                                             {
                                                                                                                                 creationsuppmonture3 = true;
                                                                                                                             }
                                                                                                                             /*******************sup4************/
                                                                                                                           /*    if (listsupp4 != null)
                                                                                                                               {
                                                                                                                                   if (listsupp4.Count > 0)
                                                                                                                                   {
                                                                                                                                       foreach (var itemsupp in listsupp4)
                                                                                                                                       {
                                                                                                                                           creationsuppmonture4 = false;
                                                                                                                                           itemsupp.cle = MontureClass.Cle;
                                                                                                                                           itemsupp.interfaceMonture = 4;
                                                                                                                                           proxy.InsertMontureSupplement(itemsupp);
                                                                                                                                           creationsuppmonture4 = true;
                                                                                                                                       }
                                                                                                                                   }
                                                                                                                                   else
                                                                                                                                   {
                                                                                                                                       creationsuppmonture4 = true;
                                                                                                                                   }
                                                                                                                               }
                                                                                                                               else
                                                                                                                               {
                                                                                                                                   creationsuppmonture4 = true;
                                                                                                                               }
                                                                                                                               proxy.InsertMonture(MontureClass);
                                                                                                                               creationmonture = true;

                                                                                                                               if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                               {
                                                                                                                                   ts.Complete();
                                                                                                                               }

                                                                                                                           }
                                                                                                                           if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                           {
                                                                                                                               proxy.AjouterTransactionPaiementRefresh();
                                                                                                                               proxy.AjouterDepenseRefresh();
                                                                                                                               proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                                                                               proxy.AjouterMontureSupplementRefresh(MontureClass.Cle);
                                                                                                                               GridMonture.IsEnabled = false;
                                                                                                                               GridMonture.DataContext = null;
                                                                                                                               montureversementzero = false;
                                                                                                                               MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                                                                                                           }
                                                                                                                       }


                                                                                                                   }
                                                                                                                   /***************************modification monture*****************/
                                                                                                                           /* else
                                                                                                                            {
                                                                                                                                if (nouvellemonture == false && anciennemonture == true && memberuser.ModificationDossierClient == true)
                                                                                                                                {
                                                                                                                                    int interfacecreationmonture = 0;
                                                                                                                                    bool creationmonture, creationcaisse, creationdepaiement = false;
                                                                                                                                    bool creationsuppmonture1 = false;
                                                                                                                                    bool creationsuppmonture2 = false;
                                                                                                                                    bool creationsuppmonture3 = false;
                                                                                                                                    bool creationsuppmonture4 = false;
                                                                                                                                    // MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotalENC.Text);
                                                                                                                                    SVC.Depense CAISSEMONTURE;
                                                                                                                                    SVC.Depeiment PAIEMENTMONTURE;


                                                                                                                                    if (txtMontantTotalENC.Text != "")
                                                                                                                                    {
                                                                                                                                        if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                                                                                                                                        {
                                                                                                                                            MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                                                                                                                                            MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        {
                                                                                                                                            MontureClass.Encaissé = 0;
                                                                                                                                            MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                                                                                                                                        }

                                                                                                                                    }
                                                                                                                                    else
                                                                                                                                    {
                                                                                                                                        MontureClass.Encaissé = 0;
                                                                                                                                        MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                                                                                                                                    }
                                                                                                                                    if (txtAccessoiresQuantite1.Text != "")
                                                                                                                                    {
                                                                                                                                        if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                                                                                                                                        {
                                                                                                                                            MontureClass.Accessoires1 = "";
                                                                                                                                            MontureClass.AccessoiresPrix1 = null;
                                                                                                                                            txtAccessoires1.Text = "";
                                                                                                                                            txtAccessoiresPrix1.Text = "0";
                                                                                                                                        }
                                                                                                                                    }
                                                                                                                                    if (txtAccessoiresQuantite2.Text != "")
                                                                                                                                    {
                                                                                                                                        if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                                                                                                                                        {
                                                                                                                                            MontureClass.Accessoires2 = "";
                                                                                                                                            MontureClass.AccessoiresPrix2 = null;
                                                                                                                                            txtAccessoires2.Text = "";
                                                                                                                                            txtAccessoiresPrix2.Text = "0";
                                                                                                                                        }
                                                                                                                                    }
                                                                                                                                    ///MontureCLass ==0 lors du chargement
                                                                                                                                    if (montureversementzero == false)
                                                                                                                                    {
                                                                                                                                        //nouveau encaissement alors insertion
                                                                                                                                        if (MontureClass.Encaissé != 0)
                                                                                                                                        {
                                                                                                                                            PAIEMENTMONTURE = new SVC.Depeiment
                                                                                                                                            {
                                                                                                                                                date = MontureClass.Date,
                                                                                                                                                montant = Convert.ToDecimal(MontureClass.Encaissé),
                                                                                                                                                paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                                                                                                                                                oper = memberuser.Username,
                                                                                                                                                dates = MontureClass.Dates,
                                                                                                                                                banque = "Caisse",
                                                                                                                                                nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                                                                                                                                                amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                                                                                                                                                cle = MontureClass.Cle,
                                                                                                                                                cp = MontureClass.Id,
                                                                                                                                                Multiple = false,
                                                                                                                                                CodeClient = MontureClass.IdClient,
                                                                                                                                                RaisonClient = MontureClass.RaisonClient,

                                                                                                                                            };
                                                                                                                                            CAISSEMONTURE = new SVC.Depense
                                                                                                                                            {
                                                                                                                                                cle = MontureClass.Cle,
                                                                                                                                                Auto = true,
                                                                                                                                                Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                                                                                                                                CompteDébité = "Caisse",
                                                                                                                                                Crédit = true,
                                                                                                                                                DateDebit = MontureClass.Date,
                                                                                                                                                DateSaisie = MontureClass.Dates,
                                                                                                                                                Débit = false,
                                                                                                                                                ModePaiement = "ESPECES",
                                                                                                                                                Montant = 0,
                                                                                                                                                MontantCrédit = MontureClass.Encaissé,
                                                                                                                                                NumCheque = Convert.ToString(MontureClass.Id),
                                                                                                                                                Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                                                                                                                                                RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                                                                                                                                Username = memberuser.Username,

                                                                                                                                            };
                                                                                                                                            interfacecreationmonture = 1;
                                                                                                                                            using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                                                                                                                            {
                                                                                                                                                #region monturesupp
                                                                                                                                                if (listsupp1 != null)
                                                                                                                                                {
                                                                                                                                                    if (listsupp1.Count() > 0)
                                                                                                                                                    {
                                                                                                                                                        foreach (var item in listsupp1)
                                                                                                                                                        {
                                                                                                                                                            var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                                                                                                                            if (existe == false)
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture1 = false;
                                                                                                                                                                item.cle = MontureClass.Cle;
                                                                                                                                                                item.interfaceMonture = 1;
                                                                                                                                                                proxy.InsertMontureSupplement(item);
                                                                                                                                                                creationsuppmonture1 = true;
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture1 = false;
                                                                                                                                                                //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                                proxy.UpdateMontureSupplement(item);
                                                                                                                                                                creationsuppmonture1 = true;
                                                                                                                                                            }
                                                                                                                                                        }
                                                                                                                                                    }
                                                                                                                                                    else
                                                                                                                                                    {
                                                                                                                                                        creationsuppmonture1 = true;
                                                                                                                                                    }
                                                                                                                                                }

                                                                                                                                                if (listsupp2 != null)
                                                                                                                                                {
                                                                                                                                                    if (listsupp2.Count() > 0)
                                                                                                                                                    {
                                                                                                                                                        foreach (var item in listsupp2)
                                                                                                                                                        {
                                                                                                                                                            var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                                                                                                                            if (existe == false)
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture2 = false;
                                                                                                                                                                item.cle = MontureClass.Cle;
                                                                                                                                                                item.interfaceMonture = 2;
                                                                                                                                                                proxy.InsertMontureSupplement(item);
                                                                                                                                                                creationsuppmonture2 = true;
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture2 = false;
                                                                                                                                                                //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                                proxy.UpdateMontureSupplement(item);
                                                                                                                                                                creationsuppmonture2 = true;
                                                                                                                                                            }
                                                                                                                                                        }
                                                                                                                                                    }
                                                                                                                                                    else
                                                                                                                                                    {
                                                                                                                                                        creationsuppmonture2 = true;
                                                                                                                                                    }
                                                                                                                                                }
                                                                                                                                                if (listsupp3 != null)
                                                                                                                                                {
                                                                                                                                                    if (listsupp3.Count() > 0)
                                                                                                                                                    {
                                                                                                                                                        foreach (var item in listsupp3)
                                                                                                                                                        {
                                                                                                                                                            var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                                                                                                                            if (existe == false)
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture3 = false;
                                                                                                                                                                item.cle = MontureClass.Cle;
                                                                                                                                                                item.interfaceMonture = 3;
                                                                                                                                                                proxy.InsertMontureSupplement(item);
                                                                                                                                                                creationsuppmonture3 = true;
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture3 = false;
                                                                                                                                                                //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                                proxy.UpdateMontureSupplement(item);
                                                                                                                                                                creationsuppmonture3 = true;
                                                                                                                                                            }
                                                                                                                                                        }
                                                                                                                                                    }
                                                                                                                                                    else
                                                                                                                                                    {
                                                                                                                                                        creationsuppmonture3 = true;
                                                                                                                                                    }
                                                                                                                                                }
                                                                                                                                                if (listsupp4 != null)
                                                                                                                                                {
                                                                                                                                                    if (listsupp4.Count() > 0)
                                                                                                                                                    {
                                                                                                                                                        foreach (var item in listsupp4)
                                                                                                                                                        {
                                                                                                                                                            var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                                                                                                                            if (existe == false)
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture4 = false;
                                                                                                                                                                item.cle = MontureClass.Cle;
                                                                                                                                                                item.interfaceMonture = 4;
                                                                                                                                                                proxy.InsertMontureSupplement(item);
                                                                                                                                                                creationsuppmonture4 = true;
                                                                                                                                                            }
                                                                                                                                                            else
                                                                                                                                                            {
                                                                                                                                                                creationsuppmonture4 = false;
                                                                                                                                                                //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                                proxy.UpdateMontureSupplement(item);
                                                                                                                                                                creationsuppmonture4 = true;
                                                                                                                                                            }
                                                                                                                                                        }
                                                                                                                                                    }
                                                                                                                                                    else
                                                                                                                                                    {
                                                                                                                                                        creationsuppmonture4 = true;
                                                                                                                                                    }
                                                                                                                                                }
                                                                                                                                                #endregion
                                                                                                                                                proxy.UpdateMonture(MontureClass);
                                                                                                                                                creationmonture = true;


                                                                                                                                                proxy.InsertDepense(CAISSEMONTURE);
                                                                                                                                                creationcaisse = true;
                                                                                                                                                proxy.InsertDepeiment(PAIEMENTMONTURE);
                                                                                                                                                creationdepaiement = true;

                                                                                                                                                if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                                {
                                                                                                                                                    ts.Complete();
                                                                                                                                                }
                                                                                                                                            }
                                                                                                                                            if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                            {
                                                                                                                                                proxy.AjouterTransactionPaiementRefresh();
                                                                                                                                                proxy.AjouterDepenseRefresh();
                                                                                                                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                                                                                                GridMonture.IsEnabled = false;
                                                                                                                                                GridMonture.DataContext = null;
                                                                                                                                                montureversementzero = false;

                                                                                                                                                MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                                                                                                                            }
                                                                                                                                        }
                                                                                                                                        else
                                                                                                                                        { /* MontureClass */
                                                                                                                           /*   if (MontureClass.Encaissé == 0)
                                                                                                                              {
                                                                                                                                  using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                                                                                                                  {
                                                                                                                                      #region monturesupp

                                                                                                                                      if (listsupp1 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp1.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp1)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture1 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 1;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture1 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture1 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture1 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture1 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      else
                                                                                                                                      {
                                                                                                                                          creationsuppmonture1 = true;

                                                                                                                                      }

                                                                                                                                      if (listsupp2 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp2.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp2)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture2 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 2;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture2 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture2 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture2 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture2 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      else
                                                                                                                                      {
                                                                                                                                          creationsuppmonture2 = true;

                                                                                                                                      }
                                                                                                                                      if (listsupp3 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp3.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp3)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp3.Any(n => n.Id == item.Id);

                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture3 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 3;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture3 = true;

                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture3 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture3 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture3 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      else
                                                                                                                                      {
                                                                                                                                          creationsuppmonture3 = true;

                                                                                                                                      }
                                                                                                                                      if (listsupp4 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp4.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp4)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture4 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 4;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture4 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture4 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture4 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture4 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      else
                                                                                                                                      {
                                                                                                                                          creationsuppmonture4 = true;

                                                                                                                                      }
                                                                                                                                      #endregion

                                                                                                                                      proxy.UpdateMonture(MontureClass);
                                                                                                                                      creationmonture = true;
                                                                                                                                      if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                      {
                                                                                                                                          ts.Complete();
                                                                                                                                      }
                                                                                                                                  }
                                                                                                                                  if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                  {
                                                                                                                                      proxy.AjouterTransactionPaiementRefresh();
                                                                                                                                      proxy.AjouterDepenseRefresh();
                                                                                                                                      proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                                                                                      GridMonture.IsEnabled = false;
                                                                                                                                      GridMonture.DataContext = null;
                                                                                                                                      montureversementzero = false;
                                                                                                                                      MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                                                                                                                  }
                                                                                                                              }

                                                                                                                          }
                                                                                                                      }
                                                                                                                      else
                                                                                                                      {
                                                                                                                          if (montureversementzero == true)
                                                                                                                          {
                                                                                                                              //lors du chargement montureclass!=0 apres montureclass==0 
                                                                                                                              //suppression des ecritures dans depense et depaiement
                                                                                                                              if (MontureClass.Encaissé == 0)
                                                                                                                              {
                                                                                                                                  CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                                                                                                                  PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                                                                                                                  using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                                                                                                                  {

                                                                                                                                      proxy.UpdateMonture(MontureClass);
                                                                                                                                      creationmonture = true;
                                                                                                                                      proxy.DeleteDepense(CAISSEMONTURE);
                                                                                                                                      creationcaisse = true;
                                                                                                                                      proxy.DeleteDepeiment(PAIEMENTMONTURE);
                                                                                                                                      creationdepaiement = true;
                                                                                                                                      #region monturesupplement
                                                                                                                                      if (listsupp1 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp1.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp1)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture1 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 1;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture1 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture1 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture1 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture1 = true;
                                                                                                                                          }
                                                                                                                                      }

                                                                                                                                      if (listsupp2 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp2.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp2)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture2 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 2;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture2 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture2 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture2 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture2 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      if (listsupp3 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp3.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp3)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture3 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 3;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture3 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture3 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture3 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture3 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      if (listsupp4 != null)
                                                                                                                                      {
                                                                                                                                          if (listsupp4.Count() > 0)
                                                                                                                                          {
                                                                                                                                              foreach (var item in listsupp4)
                                                                                                                                              {
                                                                                                                                                  var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                                                                                                                  if (existe == false)
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture4 = false;
                                                                                                                                                      item.cle = MontureClass.Cle;
                                                                                                                                                      item.interfaceMonture = 4;
                                                                                                                                                      proxy.InsertMontureSupplement(item);
                                                                                                                                                      creationsuppmonture4 = true;
                                                                                                                                                  }
                                                                                                                                                  else
                                                                                                                                                  {
                                                                                                                                                      creationsuppmonture4 = false;
                                                                                                                                                      //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                      proxy.UpdateMontureSupplement(item);
                                                                                                                                                      creationsuppmonture4 = true;
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          else
                                                                                                                                          {
                                                                                                                                              creationsuppmonture4 = true;
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      #endregion
                                                                                                                                      if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                      {
                                                                                                                                          ts.Complete();
                                                                                                                                      }
                                                                                                                                  }
                                                                                                                                  if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                  {
                                                                                                                                      proxy.AjouterTransactionPaiementRefresh();
                                                                                                                                      proxy.AjouterDepenseRefresh();
                                                                                                                                      proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                                                                                      GridMonture.IsEnabled = false;
                                                                                                                                      GridMonture.DataContext = null;
                                                                                                                                      montureversementzero = false;
                                                                                                                                      MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                                                                                                                  }
                                                                                                                              }
                                                                                                                              else
                                                                                                                              {
                                                                                                                                  //lors du chargement montureclass!=0 apres montureclass!==0 
                                                                                                                                  //alors mise à jours des écritures dans depense et depaiement
                                                                                                                                  if (MontureClass.Encaissé != 0)
                                                                                                                                  {
                                                                                                                                      CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                                                                                                                      CAISSEMONTURE.MontantCrédit = MontureClass.Encaissé;
                                                                                                                                      PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                                                                                                                      PAIEMENTMONTURE.montant = Convert.ToDecimal(MontureClass.Encaissé);
                                                                                                                                      using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                                                                                                                      {
                                                                                                                                          #region monturesupplement
                                                                                                                                          if (listsupp1 != null)
                                                                                                                                          {
                                                                                                                                              if (listsupp1.Count() > 0)
                                                                                                                                              {
                                                                                                                                                  foreach (var item in listsupp1)
                                                                                                                                                  {
                                                                                                                                                      var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                                                                                                                      if (existe == false)
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture1 = false;
                                                                                                                                                          item.cle = MontureClass.Cle;
                                                                                                                                                          item.interfaceMonture = 1;
                                                                                                                                                          proxy.InsertMontureSupplement(item);
                                                                                                                                                          creationsuppmonture1 = true;
                                                                                                                                                      }
                                                                                                                                                      else
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture1 = false;
                                                                                                                                                          //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                          proxy.UpdateMontureSupplement(item);
                                                                                                                                                          creationsuppmonture1 = true;
                                                                                                                                                      }
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                              else
                                                                                                                                              {
                                                                                                                                                  creationsuppmonture1 = true;
                                                                                                                                              }
                                                                                                                                          }

                                                                                                                                          if (listsupp2 != null)
                                                                                                                                          {
                                                                                                                                              if (listsupp2.Count() > 0)
                                                                                                                                              {
                                                                                                                                                  foreach (var item in listsupp2)
                                                                                                                                                  {
                                                                                                                                                      var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                                                                                                                      if (existe == false)
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture2 = false;
                                                                                                                                                          item.cle = MontureClass.Cle;
                                                                                                                                                          item.interfaceMonture = 2;
                                                                                                                                                          proxy.InsertMontureSupplement(item);
                                                                                                                                                          creationsuppmonture2 = true;
                                                                                                                                                      }
                                                                                                                                                      else
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture2 = false;
                                                                                                                                                          //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                          proxy.UpdateMontureSupplement(item);
                                                                                                                                                          creationsuppmonture2 = true;
                                                                                                                                                      }
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                              else
                                                                                                                                              {
                                                                                                                                                  creationsuppmonture2 = true;
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          if (listsupp3 != null)
                                                                                                                                          {
                                                                                                                                              if (listsupp3.Count() > 0)
                                                                                                                                              {
                                                                                                                                                  foreach (var item in listsupp3)
                                                                                                                                                  {
                                                                                                                                                      var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                                                                                                                      if (existe == false)
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture3 = false;
                                                                                                                                                          item.cle = MontureClass.Cle;
                                                                                                                                                          item.interfaceMonture = 3;
                                                                                                                                                          proxy.InsertMontureSupplement(item);
                                                                                                                                                          creationsuppmonture3 = true;
                                                                                                                                                      }
                                                                                                                                                      else
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture3 = false;
                                                                                                                                                          //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                          proxy.UpdateMontureSupplement(item);
                                                                                                                                                          creationsuppmonture3 = true;
                                                                                                                                                      }
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                              else
                                                                                                                                              {
                                                                                                                                                  creationsuppmonture3 = true;
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          if (listsupp4 != null)
                                                                                                                                          {
                                                                                                                                              if (listsupp4.Count() > 0)
                                                                                                                                              {
                                                                                                                                                  foreach (var item in listsupp4)
                                                                                                                                                  {
                                                                                                                                                      var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                                                                                                                      if (existe == false)
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture4 = false;
                                                                                                                                                          item.cle = MontureClass.Cle;
                                                                                                                                                          item.interfaceMonture = 4;
                                                                                                                                                          proxy.InsertMontureSupplement(item);
                                                                                                                                                          creationsuppmonture4 = true;
                                                                                                                                                      }
                                                                                                                                                      else
                                                                                                                                                      {
                                                                                                                                                          creationsuppmonture4 = false;
                                                                                                                                                          //item.CleSupplement = Supplement.VerresAssociés;
                                                                                                                                                          proxy.UpdateMontureSupplement(item);
                                                                                                                                                          creationsuppmonture4 = true;
                                                                                                                                                      }
                                                                                                                                                  }
                                                                                                                                              }
                                                                                                                                              else
                                                                                                                                              {
                                                                                                                                                  creationsuppmonture4 = true;
                                                                                                                                              }
                                                                                                                                          }
                                                                                                                                          #endregion
                                                                                                                                          proxy.UpdateMonture(MontureClass);
                                                                                                                                          creationmonture = true;


                                                                                                                                          proxy.UpdateDepense(CAISSEMONTURE);
                                                                                                                                          creationcaisse = true;
                                                                                                                                          proxy.UpdateDepeiment(PAIEMENTMONTURE);
                                                                                                                                          creationdepaiement = true;

                                                                                                                                          if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                          {
                                                                                                                                              ts.Complete();
                                                                                                                                          }
                                                                                                                                      }
                                                                                                                                      if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                                                                                                                      {
                                                                                                                                          proxy.AjouterTransactionPaiementRefresh();
                                                                                                                                          proxy.AjouterDepenseRefresh();
                                                                                                                                          proxy.AjouterMontureRefresh(Clientvv.Id);
                                                                                                                                          GridMonture.IsEnabled = false;
                                                                                                                                          GridMonture.DataContext = null;
                                                                                                                                          montureversementzero = false;
                                                                                                                                          MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                                                                                                                      }
                                                                                                                                  }
                                                                                                                              }
                                                                                                                          }
                                                                                                                      }




                                                                                                                  }
                                                                                                              }
                                                                                                          }
                                                                                                          catch (Exception ex)
                                                                                                          {
                                                                                                              MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
                                                                                                          }
                                                                                                      }
                                                                                                      */


        private void ValiderMonture_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false && memberuser.CreationDossierClient == true)
                {

                    int interfacecreationmonture = 0;
                    bool creationmonture, creationcaisse, creationdepaiement = false;
                    bool creationsuppmonture1 = false;
                    bool creationsuppmonture2 = false;
                    bool creationsuppmonture3 = false;
                    bool creationsuppmonture4 = false;
                    MontureClass.StatutDevis = true;
                    MontureClass.StatutVente = false;
                    string _numbers = Convert.ToString(MontureClass.IdClient) + Convert.ToString(MontureClass.MontantTotal) + Convert.ToString(DateTime.Now.Year) + Convert.ToString(DateTime.Now.Month) + Convert.ToString(DateTime.Now.Day) + Convert.ToString(DateTime.Now.Hour) + Convert.ToString(DateTime.Now.Minute) + Convert.ToString(DateTime.Now.Second) + Convert.ToString(DateTime.Now.Millisecond);

                    //    MessageBoxResult resul0333 = Xceed.Wpf.Toolkit.MessageBox.Show(Convert.ToString(DoWork(_numbers)), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                    MontureClass.NCommande = Convert.ToString(DoWork(_numbers).ToString());

                    SVC.Depense CAISSEMONTURE;
                    SVC.Depeiment PAIEMENTMONTURE;
                    if (txtMontantTotalENC.Text != "")
                    {
                        if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                        {
                            MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                            MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                        }
                        else
                        {
                            MontureClass.Encaissé = 0;
                            MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                        }
                    }
                    else
                    {
                        MontureClass.Encaissé = 0;
                        MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                    }
                    MontureClass.Cle = Clientvv.Id + Clientvv.Raison + MontureClass.MontantTotal + DateTime.Now.TimeOfDay;
                    if (txtAccessoiresQuantite1.Text != "")
                    {
                        if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                        {
                            MontureClass.Accessoires1 = "";
                            MontureClass.AccessoiresPrix1 = null;
                            txtAccessoires1.Text = "";
                            txtAccessoiresPrix1.Text = "0";
                        }
                    }
                    if (txtAccessoiresQuantite2.Text != "")
                    {
                        if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                        {
                            MontureClass.Accessoires2 = "";
                            MontureClass.AccessoiresPrix2 = null;
                            txtAccessoires2.Text = "";
                            txtAccessoiresPrix2.Text = "0";
                        }
                    }
                    if (MontureClass.Encaissé != 0)
                    {

                        PAIEMENTMONTURE = new SVC.Depeiment
                        {
                            date = MontureClass.Date,
                            montant = Convert.ToDecimal(MontureClass.Encaissé),
                            paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                            oper = memberuser.Username,
                            dates = MontureClass.Dates,
                            banque = "Caisse",
                            nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                            amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                            cle = MontureClass.Cle,
                            cp = MontureClass.Id,
                            Multiple = false,
                            CodeClient = MontureClass.IdClient,
                            RaisonClient = MontureClass.RaisonClient,

                        };
                        CAISSEMONTURE = new SVC.Depense
                        {
                            cle = MontureClass.Cle,
                            Auto = true,
                            Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                            CompteDébité = "Caisse",
                            Crédit = true,
                            DateDebit = MontureClass.Date,
                            DateSaisie = MontureClass.Dates,
                            Débit = false,
                            ModePaiement = "ESPECES",
                            Montant = 0,
                            MontantCrédit = MontureClass.Encaissé,
                            NumCheque = Convert.ToString(MontureClass.Id),
                            Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                            RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                            Username = memberuser.Username,

                        };
                        interfacecreationmonture = 1;



                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                        {
                            if (listsupp1 != null)
                            {
                                if (listsupp1.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp1)
                                    {
                                        creationsuppmonture1 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 1;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture1 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture1 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture1 = true;
                            }
                            if (listsupp2 != null)
                            {
                                if (listsupp2.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp2)
                                    {
                                        creationsuppmonture1 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 2;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture1 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture2 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture2 = true;
                            }
                            if (listsupp3 != null)
                            {
                                if (listsupp3.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp3)
                                    {
                                        creationsuppmonture3 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 3;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture3 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture3 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture3 = true;
                            }
                            if (listsupp4 != null)
                            {
                                if (listsupp4.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp4)
                                    {
                                        creationsuppmonture4 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 4;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture4 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture4 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture4 = true;
                            }
                            proxy.InsertMonture(MontureClass);
                            creationmonture = true;


                            proxy.InsertDepense(CAISSEMONTURE);
                            creationcaisse = true;
                            proxy.InsertDepeiment(PAIEMENTMONTURE);
                            creationdepaiement = true;

                            if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                            {
                                ts.Complete();
                            }
                        }
                        if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                        {
                            proxy.AjouterTransactionPaiementRefresh();
                            proxy.AjouterDepenseRefresh();
                            proxy.AjouterMontureRefresh(Clientvv.Id);
                            proxy.AjouterMontureSupplementRefresh(MontureClass.Cle);
                            GridMonture.IsEnabled = false;
                            GridMonture.DataContext = null;
                            montureversementzero = false;
                            MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                        }
                    }
                    else
                    {
                        // MessageBoxResult resul03s = Xceed.Wpf.Toolkit.MessageBox.Show("Im here", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                        {

                            if (listsupp1 != null)
                            {
                                if (listsupp1.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp1)
                                    {
                                        creationsuppmonture1 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 1;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture1 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture1 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture1 = true;
                            }
                            if (listsupp2 != null)
                            {
                                if (listsupp2.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp2)
                                    {
                                        creationsuppmonture1 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 2;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture1 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture2 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture2 = true;
                            }
                            if (listsupp3 != null)
                            {
                                if (listsupp3.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp3)
                                    {
                                        creationsuppmonture3 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 3;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture3 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture3 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture3 = true;
                            }
                            if (listsupp4 != null)
                            {
                                if (listsupp4.Count > 0)
                                {
                                    foreach (var itemsupp in listsupp4)
                                    {
                                        creationsuppmonture4 = false;
                                        itemsupp.cle = MontureClass.Cle;
                                        itemsupp.interfaceMonture = 4;
                                        proxy.InsertMontureSupplement(itemsupp);
                                        creationsuppmonture4 = true;
                                    }
                                }
                                else
                                {
                                    creationsuppmonture4 = true;
                                }
                            }
                            else
                            {
                                creationsuppmonture4 = true;
                            }
                            proxy.InsertMonture(MontureClass);
                            creationmonture = true;

                            if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                            {
                                ts.Complete();
                            }

                        }
                        if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                        {
                            proxy.AjouterTransactionPaiementRefresh();
                            proxy.AjouterDepenseRefresh();
                            proxy.AjouterMontureRefresh(Clientvv.Id);
                            proxy.AjouterMontureSupplementRefresh(MontureClass.Cle);
                            GridMonture.IsEnabled = false;
                            GridMonture.DataContext = null;
                            montureversementzero = false;
                            MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                        }
                    }


                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && memberuser.ModificationDossierClient == true)
                    {
                        int interfacecreationmonture = 0;
                        bool creationmonture, creationcaisse, creationdepaiement = false;
                        bool creationsuppmonture1 = false;
                        bool creationsuppmonture2 = false;
                        bool creationsuppmonture3 = false;
                        bool creationsuppmonture4 = false;
                        // MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotalENC.Text);
                        SVC.Depense CAISSEMONTURE;
                        SVC.Depeiment PAIEMENTMONTURE;


                        if (txtMontantTotalENC.Text != "")
                        {
                            if (Convert.ToDecimal(txtMontantTotalENC.Text) != 0)
                            {
                                MontureClass.Encaissé = Convert.ToDecimal(txtMontantTotalENC.Text);
                                MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                            }
                            else
                            {
                                MontureClass.Encaissé = 0;
                                MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                            }

                        }
                        else
                        {
                            MontureClass.Encaissé = 0;
                            MontureClass.Reste = MontureClass.MontantTotal - MontureClass.Encaissé;
                        }
                        if (txtAccessoiresQuantite1.Text != "")
                        {
                            if (Convert.ToDecimal(txtAccessoiresQuantite1.Text) == 0)
                            {
                                MontureClass.Accessoires1 = "";
                                MontureClass.AccessoiresPrix1 = null;
                                txtAccessoires1.Text = "";
                                txtAccessoiresPrix1.Text = "0";
                            }
                        }
                        if (txtAccessoiresQuantite2.Text != "")
                        {
                            if (Convert.ToDecimal(txtAccessoiresQuantite2.Text) == 0)
                            {
                                MontureClass.Accessoires2 = "";
                                MontureClass.AccessoiresPrix2 = null;
                                txtAccessoires2.Text = "";
                                txtAccessoiresPrix2.Text = "0";
                            }
                        }
                        ///MontureCLass ==0 lors du chargement
                        if (montureversementzero == false)
                        {
                            //nouveau encaissement alors insertion
                            if (MontureClass.Encaissé != 0)
                            {
                                PAIEMENTMONTURE = new SVC.Depeiment
                                {
                                    date = MontureClass.Date,
                                    montant = Convert.ToDecimal(MontureClass.Encaissé),
                                    paiem = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " date :" + MontureClass.Date,
                                    oper = memberuser.Username,
                                    dates = MontureClass.Dates,
                                    banque = "Caisse",
                                    nfact = MontureClass.Date + " " + MontureClass.RaisonClient,
                                    amontant = Convert.ToDecimal(MontureClass.MontantTotal),
                                    cle = MontureClass.Cle,
                                    cp = MontureClass.Id,
                                    Multiple = false,
                                    CodeClient = MontureClass.IdClient,
                                    RaisonClient = MontureClass.RaisonClient,

                                };
                                CAISSEMONTURE = new SVC.Depense
                                {
                                    cle = MontureClass.Cle,
                                    Auto = true,
                                    Commentaires = "ESPECES" + " VERSEMENT SUR :" + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                    CompteDébité = "Caisse",
                                    Crédit = true,
                                    DateDebit = MontureClass.Date,
                                    DateSaisie = MontureClass.Dates,
                                    Débit = false,
                                    ModePaiement = "ESPECES",
                                    Montant = 0,
                                    MontantCrédit = MontureClass.Encaissé,
                                    NumCheque = Convert.ToString(MontureClass.Id),
                                    Num_Facture = MontureClass.Date + " " + MontureClass.RaisonClient,
                                    RubriqueComptable = "ESPECES VERSEMENT SUR: " + "Ordonnance optique" + " " + MontureClass.RaisonClient + " " + " date :" + MontureClass.Date,
                                    Username = memberuser.Username,

                                };
                                interfacecreationmonture = 1;
                                using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                {
                                    #region monturesupp
                                    if (listsupp1 != null)
                                    {
                                        if (listsupp1.Count() > 0)
                                        {
                                            foreach (var item in listsupp1)
                                            {
                                                var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                if (existe == false)
                                                {
                                                    creationsuppmonture1 = false;
                                                    item.cle = MontureClass.Cle;
                                                    item.interfaceMonture = 1;
                                                    proxy.InsertMontureSupplement(item);
                                                    creationsuppmonture1 = true;
                                                }
                                                else
                                                {
                                                    creationsuppmonture1 = false;
                                                    //item.CleSupplement = Supplement.VerresAssociés;
                                                    proxy.UpdateMontureSupplement(item);
                                                    creationsuppmonture1 = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture1 = true;
                                        }
                                    }

                                    if (listsupp2 != null)
                                    {
                                        if (listsupp2.Count() > 0)
                                        {
                                            foreach (var item in listsupp2)
                                            {
                                                var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                if (existe == false)
                                                {
                                                    creationsuppmonture2 = false;
                                                    item.cle = MontureClass.Cle;
                                                    item.interfaceMonture = 2;
                                                    proxy.InsertMontureSupplement(item);
                                                    creationsuppmonture2 = true;
                                                }
                                                else
                                                {
                                                    creationsuppmonture2 = false;
                                                    //item.CleSupplement = Supplement.VerresAssociés;
                                                    proxy.UpdateMontureSupplement(item);
                                                    creationsuppmonture2 = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture2 = true;
                                        }
                                    }
                                    if (listsupp3 != null)
                                    {
                                        if (listsupp3.Count() > 0)
                                        {
                                            foreach (var item in listsupp3)
                                            {
                                                var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                if (existe == false)
                                                {
                                                    creationsuppmonture3 = false;
                                                    item.cle = MontureClass.Cle;
                                                    item.interfaceMonture = 3;
                                                    proxy.InsertMontureSupplement(item);
                                                    creationsuppmonture3 = true;
                                                }
                                                else
                                                {
                                                    creationsuppmonture3 = false;
                                                    //item.CleSupplement = Supplement.VerresAssociés;
                                                    proxy.UpdateMontureSupplement(item);
                                                    creationsuppmonture3 = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture3 = true;
                                        }
                                    }
                                    if (listsupp4 != null)
                                    {
                                        if (listsupp4.Count() > 0)
                                        {
                                            foreach (var item in listsupp4)
                                            {
                                                var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                if (existe == false)
                                                {
                                                    creationsuppmonture4 = false;
                                                    item.cle = MontureClass.Cle;
                                                    item.interfaceMonture = 4;
                                                    proxy.InsertMontureSupplement(item);
                                                    creationsuppmonture4 = true;
                                                }
                                                else
                                                {
                                                    creationsuppmonture4 = false;
                                                    //item.CleSupplement = Supplement.VerresAssociés;
                                                    proxy.UpdateMontureSupplement(item);
                                                    creationsuppmonture4 = true;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture4 = true;
                                        }
                                    }
                                    #endregion
                                    proxy.UpdateMonture(MontureClass);
                                    creationmonture = true;


                                    proxy.InsertDepense(CAISSEMONTURE);
                                    creationcaisse = true;
                                    proxy.InsertDepeiment(PAIEMENTMONTURE);
                                    creationdepaiement = true;

                                    if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                    {
                                        ts.Complete();
                                    }
                                }
                                if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                {
                                    proxy.AjouterTransactionPaiementRefresh();
                                    proxy.AjouterDepenseRefresh();
                                    proxy.AjouterMontureRefresh(Clientvv.Id);
                                    GridMonture.IsEnabled = false;
                                    GridMonture.DataContext = null;
                                    montureversementzero = false;

                                    MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                }
                            }
                            else
                            {
                                if (MontureClass.Encaissé == 0)
                                {
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {
                                        #region monturesupp

                                        if (listsupp1 != null)
                                        {
                                            if (listsupp1.Count() > 0)
                                            {
                                                foreach (var item in listsupp1)
                                                {
                                                    var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture1 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 1;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture1 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture1 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture1 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture1 = true;
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture1 = true;

                                        }

                                        if (listsupp2 != null)
                                        {
                                            if (listsupp2.Count() > 0)
                                            {
                                                foreach (var item in listsupp2)
                                                {
                                                    var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture2 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 2;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture2 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture2 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture2 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture2 = true;
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture2 = true;

                                        }
                                        if (listsupp3 != null)
                                        {
                                            if (listsupp3.Count() > 0)
                                            {
                                                foreach (var item in listsupp3)
                                                {
                                                    var existe = anciennelistsupp3.Any(n => n.Id == item.Id);

                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture3 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 3;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture3 = true;

                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture3 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture3 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture3 = true;
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture3 = true;

                                        }
                                        if (listsupp4 != null)
                                        {
                                            if (listsupp4.Count() > 0)
                                            {
                                                foreach (var item in listsupp4)
                                                {
                                                    var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture4 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 4;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture4 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture4 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture4 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture4 = true;
                                            }
                                        }
                                        else
                                        {
                                            creationsuppmonture4 = true;

                                        }
                                        #endregion

                                        proxy.UpdateMonture(MontureClass);
                                        creationmonture = true;
                                        if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                        {
                                            ts.Complete();
                                        }
                                    }
                                    if (creationmonture == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                    {
                                        proxy.AjouterTransactionPaiementRefresh();
                                        proxy.AjouterDepenseRefresh();
                                        proxy.AjouterMontureRefresh(Clientvv.Id);
                                        GridMonture.IsEnabled = false;
                                        GridMonture.DataContext = null;
                                        montureversementzero = false;
                                        MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                    }
                                }

                            }
                        }
                        else
                        {
                            if (montureversementzero == true)
                            {
                                //lors du chargement montureclass!=0 apres montureclass==0 
                                //suppression des ecritures dans depense et depaiement
                                if (MontureClass.Encaissé == 0)
                                {
                                    CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                    PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {

                                        proxy.UpdateMonture(MontureClass);
                                        creationmonture = true;
                                        proxy.DeleteDepense(CAISSEMONTURE);
                                        creationcaisse = true;
                                        proxy.DeleteDepeiment(PAIEMENTMONTURE);
                                        creationdepaiement = true;
                                        #region monturesupplement
                                        if (listsupp1 != null)
                                        {
                                            if (listsupp1.Count() > 0)
                                            {
                                                foreach (var item in listsupp1)
                                                {
                                                    var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture1 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 1;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture1 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture1 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture1 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture1 = true;
                                            }
                                        }

                                        if (listsupp2 != null)
                                        {
                                            if (listsupp2.Count() > 0)
                                            {
                                                foreach (var item in listsupp2)
                                                {
                                                    var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture2 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 2;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture2 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture2 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture2 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture2 = true;
                                            }
                                        }
                                        if (listsupp3 != null)
                                        {
                                            if (listsupp3.Count() > 0)
                                            {
                                                foreach (var item in listsupp3)
                                                {
                                                    var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture3 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 3;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture3 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture3 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture3 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture3 = true;
                                            }
                                        }
                                        if (listsupp4 != null)
                                        {
                                            if (listsupp4.Count() > 0)
                                            {
                                                foreach (var item in listsupp4)
                                                {
                                                    var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                    if (existe == false)
                                                    {
                                                        creationsuppmonture4 = false;
                                                        item.cle = MontureClass.Cle;
                                                        item.interfaceMonture = 4;
                                                        proxy.InsertMontureSupplement(item);
                                                        creationsuppmonture4 = true;
                                                    }
                                                    else
                                                    {
                                                        creationsuppmonture4 = false;
                                                        //item.CleSupplement = Supplement.VerresAssociés;
                                                        proxy.UpdateMontureSupplement(item);
                                                        creationsuppmonture4 = true;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                creationsuppmonture4 = true;
                                            }
                                        }
                                        #endregion
                                        if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                        {
                                            ts.Complete();
                                        }
                                    }
                                    if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                    {
                                        proxy.AjouterTransactionPaiementRefresh();
                                        proxy.AjouterDepenseRefresh();
                                        proxy.AjouterMontureRefresh(Clientvv.Id);
                                        GridMonture.IsEnabled = false;
                                        GridMonture.DataContext = null;
                                        montureversementzero = false;
                                        MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                    }
                                }
                                else
                                {
                                    //lors du chargement montureclass!=0 apres montureclass!==0 
                                    //alors mise à jours des écritures dans depense et depaiement
                                    if (MontureClass.Encaissé != 0)
                                    {
                                        CAISSEMONTURE = proxy.GetAllDepense().Where(n => n.cle == MontureClass.Cle).First();
                                        CAISSEMONTURE.MontantCrédit = MontureClass.Encaissé;
                                        PAIEMENTMONTURE = proxy.GetAllDepeiment().Where(n => n.cle == MontureClass.Cle).First();
                                        PAIEMENTMONTURE.montant = Convert.ToDecimal(MontureClass.Encaissé);
                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            #region monturesupplement
                                            if (listsupp1 != null)
                                            {
                                                if (listsupp1.Count() > 0)
                                                {
                                                    foreach (var item in listsupp1)
                                                    {
                                                        var existe = anciennelistsupp1.Any(n => n.Id == item.Id);
                                                        if (existe == false)
                                                        {
                                                            creationsuppmonture1 = false;
                                                            item.cle = MontureClass.Cle;
                                                            item.interfaceMonture = 1;
                                                            proxy.InsertMontureSupplement(item);
                                                            creationsuppmonture1 = true;
                                                        }
                                                        else
                                                        {
                                                            creationsuppmonture1 = false;
                                                            //item.CleSupplement = Supplement.VerresAssociés;
                                                            proxy.UpdateMontureSupplement(item);
                                                            creationsuppmonture1 = true;
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    creationsuppmonture1 = true;
                                                }
                                            }

                                            if (listsupp2 != null)
                                            {
                                                if (listsupp2.Count() > 0)
                                                {
                                                    foreach (var item in listsupp2)
                                                    {
                                                        var existe = anciennelistsupp2.Any(n => n.Id == item.Id);
                                                        if (existe == false)
                                                        {
                                                            creationsuppmonture2 = false;
                                                            item.cle = MontureClass.Cle;
                                                            item.interfaceMonture = 2;
                                                            proxy.InsertMontureSupplement(item);
                                                            creationsuppmonture2 = true;
                                                        }
                                                        else
                                                        {
                                                            creationsuppmonture2 = false;
                                                            //item.CleSupplement = Supplement.VerresAssociés;
                                                            proxy.UpdateMontureSupplement(item);
                                                            creationsuppmonture2 = true;
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    creationsuppmonture2 = true;
                                                }
                                            }
                                            if (listsupp3 != null)
                                            {
                                                if (listsupp3.Count() > 0)
                                                {
                                                    foreach (var item in listsupp3)
                                                    {
                                                        var existe = anciennelistsupp3.Any(n => n.Id == item.Id);
                                                        if (existe == false)
                                                        {
                                                            creationsuppmonture3 = false;
                                                            item.cle = MontureClass.Cle;
                                                            item.interfaceMonture = 3;
                                                            proxy.InsertMontureSupplement(item);
                                                            creationsuppmonture3 = true;
                                                        }
                                                        else
                                                        {
                                                            creationsuppmonture3 = false;
                                                            //item.CleSupplement = Supplement.VerresAssociés;
                                                            proxy.UpdateMontureSupplement(item);
                                                            creationsuppmonture3 = true;
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    creationsuppmonture3 = true;
                                                }
                                            }
                                            if (listsupp4 != null)
                                            {
                                                if (listsupp4.Count() > 0)
                                                {
                                                    foreach (var item in listsupp4)
                                                    {
                                                        var existe = anciennelistsupp4.Any(n => n.Id == item.Id);
                                                        if (existe == false)
                                                        {
                                                            creationsuppmonture4 = false;
                                                            item.cle = MontureClass.Cle;
                                                            item.interfaceMonture = 4;
                                                            proxy.InsertMontureSupplement(item);
                                                            creationsuppmonture4 = true;
                                                        }
                                                        else
                                                        {
                                                            creationsuppmonture4 = false;
                                                            //item.CleSupplement = Supplement.VerresAssociés;
                                                            proxy.UpdateMontureSupplement(item);
                                                            creationsuppmonture4 = true;
                                                        }
                                                    }
                                                }
                                                else
                                                {
                                                    creationsuppmonture4 = true;
                                                }
                                            }
                                            #endregion
                                            proxy.UpdateMonture(MontureClass);
                                            creationmonture = true;


                                            proxy.UpdateDepense(CAISSEMONTURE);
                                            creationcaisse = true;
                                            proxy.UpdateDepeiment(PAIEMENTMONTURE);
                                            creationdepaiement = true;

                                            if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                            {
                                                ts.Complete();
                                            }
                                        }
                                        if (creationcaisse == true && creationmonture == true && creationdepaiement == true && creationsuppmonture1 == true && creationsuppmonture2 == true && creationsuppmonture3 == true && creationsuppmonture4 == true)
                                        {
                                            proxy.AjouterTransactionPaiementRefresh();
                                            proxy.AjouterDepenseRefresh();
                                            proxy.AjouterMontureRefresh(Clientvv.Id);
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            montureversementzero = false;
                                            MessageBoxResult resul03 = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        }
                                    }
                                }
                            }
                        }




                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

       void montureexiste(SVC.Monture MontureClass)
        {
            try
            {
             //   if (MontureDatagrid.SelectedItem != null && memberuser.ModificationDossierClient == true)
               // {
                 //   MontureClass = MontureDatagrid.SelectedItem as SVC.Monture;
                    GridMonture.DataContext = MontureClass;
                    GridMonture.IsEnabled = true;
                    nouvellemonture = false;
                    anciennemonture = true;
                if (MontureClass.StatutVente == false)
                {
                    btnvente.IsEnabled = true;
                    txtMontantTotalENC.IsEnabled = true;
                }
                else
                {
                    btnvente.IsEnabled = false;
                    txtMontantTotalENC.IsEnabled = false;
                }
               

                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";

                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }


                    if (MontureClass.DroiteFleshHaut == true)
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Visible;
                        DroiteFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshHaut.Visibility = Visibility.Collapsed;
                        DroiteFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.DroiteFleshDroite == true)
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Visible;
                        txtDroiteFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtDroiteFleshDroite.Visibility = Visibility.Collapsed;
                        txtDroiteFleshGauche.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshHaut == true)
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Visible;
                        txtGaucheFleshBas.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshHaut.Visibility = Visibility.Collapsed;
                        txtGaucheFleshBas.Visibility = Visibility.Visible;
                    }

                    if (MontureClass.GaucheFleshDroite == true)
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Visible;
                        txtGaucheFleshGauche.Visibility = Visibility.Collapsed;
                    }
                    else
                    {
                        txtGaucheFleshDroite.Visibility = Visibility.Collapsed;
                        txtGaucheFleshGauche.Visibility = Visibility.Visible;
                    }
                    if (MontureClass.Loin == true && MontureClass.Pres == true)
                    {

                        ODLOIN.Text = "Loin";
                        ODITERM.Text = "Interm.";
                        ODPRES.Text = "Près";
                        OGLOIN.Text = "Loin";
                        OGINTERM.Text = "Interm.";
                        OGPRES.Text = "Près";
                        MonturePresLabel.Text = "PRES";
                        MontureLoinLabel.Text = "LOIN";


                    }
                    else
                    {
                        if (MontureClass.Loin == true && MontureClass.Pres == false)
                        {


                            ODLOIN.Text = "Loin";
                            ODITERM.Text = "Loin";
                            ODPRES.Text = "Près";
                            OGLOIN.Text = "Loin";
                            OGINTERM.Text = "Loin";
                            OGPRES.Text = "Près";
                            MonturePresLabel.Text = "LOIN";
                            MontureLoinLabel.Text = "LOIN";


                        }
                        else
                        {
                            if (MontureClass.Loin == false && MontureClass.Pres == true)
                            {
                                ODLOIN.Text = "Loin";
                                ODITERM.Text = "Près";
                                ODPRES.Text = "Près";
                                OGLOIN.Text = "Loin";
                                OGINTERM.Text = "Près";
                                OGPRES.Text = "Près";
                                MonturePresLabel.Text = "PRES";
                                MontureLoinLabel.Text = "PRES";
                            }
                        }
                    }
                    if (MontureClass.Encaissé != 0)
                    {
                        montureversementzero = true;
                    }
                    else
                    {
                        montureversementzero = false;
                    }
                    if (MontureClass.StatutDevis == true && MontureClass.StatutVente == false)
                    {
                        TxtStatutGlobal.Content = "Devis";

                        TxtStatutGlobal.Background = System.Windows.Media.Brushes.PaleVioletRed;
                    }
                    else
                    {
                        if (MontureClass.StatutDevis == true && MontureClass.StatutVente == true)
                        {
                            TxtStatutGlobal.Content = "Vente validée";
                            TxtStatutGlobal.Background = System.Windows.Media.Brushes.LightGreen;
                        }
                    }

               
                listsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                listsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                listsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                listsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
                anciennelistsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                anciennelistsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList();
                anciennelistsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList();
                anciennelistsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
     
        private void AnnulerMonture_Click(object sender, RoutedEventArgs e)
        {
            GridMonture.DataContext = null;
            GridMonture.IsEnabled = false;
            nouvellemonture = false;
            anciennemonture = false;
            txtDroiteFleshHaut.Visibility = Visibility.Visible;
            DroiteFleshBas.Visibility = Visibility.Collapsed;
            txtDroiteFleshDroite.Visibility = Visibility.Visible;
            txtDroiteFleshGauche.Visibility = Visibility.Collapsed;
            txtGaucheFleshHaut.Visibility = Visibility.Visible;
            txtGaucheFleshBas.Visibility = Visibility.Collapsed;
            txtGaucheFleshDroite.Visibility = Visibility.Visible;
            txtGaucheFleshGauche.Visibility = Visibility.Collapsed;
            ODLOIN.Text = "Loin";
            ODITERM.Text = "Interm.";
            ODPRES.Text = "Près";
            OGLOIN.Text = "Loin";
            OGINTERM.Text = "Interm.";
            OGPRES.Text = "Près";
            MonturePresLabel.Text = "PRES";
            MontureLoinLabel.Text = "LOIN";
        }

        /*  private void txtDroiteVerreLoinDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
          {
              try
              {
                  if (nouvellemonture == true && anciennemonture == false)
                  {
                      SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 1, MontureClass, 0);
                      cl.Show();
                  }
                  else
                  {
                      if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                      {
                          SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 1, MontureClass, 0);
                          cl.Show();
                      }
                  }
              }
              catch (Exception ex)
              {
                  MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

              }
          }*/

        private void txtDroiteVerreLoinDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    //  listsupp1 = new List<SVC.MontureSupplement>();
                    SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 1, MontureClass, 0, listsupp1, Clientvv);
                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //    listsupp1 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 1).ToList();
                        SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 1, MontureClass, 1, listsupp1, Clientvv);
                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        /* private void txtGaucheVerreLoinDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
         {
             try
             {
                 if (nouvellemonture == true && anciennemonture == false)
                 {
                     SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 2, MontureClass, 0);
                     cl.Show();
                 }

                 else
                 {
                     if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                     {
                         SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 2, MontureClass, 0);
                         cl.Show();
                     }
                 }

             }
             catch (Exception ex)
             {
                 MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

             }
         }*/
        private void txtGaucheVerreLoinDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    // listsupp2 = new List<SVC.MontureSupplement>();
                    SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 2, MontureClass, 0, listsupp2, Clientvv);
                    cl.Show();
                }

                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //  listsupp2 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 2).ToList(); ;

                        SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 2, MontureClass, 1, listsupp2, Clientvv);
                        cl.Show();
                    }
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtMontureDesignationLoin_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    //  SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 5, MontureClass, 0);
                    selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 5, MontureClass, 0, Clientvv);
                    cl.Show();
                }

                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //   SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 5, MontureClass, 0);
                        selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 5, MontureClass, 0, Clientvv);
                        cl.Show();
                    }
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void MontureDatagrid_MouseRightButtonUp(object sender, MouseButtonEventArgs e)
        {
            try
            {
                MontureDatagrid.ItemsSource = proxy.GetAllMonturebycode(Clientvv.Id).OrderBy(n => n.Date);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc1 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        /* private void txtDroiteVerrePresDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
         {
             try
             {
                 if (nouvellemonture == true && anciennemonture == false)
                 {
                     SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 3, MontureClass, 0);
                     cl.Show();
                 }
                 else
                 {
                     if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                     {
                         SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 3, MontureClass, 0);
                         cl.Show();
                     }
                 }
             }
             catch (Exception ex)
             {
                 MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

             }
         }*/
        private void txtDroiteVerrePresDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {

                    // listsupp3 = new List<SVC.MontureSupplement>();
                    SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 3, MontureClass, 0, listsupp3, Clientvv);
                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {

                        //     listsupp3 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 3).ToList(); ;
                        SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 3, MontureClass, 1, listsupp3, Clientvv);
                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        /* private void txtGaucheVerrePresDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
         {
             try
             {
                 if (nouvellemonture == true && anciennemonture == false)
                 {
                     SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 4, MontureClass, 0);
                     cl.Show();
                 }
                 else
                 {
                     if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                     {
                         SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 4, MontureClass, 0);
                         cl.Show();
                     }
                 }
             }
             catch (Exception ex)
             {
                 MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

             }
         }*/
        private void txtGaucheVerrePresDesignation_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    // listsupp4 = new List<SVC.MontureSupplement>();
                    SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 4, MontureClass, 0, listsupp4, Clientvv);
                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //  listsupp4 = proxy.GetAllMontureSupplementbycle(MontureClass.Cle).Where(n => n.interfaceMonture == 4).ToList();

                        SelectionVerre cl = new SelectionVerre(proxy, memberuser, callback, 4, MontureClass, 1, listsupp4, Clientvv);
                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtMontureDesignationPres_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    // SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 6, MontureClass, 0);
                    selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 6, MontureClass, 0, Clientvv);

                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        // SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 6, MontureClass, 0);
                        selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 6, MontureClass, 0, Clientvv);

                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoires1_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    // SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 7, MontureClass, 0);
                    selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 7, MontureClass, 0, Clientvv);

                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //  SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 7, MontureClass, 0);
                        selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 7, MontureClass, 0, Clientvv);

                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoires2_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (nouvellemonture == true && anciennemonture == false)
                {
                    //   SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 8, MontureClass, 0);
                    selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 8, MontureClass, 0, Clientvv);

                    cl.Show();
                }
                else
                {
                    if (nouvellemonture == false && anciennemonture == true && MontureClass.StatutVente == false)
                    {
                        //   SelectionProduit cl = new SelectionProduit(proxy, memberuser, callback, 8, MontureClass, 0);
                        selectProduitCat cl = new selectProduitCat(proxy, memberuser, callback, 8, MontureClass, 0, Clientvv);

                        cl.Show();
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void txtGaucheFleshDroite_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtGaucheFleshDroite.Visibility = Visibility.Collapsed;
                txtGaucheFleshGauche.Visibility = Visibility.Visible;
                MontureClass.GaucheFleshDroite = false;
                MontureClass.GaucheFleshGauche = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void txtGaucheFleshGauche_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtGaucheFleshDroite.Visibility = Visibility.Visible;
                txtGaucheFleshGauche.Visibility = Visibility.Collapsed;
                MontureClass.GaucheFleshDroite = true;
                MontureClass.GaucheFleshGauche = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
        private void txtDroiteFleshHaut_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtDroiteFleshHaut.Visibility = Visibility.Collapsed;
                DroiteFleshBas.Visibility = Visibility.Visible;
                MontureClass.DroiteFleshBas = true;
                MontureClass.DroiteFleshHaut = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void DroiteFleshBas_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtDroiteFleshHaut.Visibility = Visibility.Visible;
                DroiteFleshBas.Visibility = Visibility.Collapsed;
                MontureClass.DroiteFleshBas = false;
                MontureClass.DroiteFleshHaut = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void txtDroiteVerreLoinDesignation_KeyDown(object sender, KeyEventArgs e)
        {
            switch (e.Key)
            {
                case Key.NumPad0:
                case Key.NumPad1:
                case Key.NumPad2:
                case Key.NumPad3:
                case Key.NumPad4:
                case Key.NumPad5:
                case Key.NumPad6:
                case Key.NumPad7:
                case Key.NumPad8:
                case Key.NumPad9:
                case Key.D0:
                case Key.D1:
                case Key.D2:
                case Key.D3:
                case Key.D4:
                case Key.D5:
                case Key.D6:
                case Key.D7:
                case Key.D8:
                case Key.D9:
                case Key.Tab:
                case Key.Decimal:


                    break;
                default:
                    e.Handled = true;
                    break;
            }
        }

        private void txtPrixTotalLoin_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPrixMontureLoin_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPrixTotalPres_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPrixMonturePres_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPrixTotalAcc1_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPrixTotalAcc2_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoiresPrix1_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal QuantiteAccessoire, Prix = 0;
                if (txtAccessoiresQuantite1.Text != "")
                {
                    QuantiteAccessoire = Convert.ToDecimal(txtAccessoiresQuantite1.Text);
                }
                else
                {
                    QuantiteAccessoire = 0;
                }
                if (txtAccessoiresPrix1.Text != "")
                {
                    Prix = Convert.ToDecimal(txtAccessoiresPrix1.Text);
                }
                else
                {
                    Prix = 0;
                }


                txtPrixTotalAcc1.Text = (QuantiteAccessoire * Prix).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoiresPrix2_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal QuantiteAccessoire, Prix = 0;
                if (txtAccessoiresQuantite2.Text != "")
                {
                    QuantiteAccessoire = Convert.ToDecimal(txtAccessoiresQuantite2.Text);
                }
                else
                {
                    QuantiteAccessoire = 0;
                }
                if (txtAccessoiresPrix2.Text != "")
                {
                    Prix = Convert.ToDecimal(txtAccessoiresPrix2.Text);
                }
                else
                {
                    Prix = 0;
                }


                txtPrixTotalAcc2.Text = (QuantiteAccessoire * Prix).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtDroitPrixVerreLoin_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal DroitPrixLoin, GauchePrixLoin = 0;
                if (txtDroitPrixVerreLoin.Text != "")
                {
                    DroitPrixLoin = Convert.ToDecimal(txtDroitPrixVerreLoin.Text);
                }
                else
                {
                    DroitPrixLoin = 0;
                }
                if (txtGauchePrixVerreLoin.Text != "")
                {
                    GauchePrixLoin = Convert.ToDecimal(txtGauchePrixVerreLoin.Text);
                }
                else
                {
                    GauchePrixLoin = 0;
                }


                txtPrixTotalLoin.Text = (DroitPrixLoin + GauchePrixLoin).ToString();



            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtGauchePrixVerreLoin_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal DroitPrixLoin, GauchePrixLoin = 0;
                if (txtDroitPrixVerreLoin.Text != "")
                {
                    DroitPrixLoin = Convert.ToDecimal(txtDroitPrixVerreLoin.Text);
                }
                else
                {
                    DroitPrixLoin = 0;
                }
                if (txtGauchePrixVerreLoin.Text != "")
                {
                    GauchePrixLoin = Convert.ToDecimal(txtGauchePrixVerreLoin.Text);
                }
                else
                {
                    GauchePrixLoin = 0;
                }


                txtPrixTotalLoin.Text = (DroitPrixLoin + GauchePrixLoin).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtDroitPrixVerrePres_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal DroitPrixPres, GauchePrixPres = 0;
                if (txtDroitPrixVerrePres.Text != "")
                {
                    DroitPrixPres = Convert.ToDecimal(txtDroitPrixVerrePres.Text);
                }
                else
                {
                    DroitPrixPres = 0;
                }
                if (txtGauchePrixVerrePres.Text != "")
                {
                    GauchePrixPres = Convert.ToDecimal(txtGauchePrixVerrePres.Text);
                }
                else
                {
                    GauchePrixPres = 0;
                }


                txtPrixTotalPres.Text = (DroitPrixPres + GauchePrixPres).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtGauchePrixVerrePres_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal DroitPrixPres, GauchePrixPres = 0;
                if (txtDroitPrixVerrePres.Text != "")
                {
                    DroitPrixPres = Convert.ToDecimal(txtDroitPrixVerrePres.Text);
                }
                else
                {
                    DroitPrixPres = 0;
                }
                if (txtGauchePrixVerrePres.Text != "")
                {
                    GauchePrixPres = Convert.ToDecimal(txtGauchePrixVerrePres.Text);
                }
                else
                {
                    GauchePrixPres = 0;
                }


                txtPrixTotalPres.Text = (DroitPrixPres + GauchePrixPres).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoiresQuantite1_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal QuantiteAccessoire, Prix = 0;
                if (txtAccessoiresQuantite1.Text != "")
                {
                    QuantiteAccessoire = Convert.ToDecimal(txtAccessoiresQuantite1.Text);
                }
                else
                {
                    QuantiteAccessoire = 0;
                }
                if (txtAccessoiresPrix1.Text != "")
                {
                    Prix = Convert.ToDecimal(txtAccessoiresPrix1.Text);
                }
                else
                {
                    Prix = 0;
                }


                txtPrixTotalAcc1.Text = (QuantiteAccessoire * Prix).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtAccessoiresQuantite2_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                Decimal QuantiteAccessoire, Prix = 0;
                if (txtAccessoiresQuantite2.Text != "")
                {
                    QuantiteAccessoire = Convert.ToDecimal(txtAccessoiresQuantite2.Text);
                }
                else
                {
                    QuantiteAccessoire = 0;
                }
                if (txtAccessoiresPrix2.Text != "")
                {
                    Prix = Convert.ToDecimal(txtAccessoiresPrix2.Text);
                }
                else
                {
                    Prix = 0;
                }


                txtPrixTotalAcc2.Text = (QuantiteAccessoire * Prix).ToString();


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void GaucheFleshBas_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtGaucheFleshHaut.Visibility = Visibility.Visible;
                txtGaucheFleshBas.Visibility = Visibility.Collapsed;
                MontureClass.GaucheFleshHaut = true;
                MontureClass.GaucheFleshBas = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void btnVision_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (MontureClass.Loin == true && MontureClass.Pres == true)
                {
                    MontureClass.Loin = true;
                    MontureClass.Pres = false;
                    ODLOIN.Text = "Loin";
                    ODITERM.Text = "Loin";
                    ODPRES.Text = "Près";
                    OGLOIN.Text = "Loin";
                    OGINTERM.Text = "Loin";
                    OGPRES.Text = "Près";
                    MonturePresLabel.Text = "LOIN";
                    MontureLoinLabel.Text = "LOIN";
                    txtIntermSphereDroite.Text = txtLoinSphereDroite.Text;
                    txtIntermCylindreDroite.Text = txtLoinCylindreDroite.Text;
                    txtIntermAxeDroite.Text = txtLoinAxeDroite.Text;
                    txtIntermAddDroite.Text = txtLoinAddDroite.Text;
                    txtIntermPrismeDroite.Text = txtLoinPrismeDroite.Text;
                    txtIntermBaseDroite.Text = txtLoinBaseDroite.Text;
                    /*************************************************/
                    txtIntermSphereGauche.Text = txtLoinSphereGauche.Text;
                    txtIntermCylindreGauche.Text = txtLoinCylindreGauche.Text;
                    txtIntermAxeGauche.Text = txtLoinAxeGauche.Text;
                    txtIntermAddGauche.Text = txtLoinAddGauche.Text;
                    txtIntermPrismeGauche.Text = txtLoinPrismeGauche.Text;
                    txtIntermBaseGauche.Text = txtLoinBaseGauche.Text;
                }
                else
                {
                    if (MontureClass.Loin == true && MontureClass.Pres == false)
                    {
                        MontureClass.Loin = false;
                        MontureClass.Pres = true;
                        ODLOIN.Text = "Loin";
                        ODITERM.Text = "Près";
                        ODPRES.Text = "Près";
                        OGLOIN.Text = "Loin";
                        OGINTERM.Text = "Près";
                        OGPRES.Text = "Près";
                        MonturePresLabel.Text = "PRES";
                        MontureLoinLabel.Text = "PRES";
                        txtIntermSphereDroite.Text = txtPresSphereDroite.Text;
                        txtIntermCylindreDroite.Text = txtPresCylindreDroite.Text;
                        txtIntermAxeDroite.Text = txtPresAxeDroite.Text;
                        txtIntermAddDroite.Text = "";
                        txtIntermPrismeDroite.Text = txtPresPrismeDroite.Text;
                        txtIntermBaseDroite.Text = txtPresBaseDroite.Text;
                        /****************************************/
                        txtIntermSphereGauche.Text = txtPresSphereGauche.Text;
                        txtIntermCylindreGauche.Text = txtPresCylindreGauche.Text;
                        txtIntermAxeGauche.Text = txtPresAxeGauche.Text;
                        txtIntermAddGauche.Text = "";
                        txtIntermPrismeGauche.Text = txtPresPrismeGauche.Text;
                        txtIntermBaseGauche.Text = txtPresBaseGauche.Text;
                    }
                    else
                    {
                        if (MontureClass.Loin == false && MontureClass.Pres == true)
                        {
                            MontureClass.Loin = true;
                            MontureClass.Pres = true;
                            ODLOIN.Text = "Loin";
                            ODITERM.Text = "Interm.";
                            ODPRES.Text = "Près";
                            OGLOIN.Text = "Loin";
                            OGINTERM.Text = "Interm.";
                            OGPRES.Text = "Près";
                            MonturePresLabel.Text = "PRES";
                            MontureLoinLabel.Text = "LOIN";
                            txtIntermSphereDroite.Text = "";
                            txtIntermCylindreDroite.Text = "";
                            txtIntermAxeDroite.Text = "";
                            txtIntermAddDroite.Text = "";
                            txtIntermPrismeDroite.Text = "";
                            txtIntermBaseDroite.Text = "";
                            /********************************/
                            txtIntermSphereGauche.Text = "";
                            txtIntermCylindreGauche.Text = "";
                            txtIntermAxeGauche.Text = "";
                            txtIntermAddGauche.Text = "";
                            txtIntermPrismeGauche.Text = "";
                            txtIntermBaseGauche.Text = "";
                        }
                    }

                }


            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtGaucheFleshHaut_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtGaucheFleshHaut.Visibility = Visibility.Collapsed;
                txtGaucheFleshBas.Visibility = Visibility.Visible;
                MontureClass.GaucheFleshHaut = false;
                MontureClass.GaucheFleshBas = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
        private void txtDroiteFleshGauche_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtDroiteFleshGauche.Visibility = Visibility.Collapsed;
                txtDroiteFleshDroite.Visibility = Visibility.Visible;
                MontureClass.DroiteFleshDroite = true;
                MontureClass.DroiteFleshGauche = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
        private void txtDroiteFleshDroite_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                txtDroiteFleshGauche.Visibility = Visibility.Visible;
                txtDroiteFleshDroite.Visibility = Visibility.Collapsed;
                MontureClass.DroiteFleshDroite = false;
                MontureClass.DroiteFleshGauche = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void txtRemiseMonture_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                Decimal PrixTotalLoin, PrixMontureLoin, PrixTotalPres, PrixMonturePres, PrixTotalAcc1, PrixTotalAcc2, remisemonture, montanttotal = 0;

                if (txtPrixTotalLoin.Text != "")
                {
                    PrixTotalLoin = Convert.ToDecimal(txtPrixTotalLoin.Text);
                }
                else
                {
                    PrixTotalLoin = 0;
                }
                if (txtPrixMontureLoin.Text != "")
                {
                    PrixMontureLoin = Convert.ToDecimal(txtPrixMontureLoin.Text);
                }
                else
                {
                    PrixMontureLoin = 0;
                }
                if (txtPrixTotalPres.Text != "")
                {
                    PrixTotalPres = Convert.ToDecimal(txtPrixTotalPres.Text);
                }
                else
                {
                    PrixTotalPres = 0;
                }

                if (txtPrixMonturePres.Text != "")
                {
                    PrixMonturePres = Convert.ToDecimal(txtPrixMonturePres.Text);
                }
                else
                {
                    PrixMonturePres = 0;
                }
                if (txtPrixTotalAcc1.Text != "")
                {
                    PrixTotalAcc1 = Convert.ToDecimal(txtPrixTotalAcc1.Text);
                }
                else
                {
                    PrixTotalAcc1 = 0;
                }

                if (txtPrixTotalAcc2.Text != "")
                {
                    PrixTotalAcc2 = Convert.ToDecimal(txtPrixTotalAcc2.Text);
                }
                else
                {
                    PrixTotalAcc2 = 0;
                }

                montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                if (!String.IsNullOrEmpty(txtRemiseMonture.Text))
                {
                    remisemonture = Convert.ToDecimal(txtRemiseMonture.Text);
                    if (remisemonture != 0 && montanttotal != 0)
                    {
                        if (((selectedparam.maxremisevente * montanttotal) / 100 >= Convert.ToDecimal(remisemonture)))
                        {
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture);
                        }
                        else
                        {
                            txtRemiseMonture.Text = "";
                            montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                        }
                    }
                    else
                    {
                        txtRemiseMonture.Text = "";
                        montanttotal = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin);
                    }
                }
                else
                {
                    remisemonture = 0;
                    txtRemiseMonture.Text = "";
                }
                /**********************************/

                /***********************************/

                // txtMontantTotal.Text = (PrixTotalAcc2 + PrixTotalAcc1 + PrixMonturePres + PrixTotalPres + PrixMontureLoin + PrixTotalLoin - remisemonture).ToString();

                txtMontantTotal.Text = (montanttotal).ToString();
                MontureClass.MontantTotal = Convert.ToDecimal(txtMontantTotal.Text);
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtLoinAddDroite_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                decimal LoinAddDroite, LoinSphereDroite = 0;
                if (txtLoinAddDroite.Text != "")
                {
                    if (decimal.TryParse(txtLoinAddDroite.Text, out LoinAddDroite))
                        LoinAddDroite = Convert.ToDecimal(txtLoinAddDroite.Text);
                    else
                        LoinAddDroite = 0;
                }
                else
                {
                    txtLoinAddDroite.Text = "";
                    LoinAddDroite = 0;
                }
                if (txtLoinSphereDroite.Text != "")
                {
                    if (decimal.TryParse(txtLoinSphereDroite.Text, out LoinSphereDroite))
                        LoinSphereDroite = Convert.ToDecimal(txtLoinSphereDroite.Text);
                    else
                        LoinSphereDroite = 0;
                }
                else
                {
                    txtLoinSphereDroite.Text = "";
                    LoinSphereDroite = 0;
                }
                if (LoinAddDroite != 0 && LoinSphereDroite != 0)
                {

                    txtPresCylindreDroite.Text = txtLoinCylindreDroite.Text;
                    txtPresAxeDroite.Text = txtLoinAxeDroite.Text;
                    txtPresSphereDroite.Text = (LoinAddDroite + LoinSphereDroite).ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtLoinAddGauche_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                decimal LoinAddDroite, LoinSphereDroite = 0;
                if (txtLoinAddGauche.Text != "")
                {
                    if (decimal.TryParse(txtLoinAddGauche.Text, out LoinAddDroite))
                        LoinAddDroite = Convert.ToDecimal(txtLoinAddGauche.Text);
                    else
                        LoinAddDroite = 0;
                }
                else
                {
                    txtLoinAddGauche.Text = "";
                    LoinAddDroite = 0;
                }
                if (txtLoinSphereGauche.Text != "")
                {
                    if (decimal.TryParse(txtLoinSphereGauche.Text, out LoinSphereDroite))
                        LoinSphereDroite = Convert.ToDecimal(txtLoinSphereGauche.Text);
                    else
                        LoinSphereDroite = 0;
                }
                else
                {
                    txtLoinSphereGauche.Text = "";
                    LoinSphereDroite = 0;
                }
                if (LoinAddDroite != 0 && LoinSphereDroite != 0)
                {

                    txtPresCylindreGauche.Text = txtLoinCylindreGauche.Text;
                    txtPresAxeGauche.Text = txtLoinAxeGauche.Text;
                    txtPresSphereGauche.Text = (LoinAddDroite + LoinSphereDroite).ToString();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void btnNouvelleFacture_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                dialog1 = new Window();
                dialog1.Title = "Veuillez choisir un document";
                dialog1.Template = Resources["template3"] as ControlTemplate;

                // dialog1.Content = Resources["content"];
                dialog1.ResizeMode = ResizeMode.NoResize;
                dialog1.Width = 350;
                dialog1.Height = 250;
                dialog1.WindowStartupLocation = WindowStartupLocation.CenterScreen;
                dialog1.ShowDialog();
                interfacefacturation = 0;
                facturenew = true;
                facturemodif = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }


        }

        private void btnModifierFacture_Click(object sender, RoutedEventArgs e)
        {
            try
            {

                if (ListeDesDocuments.SelectedItem != null && memberuser.ModificationDossierClient == true)
                {

                    selectedF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                    if (selectedF1.Auto != true)
                    {
                        if (selectedF1.nfact != "Ancien solde")
                        {
                            ancienneF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            FacturationDesign();
                            bool existemonture = proxy.GetAllMonturebyDossier(selectedF1.cleDossier).Any();
                            bool existelentille = proxy.GetAllLentilleClientbyDossier(selectedF1.cleDossier).Any();
                            if (existemonture == true && existelentille == false)
                            {
                                if (selectedF1.versement != 0)
                                {
                                    ReceptDatagrid.IsEnabled = false;
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }

                            }
                            else
                            {
                                if (existemonture == false && existelentille == true)
                                {
                                    if (selectedF1.versement != 0)
                                    {
                                        ReceptDatagrid.IsEnabled = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.IsEnabled = true;
                                    }
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }
                            }
                            if (factureselectedl != null)
                            {
                                ReceptDatagrid.ItemsSource = factureselectedl;
                                ReceptDatagrid.DataContext = factureselectedl;
                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                WindowBorderFacture.DataContext = selectedF1;
                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                string strTTC = string.Format("{0:0.00}", TTC);
                                txtTTC.Text = strTTC;

                            }
                            facturenew = false;
                            facturemodif = true;
                            string nfact = selectedF1.nfact.Substring(0, 1);

                            switch (nfact)
                            {
                                case "F":
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Facture";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 1;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "A":
                                    chFactureAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture d'avoir";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 2;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "B":
                                    chBonLivraison.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 3;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "C":
                                    chBonLivraisonAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "avoir bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 4;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }

                                    break;
                                case "P":
                                    chProforma.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Proforma";
                                    ReceptDatagrid.CanUserDeleteRows = true;
                                    documenttype = 5;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;



                                    break;
                                case "R":
                                    chFactureProvisoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture provisoir";
                                    ReceptDatagrid.CanUserDeleteRows = true;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;
                                    documenttype = 6;
                                    break;
                            }
                        }

                    }
                    else
                    {
                        if (selectedF1.nfact != "Ancien solde")
                        {
                            facturenonstock = true;
                            ancienneF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            FacturationDesignNonStock();
                            bool existemonture = proxy.GetAllMonturebyDossier(selectedF1.cleDossier).Any();
                            bool existelentille = proxy.GetAllLentilleClientbyDossier(selectedF1.cleDossier).Any();
                            if (existemonture == true && existelentille == false)
                            {
                                if (selectedF1.versement != 0)
                                {
                                    ReceptDatagrid.IsEnabled = false;
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }

                            }
                            else
                            {
                                if (existemonture == false && existelentille == true)
                                {
                                    if (selectedF1.versement != 0)
                                    {
                                        ReceptDatagrid.IsEnabled = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.IsEnabled = true;
                                    }
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }
                            }
                            if (factureselectedl != null)
                            {
                                ReceptDatagrid.ItemsSource = factureselectedl;
                                ReceptDatagrid.DataContext = factureselectedl;
                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                WindowBorderFacture.DataContext = selectedF1;
                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                string strTTC = string.Format("{0:0.00}", TTC);
                                txtTTC.Text = strTTC;

                            }
                            facturenew = false;
                            facturemodif = true;
                            string nfact = selectedF1.nfact.Substring(0, 1);

                            switch (nfact)
                            {
                                case "F":
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Facture";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 1;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "A":
                                    chFactureAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture d'avoir";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 2;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "B":
                                    chBonLivraison.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 3;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "C":
                                    chBonLivraisonAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "avoir bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 4;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }

                                    break;
                                case "P":
                                    chProforma.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Proforma";
                                    ReceptDatagrid.CanUserDeleteRows = true;
                                    documenttype = 5;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;



                                    break;
                                case "R":
                                    chFactureProvisoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture provisoir";
                                    ReceptDatagrid.CanUserDeleteRows = true;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;
                                    documenttype = 6;
                                    break;
                            }
                        }
                    }

                }
                else
                {
                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                }


            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void btnImprimmerFacture_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (ListeDesDocuments.SelectedItem != null)
                {
                    dialog1 = new Window();
                    dialog1.Title = "Impression";
                    dialog1.Template = Resources["template7"] as ControlTemplate;

                    // dialog1.Content = Resources["content"];
                    dialog1.ResizeMode = ResizeMode.NoResize;
                    dialog1.Width = 350;
                    dialog1.Height = 200;
                    dialog1.WindowStartupLocation = WindowStartupLocation.CenterScreen;
                    dialog1.ShowDialog();
                    interfaceimpressionfacture = 0;
                    visualiserFacture = false;
                }
                /* if (ListeDesDocuments.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                 {
                     SVC.F1 SelectedClient = ListeDesDocuments.SelectedItem as SVC.F1;
                     List<SVC.F1> facturelist = new List<SVC.F1>();
                     facturelist.Add(SelectedClient);
                     ImpressionFacture cl = new ImpressionFacture(proxy, facturelist, Clientvv);
                     cl.Show();
                 }
                 else
                 {
                     MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                 }*/
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void ListeDesDocuments_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {

                if (ListeDesDocuments.SelectedItem != null && memberuser.ModificationDossierClient == true)
                {

                    selectedF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                    if (selectedF1.Auto != true)
                    {
                        if (selectedF1.nfact != "Ancien solde")
                        {
                            ancienneF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            FacturationDesign();
                            bool existemonture = proxy.GetAllMonturebyDossier(selectedF1.cleDossier).Any();
                            bool existelentille = proxy.GetAllLentilleClientbyDossier(selectedF1.cleDossier).Any();
                            if (existemonture == true && existelentille == false)
                            {
                                if (selectedF1.versement != 0)
                                {
                                    ReceptDatagrid.IsEnabled = false;
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }

                            }
                            else
                            {
                                if (existemonture == false && existelentille == true)
                                {
                                    if (selectedF1.versement != 0)
                                    {
                                        ReceptDatagrid.IsEnabled = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.IsEnabled = true;
                                    }
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }
                            }
                            if (factureselectedl != null)
                            {
                                ReceptDatagrid.ItemsSource = factureselectedl;
                                ReceptDatagrid.DataContext = factureselectedl;
                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                WindowBorderFacture.DataContext = selectedF1;
                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                string strTTC = string.Format("{0:0.00}", TTC);
                                txtTTC.Text = strTTC;

                            }
                            facturenew = false;
                            facturemodif = true;
                            string nfact = selectedF1.nfact.Substring(0, 1);

                            switch (nfact)
                            {
                                case "F":
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Facture";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 1;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "A":
                                    chFactureAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture d'avoir";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 2;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "B":
                                    chBonLivraison.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 3;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "C":
                                    chBonLivraisonAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "avoir bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 4;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }

                                    break;
                                case "P":
                                    chProforma.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Proforma";
                                    ReceptDatagrid.CanUserDeleteRows = true;
                                    documenttype = 5;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;



                                    break;
                                case "R":
                                    chFactureProvisoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture provisoir";
                                    ReceptDatagrid.CanUserDeleteRows = true;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;
                                    documenttype = 6;
                                    break;
                            }
                        }

                    }
                    else
                    {
                        if (selectedF1.nfact != "Ancien solde")
                        {
                            facturenonstock = true;
                            ancienneF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                            FacturationDesignNonStock();
                            bool existemonture = proxy.GetAllMonturebyDossier(selectedF1.cleDossier).Any();
                            bool existelentille = proxy.GetAllLentilleClientbyDossier(selectedF1.cleDossier).Any();
                            if (existemonture == true && existelentille == false)
                            {
                                if (selectedF1.versement != 0)
                                {
                                    ReceptDatagrid.IsEnabled = false;
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }

                            }
                            else
                            {
                                if (existemonture == false && existelentille == true)
                                {
                                    if (selectedF1.versement != 0)
                                    {
                                        ReceptDatagrid.IsEnabled = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.IsEnabled = true;
                                    }
                                }
                                else
                                {
                                    ReceptDatagrid.IsEnabled = true;
                                }
                            }
                            if (factureselectedl != null)
                            {
                                ReceptDatagrid.ItemsSource = factureselectedl;
                                ReceptDatagrid.DataContext = factureselectedl;
                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                WindowBorderFacture.DataContext = selectedF1;
                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                string strTTC = string.Format("{0:0.00}", TTC);
                                txtTTC.Text = strTTC;

                            }
                            facturenew = false;
                            facturemodif = true;
                            string nfact = selectedF1.nfact.Substring(0, 1);

                            switch (nfact)
                            {
                                case "F":
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Facture";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 1;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "A":
                                    chFactureAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture d'avoir";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 2;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "B":
                                    chBonLivraison.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 3;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                    break;
                                case "C":
                                    chBonLivraisonAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "avoir bon de livraison";
                                    ReceptDatagrid.CanUserDeleteRows = false;
                                    selectedparam = proxy.GetAllParamétre();
                                    documenttype = 4;
                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }

                                    break;
                                case "P":
                                    chProforma.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "modifier Proforma";
                                    ReceptDatagrid.CanUserDeleteRows = true;
                                    documenttype = 5;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;



                                    break;
                                case "R":
                                    chFactureProvisoir.IsChecked = true;
                                    txtnVersement.IsEnabled = false;
                                    NomDocumentLabel.Content = "Facture provisoir";
                                    ReceptDatagrid.CanUserDeleteRows = true;

                                    ReceptDatagrid.Columns[2].IsReadOnly = false;

                                    txtDateOper.IsEnabled = true;
                                    documenttype = 6;
                                    break;
                            }
                        }
                    }

                }
                else
                {
                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                }


            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void ListeDesDocuments_MouseRightButtonUp(object sender, MouseButtonEventArgs e)
        {
            try
            {
                ListeDesDocuments.ItemsSource = proxy.GetAllF1Bycode(Clientvv.Id).Where(n => n.nfact.Substring(0, 2) != "Co").OrderBy(n => n.date);

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        void FacturationDesign()
        {
            Grid.SetColumnSpan(RéglemdfentGfsdfsrid, 1);
            Grid.SetRowSpan(ListeDesDocuments, 3);
            WindowBorderFacture.Visibility = Visibility.Visible;
            gridspl.Visibility = Visibility.Visible;
            NomenclatureDatagrid.Visibility = Visibility.Visible;
            girdspi1.Visibility = Visibility.Visible;
            WindowBorderFacture.IsEnabled = true;
            NomenclatureProduit.ItemsSource = (proxy.GetAllProdf().OrderBy(n => n.design));
            factureopern = true;
            BtnCreerProduit.Visibility = Visibility.Collapsed;
            FamilleCombo.ItemsSource = proxy.GetAllFamilleProduit().OrderBy(x => x.FamilleProduit1);
        }
        void FacturationDesignNonStock()
        {

            var dgtc = NomenclatureProduit.Columns[1] as DataGridTextColumn;
            dgtc.Binding = new System.Windows.Data.Binding("PrixVente");
            var dgtc3 = NomenclatureProduit.Columns[3] as DataGridTextColumn;
            dgtc3.Binding = new System.Windows.Data.Binding("PrixRevient");
            Grid.SetColumnSpan(RéglemdfentGfsdfsrid, 1);
            Grid.SetRowSpan(ListeDesDocuments, 3);
            WindowBorderFacture.Visibility = Visibility.Visible;
            gridspl.Visibility = Visibility.Visible;
            NomenclatureDatagrid.Visibility = Visibility.Visible;
            girdspi1.Visibility = Visibility.Visible;
            WindowBorderFacture.IsEnabled = true;
            NomenclatureProduit.ItemsSource = (proxy.GetAllProduit().OrderBy(n => n.design));
            factureopern = true;
            BtnCreerProduit.Visibility = Visibility.Visible;
            FamilleCombo.ItemsSource = proxy.GetAllFamilleProduit().OrderBy(x => x.FamilleProduit1);
        }
        void NonFacturationDesignNonStock()
        {

            Grid.SetColumnSpan(RéglemdfentGfsdfsrid, 2);
            Grid.SetRowSpan(ListeDesDocuments, 8);
            WindowBorderFacture.Visibility = Visibility.Collapsed;
            gridspl.Visibility = Visibility.Collapsed;
            NomenclatureDatagrid.Visibility = Visibility.Collapsed;
            girdspi1.Visibility = Visibility.Collapsed;
            factureselectedl = new List<SVC.Facture>();
            BtnCreerProduit.Visibility = Visibility.Collapsed;
            nouveauF1 = new SVC.F1();
            //RéglementGfsdfsrid.DataContext = nouveauF1;

            fermer = false;
            documenttype = 0;
            facturenonstock = false;
        }
        void NonFacturationDesign()
        {
            var dgtc = NomenclatureProduit.Columns[1] as DataGridTextColumn;
            dgtc.Binding = new System.Windows.Data.Binding("privente");
            var dgtc3 = NomenclatureProduit.Columns[3] as DataGridTextColumn;
            dgtc3.Binding = new System.Windows.Data.Binding("previent");
            Grid.SetColumnSpan(RéglemdfentGfsdfsrid, 2);
            Grid.SetRowSpan(ListeDesDocuments, 8);
            WindowBorderFacture.Visibility = Visibility.Collapsed;
            gridspl.Visibility = Visibility.Collapsed;
            NomenclatureDatagrid.Visibility = Visibility.Collapsed;
            girdspi1.Visibility = Visibility.Collapsed;
            factureselectedl = new List<SVC.Facture>();
            //  ReceptDatagrid.DataContext = factureselectedl;
            //  ReceptDatagrid.ItemsSource = factureselectedl;
            nouveauF1 = new SVC.F1();
            BtnCreerProduit.Visibility = Visibility.Collapsed;
            //RéglementGfsdfsrid.DataContext = nouveauF1;

            fermer = false;
            documenttype = 0;
            facturenonstock = false;
        }
        bool remplir()
        {
            if (txtDateOper.SelectedDate != null)
            {





                return true;
            }
            else
            {
                return false;
            }
        }
        private void NomenclatureProduit_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (facturenonstock == false)
                {

                    if (chcout.IsChecked == false)
                    {
                        if (NomenclatureProduit.SelectedItem != null && CompteComboBox.SelectedIndex >= 0 && remplir() && factureopern == true)
                        {
                            //    this.Title = title;
                            //  this.WindowTitleBrush = brushajouterfacture;

                            selectedtropuvé = NomenclatureProduit.SelectedItem as SVC.Prodf;
                            var existeproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).Any();
                            SVC.Produit selectedproduit = new SVC.Produit();
                            if (existeproduit)
                            {
                                selectedproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                // facturevente.serialnumber = selectedproduit.marque;
                            }
                            if (selectedtropuvé.quantite > 0)
                            {
                                if (selectedtropuvé.perempt != null)
                                {
                                    if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                    {

                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = selectedtropuvé.privente,
                                            quantite = 0,
                                            Total = selectedtropuvé.privente * 0,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        //   var existeproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).Any();
                                        if (existeproduit)
                                        {
                                            //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                            facturevente.serialnumber = selectedproduit.marque;
                                        }
                                        else
                                        {
                                            facturevente.serialnumber = "";
                                        }

                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {


                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {


                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);






                                        }
                                        ReceptDatagrid.ItemsSource = factureselectedl;
                                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();

                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                    }
                                }
                                else
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = selectedtropuvé.privente,
                                        quantite = 0,
                                        Total = selectedtropuvé.privente * 0,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,

                                        /*****************************************/

                                    };
                                    if (existeproduit)
                                    {
                                        //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                        facturevente.serialnumber = selectedproduit.marque;
                                    }
                                    else
                                    {
                                        facturevente.serialnumber = "";
                                    }
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {

                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {

                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                    }
                                    ReceptDatagrid.ItemsSource = factureselectedl;
                                    CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();

                                }
                            }



                            else
                            {
                                if (selectedtropuvé.quantite == 0 && chBonLivraisonAvoir.IsChecked == true)
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = selectedtropuvé.privente,
                                        quantite = 0,
                                        Total = selectedtropuvé.privente * -1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,

                                    };
                                    if (existeproduit)
                                    {
                                        //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                        facturevente.serialnumber = selectedproduit.marque;
                                    }
                                    else
                                    {
                                        facturevente.serialnumber = "";
                                    }
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {
                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {

                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                    }
                                    ReceptDatagrid.ItemsSource = factureselectedl;
                                    CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                }
                            }

                        }
                    }
                    else
                    {
                        if (chcout.IsChecked == true)
                        {

                            if (NomenclatureProduit.SelectedItem != null && CompteComboBox.SelectedIndex >= 0)
                            {
                                var selectedtropuvé1 = NomenclatureProduit.SelectedItem as SVC.Prodf;
                                selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(selectedtropuvé1.cp)).Where(n => n.quantite != 0).First();
                                var existeproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).Any();
                                SVC.Produit selectedproduit = new SVC.Produit();
                                if (existeproduit)
                                {
                                    selectedproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                    // facturevente.serialnumber = selectedproduit.marque;
                                }
                                if (selectedtropuvé.quantite > 0)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé1.previent,
                                                privente = selectedtropuvé1.privente,
                                                quantite = 0,
                                                Total = selectedtropuvé1.privente * 0,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,

                                            };
                                            if (existeproduit)
                                            {
                                                //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                                facturevente.serialnumber = selectedproduit.marque;
                                            }
                                            else
                                            {
                                                facturevente.serialnumber = "";
                                            }
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {


                                                factureselectedl.Add(facturevente);

                                            }
                                            else
                                            {


                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);






                                            }
                                            ReceptDatagrid.ItemsSource = factureselectedl;
                                            CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();

                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé1.previent,
                                            privente = selectedtropuvé1.privente,
                                            quantite = 0,
                                            Total = selectedtropuvé1.privente * 0,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,


                                        };
                                        if (existeproduit)
                                        {
                                            //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                            facturevente.serialnumber = selectedproduit.marque;
                                        }
                                        else
                                        {
                                            facturevente.serialnumber = "";
                                        }
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {

                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                        }
                                        ReceptDatagrid.ItemsSource = factureselectedl;
                                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();

                                    }
                                }
                                else
                                {
                                    if (selectedtropuvé.quantite == 0 && chBonLivraisonAvoir.IsChecked == true)
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé1.previent,
                                            privente = selectedtropuvé1.privente,
                                            quantite = 0,
                                            Total = selectedtropuvé1.privente * -1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        if (existeproduit)
                                        {
                                            //    SVC.Produit selectedproduit= proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                            facturevente.serialnumber = selectedproduit.marque;
                                        }
                                        else
                                        {
                                            facturevente.serialnumber = "";
                                        }
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {
                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {

                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                        }
                                        ReceptDatagrid.ItemsSource = factureselectedl;
                                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();


                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                    }
                                }

                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un tarif", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                        }
                    }
                }
                else
                {
                    if (NomenclatureProduit.SelectedItem != null && CompteComboBox.SelectedIndex >= 0 && remplir() && factureopern == true)
                    {
                        //    this.Title = title;
                        //  this.WindowTitleBrush = brushajouterfacture;

                        selectedtropuvéNONSTOCK = NomenclatureProduit.SelectedItem as SVC.Produit;
                        // if (selectedtropuvé.quantite > 0)
                        //{
                        if (selectedtropuvéNONSTOCK.PrixVente == null)
                        {
                            selectedtropuvéNONSTOCK.PrixVente = 0;
                        }
                        if (selectedtropuvéNONSTOCK.PrixRevient == null)
                        {
                            selectedtropuvéNONSTOCK.PrixRevient = 0;
                        }

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvéNONSTOCK.cab,
                            //  cf = 0,
                            codeprod = selectedtropuvéNONSTOCK.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvéNONSTOCK.design,
                            // lot = 0,
                            oper = memberuser.Username,
                            // perempt = selectedtropuvéNONSTOCK.perempt,
                            tva = 0,
                            previent = selectedtropuvéNONSTOCK.PrixRevient,
                            privente = selectedtropuvéNONSTOCK.PrixVente,
                            quantite = 0,
                            Total = selectedtropuvéNONSTOCK.PrixVente * 0,
                            ficheproduit = selectedtropuvéNONSTOCK.Id,
                            // ff = selectedtropuvéNONSTOCK.nfact,
                            //  Fournisseur = selectedtropuvéNONSTOCK.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                            serialnumber = selectedtropuvéNONSTOCK.marque,
                            /*****************************************/

                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvéNONSTOCK.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {

                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                        }
                        ReceptDatagrid.ItemsSource = factureselectedl;
                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();


                        // }



                        /* else
                          {
                              if (selectedtropuvé.quantite == 0 && chBonLivraisonAvoir.IsChecked == true)
                              {
                                  SVC.Facture facturevente = new SVC.Facture
                                  {
                                      cab = selectedtropuvéNONSTOCK.cab,
                                    //  cf = selectedtropuvéNONSTOCK.cf,
                                      codeprod = selectedtropuvéNONSTOCK.Id,
                                      dates = DateTime.Now,
                                      datef = DateTime.Now,
                                      design = selectedtropuvéNONSTOCK.design,
                                    //  lot = selectedtropuvéNONSTOCK.lot,
                                      oper = memberuser.Username,
                                   //   perempt = selectedtropuvéNONSTOCK.perempt,
                                    //  tva = selectedtropuvéNONSTOCK.tva,
                                      previent = selectedtropuvéNONSTOCK.PrixRevient,
                                      privente = selectedtropuvéNONSTOCK.PrixVente,
                                      quantite = 0,
                                      Total = selectedtropuvéNONSTOCK.PrixVente * -1,
                                      ficheproduit = selectedtropuvéNONSTOCK.Id,
                                  //    ff = selectedtropuvéNONSTOCK.nfact,
                                   //   Fournisseur = selectedtropuvéNONSTOCK.fourn,
                                      codeclient = Clientvv.Id,
                                      Client = Clientvv.Raison,
                                     // collisage = selectedtropuvéNONSTOCK.collisage,
                                     Auto=true,
                                  };
                                  var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                  if (found == null)
                                  {
                                      factureselectedl.Add(facturevente);

                                  }
                                  else
                                  {

                                      MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est déja dans la facture", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);


                                  }
                                  ReceptDatagrid.ItemsSource = factureselectedl;
                                  CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();


                              }
                              else
                              {
                                  MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                              }
                          }*/

                    }
                }


            }
            catch (Exception EX)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(EX.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void FournisseurCombo_MouseRightButtonUp(object sender, MouseButtonEventArgs e)
        {
            try
            {
                if (facturenonstock != true)
                {
                    ICollectionView cv00 = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);

                    cv00.Filter = delegate (object item)
                    {
                        SVC.Prodf temp = item as SVC.Prodf;
                        return temp.IdFamille != -1;


                    };

                    FamilleCombo.SelectedIndex = -1;
                }
                else
                {
                    ICollectionView cv00 = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);

                    cv00.Filter = delegate (object item)
                    {
                        SVC.Produit temp = item as SVC.Produit;
                        return temp.IdFamille != -1;


                    };

                    FamilleCombo.SelectedIndex = -1;
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void FamilleCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            try
            {
                if (FamilleCombo.SelectedItem != null)
                {
                    if (facturenonstock != true)
                    {
                        SVC.FamilleProduit t = FamilleCombo.SelectedItem as SVC.FamilleProduit;

                        var filter = (t.Id).ToString();

                        ICollectionView cv = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                        if (filter == "")
                            cv.Filter = null;
                        else
                        {
                            cv.Filter = o =>
                            {
                                SVC.Prodf p = o as SVC.Prodf;
                                if (t.Id.ToString() == "txtId")
                                    return ((p.IdFamille).ToString() == filter);
                                return (p.IdFamille.ToString().ToUpper().Contains(filter.ToUpper()));
                            };

                        }
                    }
                    else
                    {
                        SVC.FamilleProduit t = FamilleCombo.SelectedItem as SVC.FamilleProduit;

                        var filter = (t.Id).ToString();

                        ICollectionView cv = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                        if (filter == "")
                            cv.Filter = null;
                        else
                        {
                            cv.Filter = o =>
                            {
                                SVC.Produit p = o as SVC.Produit;
                                if (t.Id.ToString() == "txtId")
                                    return ((p.IdFamille).ToString() == filter);
                                return (p.IdFamille.ToString().ToUpper().Contains(filter.ToUpper()));
                            };

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }

        }

        private void txtRecherche_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {
                if (facturenonstock != true)
                {
                    TextBox t = (TextBox)sender;
                    string filter = t.Text;
                    ICollectionView cv = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                    if (filter == "")
                        cv.Filter = null;
                    else
                    {
                        cv.Filter = o =>
                        {
                            SVC.Prodf p = o as SVC.Prodf;
                            if (t.Name == "txtId")
                                return (p.Id == Convert.ToInt32(filter));
                            return (p.design.ToUpper().Contains(filter.ToUpper()));
                        };
                    }
                    /*  string filterValue = txtRecherche.Text;
                      if (!String.IsNullOrEmpty(filterValue))
                          NomenclatureProduit.Columns[1].AutoFilterValue = filterValue;
                      else NomenclatureProduit.FilterString = "([Id]  >= 0)";*/
                }
                else
                {
                    TextBox t = (TextBox)sender;
                    string filter = t.Text;
                    ICollectionView cv = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                    if (filter == "")
                        cv.Filter = null;
                    else
                    {
                        cv.Filter = o =>
                        {
                            SVC.Produit p = o as SVC.Produit;
                            if (t.Name == "txtId")
                                return (p.Id == Convert.ToInt32(filter));
                            return (p.design.ToUpper().Contains(filter.ToUpper()));
                        };
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void chstockdisponible_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                if (facturenonstock != true)
                {
                    ICollectionView cv00 = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                    if (chstockdisponible.IsChecked == true && chcout.IsChecked == false)
                    {
                        //  ICollectionView cv = CollectionViewSource.GetDefaultView(PatientDataGrid.ItemsSource);
                        cv00.Filter = delegate (object item)
                        {
                            SVC.Prodf temp = item as SVC.Prodf;
                            return temp.quantite > 0;


                        };
                        string ValueCompte = "";
                        if (CompteComboBox.SelectedIndex >= 0)
                        {

                            var test = NomenclatureProduit.ItemsSource as IEnumerable;



                            ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                            switch (ValueCompte)
                            {
                                case "Prixa":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixa;
                                    }

                                    break;
                                case "Prixb":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixb;
                                    }
                                    break;

                                case "Prixc":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixc;
                                    }
                                    break;

                                default:


                                    break;
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void chstockdisponible_Unchecked(object sender, RoutedEventArgs e)
        {
            try
            {
                if (facturenonstock != true)
                {
                    ICollectionView cv00 = CollectionViewSource.GetDefaultView(NomenclatureProduit.ItemsSource);
                    if (chstockdisponible.IsChecked == false && chcout.IsChecked == false)
                    {
                        cv00.Filter = delegate (object item)
                        {
                            SVC.Prodf temp = item as SVC.Prodf;
                            return temp.quantite >= 0 || temp.quantite <= 0;


                        };
                        string ValueCompte = "";
                        if (CompteComboBox.SelectedIndex >= 0)
                        {

                            var test = NomenclatureProduit.ItemsSource as IEnumerable;



                            ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                            switch (ValueCompte)
                            {
                                case "Prixa":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixa;
                                    }

                                    break;
                                case "Prixb":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixb;
                                    }
                                    break;

                                case "Prixc":
                                    foreach (SVC.Prodf item in test)
                                    {
                                        item.privente = item.prixc;
                                    }
                                    break;

                                default:


                                    break;
                            }
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }

        }

        private void CONFIRMERVENTE_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (facturenonstock == false)
                {

                    /*************************************ajout d'un nouveau document de vente***************/
                    if (facturenew == true && facturemodif == false && memberuser.CreationDossierClient == true)
                    {
                        string document = "";
                        if (documenttype == 1)
                        {
                            document = "F";
                        }
                        else
                        {
                            if (documenttype == 2)
                            {
                                document = "A";
                            }
                            else
                            {
                                if (documenttype == 3)
                                {
                                    document = "B";
                                }
                                else
                                {
                                    if (documenttype == 4)
                                    {
                                        document = "C";
                                    }
                                    else
                                    {

                                        if (documenttype == 5)
                                        {
                                            document = "P";
                                        }
                                        else
                                        {
                                            if (documenttype == 6)
                                            {
                                                document = "R";

                                            }
                                        }

                                    }
                                }
                            }
                        }

                        if (Clientvv.Id != 0)
                        {

                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    nouveauF1.remise = Convert.ToDecimal(txtRemise.Text);
                                }
                                else
                                {
                                    nouveauF1.remise = 0;
                                }

                            }
                            else
                            {
                                nouveauF1.remise = 0;
                            }



                            /************************************************/

                            if (documenttype == 2 || documenttype == 4)
                            {
                                decimal timbre = 0;
                                decimal remise = 0;
                                decimal avecremise = 0;
                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text));
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                    }
                                    else
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                        remise = 0;
                                    }
                                }
                                else
                                {
                                    avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                }
                                if (tunisie != true)
                                {
                                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                    {
                                        nouveauF1.timbre = (avecremise * 1 / 100);
                                        timbre = (avecremise * 1 / 100);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;

                                    }
                                }
                                else
                                {
                                    if (chFactureAvoir.IsChecked == true)
                                    {
                                        nouveauF1.timbre = -Convert.ToDecimal(0.6);
                                        timbre = -timbre;
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;
                                    }
                                }
                                nouveauF1.net = (avecremise + timbre);
                                if (txtnVersement.Text != "")
                                {
                                    if (Convert.ToDecimal(txtnVersement.Text) != 0)
                                    {
                                        nouveauF1.versement = Convert.ToDecimal(txtnVersement.Text);
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }
                                    else
                                    {
                                        nouveauF1.versement = 0;
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }

                                }
                                else
                                {
                                    nouveauF1.versement = 0;
                                    nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                }

                                nouveauF1.tva = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                nouveauF1.ht = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                if (nouveauF1.reste != 0)
                                {
                                    nouveauF1.soldé = false;
                                }
                                else
                                {
                                    nouveauF1.soldé = true;

                                }
                            }
                            else
                            {
                                decimal timbre = 0;
                                decimal remise = 0;
                                decimal avecremise = 0;
                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                    }
                                    else
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                        remise = 0;
                                    }
                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                }
                                if (tunisie != true)
                                {
                                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true))
                                    {
                                        nouveauF1.timbre = (avecremise * 1 / 100);
                                        timbre = (avecremise * 1 / 100);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;

                                    }
                                }
                                else
                                {
                                    if (chFacture.IsChecked == true)
                                    {
                                        nouveauF1.timbre = Convert.ToDecimal(0.6); ;
                                        timbre = Convert.ToDecimal(0.6);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;
                                    }
                                }
                                nouveauF1.net = avecremise + timbre;
                                if (txtnVersement.Text != "")
                                {
                                    if (Convert.ToDecimal(txtnVersement.Text) != 0)
                                    {
                                        nouveauF1.versement = Convert.ToDecimal(txtnVersement.Text);
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }
                                    else
                                    {
                                        nouveauF1.versement = 0;
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }

                                }
                                else
                                {
                                    nouveauF1.versement = 0;
                                    nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                }

                                nouveauF1.tva = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                nouveauF1.ht = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                if (nouveauF1.reste != 0)
                                {
                                    nouveauF1.soldé = false;
                                }
                                else
                                {
                                    nouveauF1.soldé = true;

                                }
                            }
                            if (nouveauF1.echeance != 0)
                            {
                                nouveauF1.datecheance = nouveauF1.date.Value.AddDays(Convert.ToDouble(nouveauF1.echeance));
                            }
                            nouveauF1.cle = Clientvv.Id + Clientvv.Raison + nouveauF1.net + DateTime.Now.TimeOfDay;
                            nouveauF1.heure = DateTime.Now.TimeOfDay;
                            /*****************************************************/

                            var remisepourfacture = nouveauF1.remise;
                            bool Operfacture = false;

                            List<int> listrefresh = new List<int>();

                            foreach (SVC.Facture newfacture in factureselectedl)
                            {
                                newfacture.cle = nouveauF1.cle;
                                newfacture.codeclient = nouveauF1.codeclient;
                                if (remisepourfacture != 0)
                                {
                                    if (remisepourfacture >= ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite)))
                                    {
                                        newfacture.remise = ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                        remisepourfacture = remisepourfacture - ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                    }
                                    else
                                    {
                                        newfacture.remise = remisepourfacture;
                                    }

                                }
                                else
                                {
                                    newfacture.remise = 0;
                                }
                                if (newfacture.codeprod != 0)
                                {
                                    listrefresh.Add(Convert.ToInt32(newfacture.ficheproduit));
                                }
                            }


                            if (nouveauF1.versement != 0)
                            {


                                SVC.Depeiment PAIEMENT = new SVC.Depeiment
                                {
                                    date = nouveauF1.date,
                                    montant = Convert.ToDecimal(nouveauF1.versement),
                                    paiem = "ESPECES" + " Vente :" + nouveauF1.nfact + " " + " date :" + nouveauF1.date,
                                    oper = memberuser.Username,
                                    dates = nouveauF1.dates,
                                    banque = "Caisse",
                                    nfact = nouveauF1.nfact,
                                    amontant = Convert.ToDecimal(nouveauF1.net),
                                    cle = nouveauF1.cle,
                                    cp = nouveauF1.Id,
                                    Multiple = false,
                                    CodeClient = nouveauF1.codeclient,
                                    RaisonClient = nouveauF1.raison,

                                };
                                SVC.Depense CAISSE = new SVC.Depense
                                {
                                    cle = nouveauF1.cle,
                                    Auto = true,
                                    Commentaires = "ESPECES" + " Vente :" + nouveauF1.nfact + " " + " date :" + nouveauF1.date,
                                    CompteDébité = "Caisse",
                                    Crédit = true,
                                    DateDebit = nouveauF1.date,
                                    DateSaisie = nouveauF1.dates,
                                    Débit = false,
                                    ModePaiement = "ESPECES",
                                    Montant = 0,
                                    MontantCrédit = nouveauF1.versement,
                                    NumCheque = Convert.ToString(nouveauF1.Id),
                                    Num_Facture = nouveauF1.nfact,
                                    RubriqueComptable = "ESPECES document de vente: " + nouveauF1.raison + " " + nouveauF1.nfact,
                                    Username = memberuser.Username,

                                };
                                bool ii = false;
                                bool depense = false;
                                bool depaiement = false;
                                List<SVC.Facture> listsanszero = new List<SVC.Facture>();
                                foreach (var item in factureselectedl)
                                {
                                    if (item.quantite != 0)
                                    {
                                        item.cle = nouveauF1.cle;
                                        listsanszero.Add(item);
                                    }
                                }
                                if (interfacefacturation == 0)
                                {
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {
                                        ii = proxy.InsertFacture(nouveauF1, listsanszero, document);
                                        Operfacture = true;
                                        if (documenttype != 6 && documenttype != 5)
                                        {
                                            proxy.InsertDepeiment(PAIEMENT);
                                            depaiement = true;
                                            proxy.InsertDepense(CAISSE);
                                            depense = true;
                                        }
                                        else
                                        {

                                            if (documenttype == 5 || documenttype == 6)
                                            {
                                                depense = true;
                                                depaiement = true;
                                            }

                                        }

                                        if (Operfacture == true && ii == true && depaiement == true && depense == true)
                                        {
                                            ts.Complete();
                                            facturemodif = true;
                                            facturenew = false;

                                        }
                                    }
                                    if (Operfacture == true && ii == true && depaiement == true && depense == true)
                                    {

                                        proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterSoldeF1Refresh();
                                        // proxy.AjouterDepenseRefresh();
                                        NonFacturationDesign();
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                    }
                                }
                                else
                                {
                                    /**************monture *****************************/
                                    if (interfacefacturation == 1)
                                    {
                                        bool modifmonture = false;
                                        bool bonfacture = false;
                                        var existeversement = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).Any();
                                        SVC.Depeiment depaiementclass = new SVC.Depeiment(); ;
                                        SVC.Depense depenseclass = new SVC.Depense();

                                        if (existeversement == true)
                                        {
                                            depaiementclass = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).First();
                                            depenseclass = proxy.GetAllDepenseByF1(nouveauF1.cleDossier).First();
                                        }

                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.InsertFacture(nouveauF1, listsanszero, document);

                                            Operfacture = true;
                                            if (existeversement == false)
                                            {
                                                if (documenttype == 1 || documenttype == 3)
                                                {
                                                    depaiement = false;
                                                    proxy.InsertDepeiment(PAIEMENT);
                                                    depaiement = true;
                                                    depense = false;
                                                    proxy.InsertDepense(CAISSE);
                                                    depense = true;

                                                    modifmonture = false;
                                                    MontureClass.Encaissé = nouveauF1.versement;
                                                    MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                    MontureClass.StatutVente = true;
                                                    proxy.UpdateMonture(MontureClass);
                                                    modifmonture = true;
                                                    bonfacture = true;
                                                }
                                                else
                                                {
                                                    depaiement = true;
                                                    modifmonture = true;
                                                    depense = true;
                                                }
                                            }
                                            else
                                            {
                                                if (nouveauF1.versement != 0)
                                                {
                                                    if (documenttype == 1 || documenttype == 3)
                                                    {
                                                        depaiement = false;
                                                        depaiementclass.montant = nouveauF1.versement;
                                                        depaiementclass.cle = nouveauF1.cle;
                                                        proxy.UpdateDepeiment(depaiementclass);
                                                        depaiement = true;
                                                        depense = false;
                                                        depenseclass.MontantCrédit = nouveauF1.versement;
                                                        depenseclass.cle = nouveauF1.cle;
                                                        proxy.UpdateDepense(depenseclass);
                                                        depense = true;
                                                        modifmonture = false;
                                                        MontureClass.Encaissé = nouveauF1.versement;
                                                        MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                        MontureClass.StatutVente = true;
                                                        proxy.UpdateMonture(MontureClass);
                                                        modifmonture = true;
                                                        bonfacture = true;
                                                    }
                                                    else
                                                    {
                                                        modifmonture = true;
                                                        depaiement = true;
                                                        depense = true;
                                                    }
                                                }
                                                else
                                                {
                                                    if (documenttype == 1 || documenttype == 3)
                                                    {
                                                        depaiement = false;
                                                        proxy.DeleteDepeiment(depaiementclass);

                                                        depaiement = true;
                                                        depense = false;
                                                        proxy.DeleteDepense(depenseclass);
                                                        depense = true;
                                                        modifmonture = false;
                                                        MontureClass.Encaissé = nouveauF1.versement;
                                                        MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                        MontureClass.StatutVente = true;
                                                        proxy.UpdateMonture(MontureClass);
                                                        modifmonture = true;
                                                        bonfacture = true;
                                                    }
                                                    else
                                                    {
                                                        modifmonture = true;
                                                        depaiement = true;
                                                        depense = true;

                                                    }
                                                }

                                            }


                                            if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                        {

                                            proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();
                                            if (bonfacture == true)
                                            {
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                            }
                                            //  proxy.AjouterDepenseRefresh();
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            montureversementzero = false;
                                            NonFacturationDesign();
                                            MessageBoxResult resd2ult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        }
                                    }
                                   
                                }
                            }
                            /********************versment ==0)********/
                            else
                            {

                                bool ii = false;
                                List<SVC.Facture> listsanszero = new List<SVC.Facture>();
                                foreach (var item in factureselectedl)
                                {
                                    if (item.quantite != 0)
                                    {
                                        item.cle = nouveauF1.cle;
                                        listsanszero.Add(item);
                                    }
                                }
                                /***********Monture dossier*********************/
                                if (interfacefacturation == 1)
                                {
                                    bool modifmonture = false;
                                    bool depaiement = false;
                                    bool depense = false;
                                    bool facturebon = false;
                                    var existeversement = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).Any();
                                    SVC.Depeiment depaiementclass = new SVC.Depeiment(); ;
                                    SVC.Depense depenseclass = new SVC.Depense();

                                    if (existeversement == true)
                                    {
                                        depaiementclass = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).First();
                                        depenseclass = proxy.GetAllDepenseByF1(nouveauF1.cleDossier).First();
                                    }
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {

                                        ii = proxy.InsertFacture(nouveauF1, listsanszero, document);

                                        Operfacture = true;
                                        if (existeversement == true)
                                        {
                                            if (documenttype == 1 || documenttype == 3)
                                            {
                                                depaiement = false;
                                                proxy.DeleteDepeiment(depaiementclass);

                                                depaiement = true;
                                                depense = false;
                                                proxy.DeleteDepense(depenseclass);
                                                depense = true;
                                                modifmonture = false;
                                                MontureClass.Encaissé = nouveauF1.versement;
                                                MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                MontureClass.StatutVente = true;
                                                proxy.UpdateMonture(MontureClass);
                                                modifmonture = true;
                                                facturebon = true;
                                            }
                                            else
                                            {
                                                modifmonture = true; depense = true; depaiement = true;
                                            }
                                            if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }

                                        }
                                        else
                                        {
                                            // ii = proxy.InsertFacture(nouveauF1, listsanszero, document);

                                            //Operfacture = true;
                                            if (documenttype == 1 || documenttype == 3)
                                            {
                                                MontureClass.Encaissé = nouveauF1.versement;
                                                MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                MontureClass.StatutVente = true;
                                                proxy.UpdateMonture(MontureClass);
                                                modifmonture = true;
                                                facturebon = true;
                                            }
                                            else
                                            {
                                                modifmonture = true;
                                            }

                                            if (Operfacture == true && ii == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }
                                        }



                                    }
                                    if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true && existeversement == true)
                                    {

                                        proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterSoldeF1Refresh();
                                        if (facturebon == true)
                                        {
                                            proxy.AjouterMontureRefresh(Clientvv.Id);
                                        }//    proxy.AjouterDepenseRefresh();
                                        GridMonture.IsEnabled = false;
                                        GridMonture.DataContext = null;
                                        montureversementzero = false;
                                        NonFacturationDesign();
                                        MessageBoxResult resd2ult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);



                                    }
                                    else
                                    {
                                        if (Operfacture == true && ii == true && modifmonture == true && existeversement == false)
                                        {
                                            proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();
                                            if (facturebon == true)
                                            {
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                            }
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            MontureClass = null;
                                            montureversementzero = false;

                                            NonFacturationDesign();
                                            MessageBoxResult resDFult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                        }
                                    }
                                }
                                else
                                {
                                    if (interfacefacturation == 0)
                                    {
                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.InsertFacture(nouveauF1, listsanszero, document);

                                            Operfacture = true;


                                            if (Operfacture == true && ii == true)
                                            {
                                                ts.Complete();
                                                facturemodif = true;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true)
                                        {

                                            proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();

                                            NonFacturationDesign();
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);


                                        }
                                    }
                                

                                }
                            }






                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un autre client", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                        }
                    }
                    else
                    {
                        /******************************************** modification facture*********************************/
                        if (facturenew == false && facturemodif == true && memberuser.ModificationDossierClient == true)
                        {

                            /************************La partie F1***********************/
                            String document = "";
                            if (documenttype == 1)
                            {
                                document = "F";
                            }
                            else
                            {
                                if (documenttype == 2)
                                {
                                    document = "A";
                                }
                                else
                                {
                                    if (documenttype == 3)
                                    {
                                        document = "B";
                                    }
                                    else
                                    {
                                        if (documenttype == 4)
                                        {
                                            document = "C";
                                        }
                                        else
                                        {
                                            if (documenttype == 5)
                                            {
                                                document = "P";
                                            }
                                            else
                                            {
                                                if (documenttype == 6)
                                                {
                                                    document = "R";

                                                }
                                            }

                                        }
                                    }
                                }
                            }

                            if (Clientvv.Id != 0)
                            {



                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        if (ancienneF1.remise != Convert.ToDecimal(txtRemise.Text))
                                        {
                                            selectedF1.remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                    }
                                    else
                                    {
                                        selectedF1.remise = 0;
                                    }

                                }
                                else
                                {
                                    selectedF1.remise = 0;
                                }



                                /************************************************/

                                if (documenttype == 2 || documenttype == 4)
                                {
                                    decimal timbre = 0;
                                    decimal remise = 0;
                                    decimal avecremise = 0;
                                    if (txtRemise.Text != "")
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) != 0)
                                        {
                                            avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text));
                                            remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                        else
                                        {
                                            avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                            remise = 0;
                                        }
                                    }
                                    else
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                    }
                                    if (tunisie != true)
                                    {
                                        if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                        {
                                            selectedF1.timbre = (avecremise * 1 / 100);
                                            timbre = (avecremise * 1 / 100);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;

                                        }
                                    }
                                    else
                                    {
                                        if (chFactureAvoir.IsChecked == true)
                                        {
                                            selectedF1.timbre = -Convert.ToDecimal(0.6); ;
                                            timbre = -timbre;
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;
                                        }
                                    }
                                    selectedF1.net = (avecremise + timbre);
                                    selectedF1.reste = selectedF1.net - selectedF1.versement;



                                    selectedF1.tva = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                    selectedF1.ht = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                    if (selectedF1.reste != 0)
                                    {
                                        selectedF1.soldé = false;
                                    }
                                    else
                                    {
                                        selectedF1.soldé = true;

                                    }
                                }
                                else
                                {
                                    decimal timbre = 0;
                                    decimal remise = 0;
                                    decimal avecremise = 0;
                                    if (txtRemise.Text != "")
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) != 0)
                                        {
                                            avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                            remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                        else
                                        {
                                            avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                            remise = 0;
                                        }
                                    }
                                    else
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    }

                                    if (tunisie != true)
                                    {
                                        if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true))
                                        {
                                            selectedF1.timbre = (avecremise * 1 / 100);
                                            timbre = (avecremise * 1 / 100);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;

                                        }
                                    }
                                    else
                                    {
                                        if (chFacture.IsChecked == true)
                                        {
                                            selectedF1.timbre = Convert.ToDecimal(0.6);
                                            timbre = Convert.ToDecimal(0.6);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;
                                        }
                                    }
                                    selectedF1.net = avecremise + timbre;
                                    selectedF1.reste = selectedF1.net - selectedF1.versement;



                                    selectedF1.tva = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                    selectedF1.ht = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                    if (selectedF1.reste != 0)
                                    {
                                        selectedF1.soldé = false;
                                    }
                                    else
                                    {
                                        selectedF1.soldé = true;

                                    }
                                }
                                if (selectedF1.echeance != 0)
                                {
                                    if (selectedF1.echeance != ancienneF1.echeance)
                                    {
                                        selectedF1.datecheance = selectedF1.date.Value.AddDays(Convert.ToDouble(selectedF1.echeance));
                                    }
                                }

                                /***************************************************/

                                List<int> listrefresh = new List<int>();
                                List<SVC.Facture> NouvelleFacture = new List<SVC.Facture>();
                                List<SVC.Facture> AncienneFacture = new List<SVC.Facture>();
                                var remisepourfacture = selectedF1.remise;

                                bool Operfacture = false;


                                foreach (SVC.Facture newfacture in factureselectedl)
                                {

                                    var found = (anciennefactureselectedl).Any(itemf => itemf.ficheproduit == newfacture.ficheproduit);
                                    if (found == false)
                                    {
                                        if (newfacture.quantite != 0)
                                        {
                                            newfacture.cle = selectedF1.cle;
                                            newfacture.nfact = selectedF1.nfact;


                                            NouvelleFacture.Add(newfacture);
                                        }
                                        if (newfacture.codeprod != 0)
                                        {
                                            listrefresh.Add(Convert.ToInt32(newfacture.ficheproduit));
                                        }

                                    }
                                    else
                                    {
                                        if (remisepourfacture != 0)
                                        {
                                            if (remisepourfacture >= ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite)))
                                            {
                                                newfacture.remise = ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                                remisepourfacture = remisepourfacture - ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                            }
                                            else
                                            {
                                                newfacture.remise = remisepourfacture;
                                            }

                                        }
                                        else
                                        {
                                            newfacture.remise = 0;
                                        }
                                        AncienneFacture.Add(newfacture);
                                        if (newfacture.codeprod != 0)
                                        {
                                            listrefresh.Add(Convert.ToInt32(newfacture.ficheproduit));
                                        }
                                    }
                                }
                                bool ExisteMonture = false;
                                ExisteMonture = proxy.GetAllMonturebyDossier(Convert.ToString(selectedF1.cleDossier)).Any();
                                bool existelentille = false;
                                existelentille = proxy.GetAllLentilleClientbyDossier(Convert.ToString(selectedF1.cleDossier)).Any();

                                if (!(selectedF1.ht == 0 && selectedF1.versement != 0) && ExisteMonture == false && existelentille == false)
                                {


                                    bool ii = false;
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {
                                        ii = proxy.UpdateFacture(selectedF1, NouvelleFacture, AncienneFacture, document);

                                        Operfacture = true;



                                        if (Operfacture == true && ii == true)
                                        {
                                            ts.Complete();
                                            facturemodif = true;
                                            facturenew = false;

                                        }
                                    }
                                    if (Operfacture == true && ii == true)
                                    {

                                        proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterFactureVenteRefresh(selectedF1.cle);
                                        proxy.AjouterSoldeF1Refresh();

                                        NonFacturationDesign();
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        /*******************************************************/
                                        //  selectedF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                                        /*     ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                             factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                             anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact); 
                                             /************************************************************************/
                                        /*    ReceptDatagrid.ItemsSource = factureselectedl;
                                          ReceptDatagrid.DataContext = factureselectedl;
                                          CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                          RéglementGfsdfsrid.DataContext = selectedF1;
                                          var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                          string strTTC = string.Format("{0:0.00}", TTC);
                                          txtTTC.Text = strTTC;*/
                                    }
                                    else
                                    {

                                        if (anciennefactureselectedl != null)
                                        {

                                            /***************************************************/
                                            ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                            /************************************************************************/
                                            ReceptDatagrid.ItemsSource = factureselectedl;
                                            ReceptDatagrid.DataContext = factureselectedl;
                                            CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                            WindowBorderFacture.DataContext = selectedF1;
                                            var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                            string strTTC = string.Format("{0:0.00}", TTC);
                                            txtTTC.Text = strTTC;
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.Opérationéchouée, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }
                                    }
                                }
                                else
                                {
                                    if ((selectedF1.ht == 0 && selectedF1.versement == 0) && ExisteMonture == true && existelentille == false)
                                    {
                                        bool ii = false;
                                        bool updatemonture = false;
                                        SVC.Monture monture1 = proxy.GetAllMonturebyDossier(Convert.ToString(selectedF1.cleDossier)).Last();

                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.UpdateFacture(selectedF1, NouvelleFacture, AncienneFacture, document);

                                            Operfacture = true;

                                            monture1.StatutDevis = true;
                                            monture1.StatutVente = false;
                                            proxy.UpdateMonture(monture1);
                                            updatemonture = true;

                                            if (Operfacture == true && ii == true && updatemonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = true;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true && updatemonture == true)
                                        {

                                            proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterFactureVenteRefresh(selectedF1.cle);
                                            proxy.AjouterSoldeF1Refresh();
                                            NonFacturationDesign();
                                            proxy.AjouterTransactionPaiementRefresh();
                                            proxy.AjouterDepenseRefresh();
                                            proxy.AjouterMontureRefresh(Clientvv.Id);
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            montureversementzero = false;
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        }
                                        else
                                        {

                                            if (anciennefactureselectedl != null)
                                            {

                                                /***************************************************/
                                                ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                                factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                                anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                                /************************************************************************/
                                                ReceptDatagrid.ItemsSource = factureselectedl;
                                                ReceptDatagrid.DataContext = factureselectedl;
                                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                                WindowBorderFacture.DataContext = selectedF1;
                                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                                string strTTC = string.Format("{0:0.00}", TTC);
                                                txtTTC.Text = strTTC;
                                                NonFacturationDesign();
                                                proxy.AjouterTransactionPaiementRefresh();
                                                proxy.AjouterDepenseRefresh();
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                                GridMonture.IsEnabled = false;
                                                GridMonture.DataContext = null;
                                                montureversementzero = false;
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.Opérationéchouée, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }
                                        }
                                    }
                                  
                                }
                            }
                        }



                    }
                }
                else
                {
                    if (facturenew == true && facturemodif == false && memberuser.CreationDossierClient == true)
                    {
                        string document = "";
                        if (documenttype == 1)
                        {
                            document = "F";
                        }
                        else
                        {
                            if (documenttype == 2)
                            {
                                document = "A";
                            }
                            else
                            {
                                if (documenttype == 3)
                                {
                                    document = "B";
                                }
                                else
                                {
                                    if (documenttype == 4)
                                    {
                                        document = "C";
                                    }
                                    else
                                    {

                                        if (documenttype == 5)
                                        {
                                            document = "P";
                                        }
                                        else
                                        {
                                            if (documenttype == 6)
                                            {
                                                document = "R";

                                            }
                                        }

                                    }
                                }
                            }
                        }

                        if (Clientvv.Id != 0)
                        {

                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    nouveauF1.remise = Convert.ToDecimal(txtRemise.Text);
                                }
                                else
                                {
                                    nouveauF1.remise = 0;
                                }

                            }
                            else
                            {
                                nouveauF1.remise = 0;
                            }



                            /************************************************/

                            if (documenttype == 2 || documenttype == 4)
                            {
                                decimal timbre = 0;
                                decimal remise = 0;
                                decimal avecremise = 0;
                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text));
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                    }
                                    else
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                        remise = 0;
                                    }
                                }
                                else
                                {
                                    avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                }
                                if (tunisie != true)
                                {
                                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                    {
                                        nouveauF1.timbre = (avecremise * 1 / 100);
                                        timbre = (avecremise * 1 / 100);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;

                                    }
                                }
                                else
                                {
                                    if (chFactureAvoir.IsChecked == true)
                                    {
                                        nouveauF1.timbre = -Convert.ToDecimal(0.6);
                                        timbre = -timbre;
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;
                                    }
                                }
                                nouveauF1.net = (avecremise + timbre);
                                if (txtnVersement.Text != "")
                                {
                                    if (Convert.ToDecimal(txtnVersement.Text) != 0)
                                    {
                                        nouveauF1.versement = Convert.ToDecimal(txtnVersement.Text);
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }
                                    else
                                    {
                                        nouveauF1.versement = 0;
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }

                                }
                                else
                                {
                                    nouveauF1.versement = 0;
                                    nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                }

                                nouveauF1.tva = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                nouveauF1.ht = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                if (nouveauF1.reste != 0)
                                {
                                    nouveauF1.soldé = false;
                                }
                                else
                                {
                                    nouveauF1.soldé = true;

                                }
                            }
                            else
                            {
                                decimal timbre = 0;
                                decimal remise = 0;
                                decimal avecremise = 0;
                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                    }
                                    else
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                        remise = 0;
                                    }
                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                }
                                if (tunisie != true)
                                {
                                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true))
                                    {
                                        nouveauF1.timbre = (avecremise * 1 / 100);
                                        timbre = (avecremise * 1 / 100);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;

                                    }
                                }
                                else
                                {
                                    if (chFacture.IsChecked == true)
                                    {
                                        nouveauF1.timbre = Convert.ToDecimal(0.6); ;
                                        timbre = Convert.ToDecimal(0.6);
                                    }
                                    else
                                    {
                                        nouveauF1.timbre = 0;
                                        timbre = 0;
                                    }
                                }
                                nouveauF1.net = avecremise + timbre;
                                if (txtnVersement.Text != "")
                                {
                                    if (Convert.ToDecimal(txtnVersement.Text) != 0)
                                    {
                                        nouveauF1.versement = Convert.ToDecimal(txtnVersement.Text);
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }
                                    else
                                    {
                                        nouveauF1.versement = 0;
                                        nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                    }

                                }
                                else
                                {
                                    nouveauF1.versement = 0;
                                    nouveauF1.reste = nouveauF1.net - nouveauF1.versement;

                                }

                                nouveauF1.tva = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                nouveauF1.ht = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                if (nouveauF1.reste != 0)
                                {
                                    nouveauF1.soldé = false;
                                }
                                else
                                {
                                    nouveauF1.soldé = true;

                                }
                            }
                            if (nouveauF1.echeance != 0)
                            {
                                nouveauF1.datecheance = nouveauF1.date.Value.AddDays(Convert.ToDouble(nouveauF1.echeance));
                            }
                            nouveauF1.cle = Clientvv.Id + Clientvv.Raison + nouveauF1.net + DateTime.Now.TimeOfDay;
                            nouveauF1.heure = DateTime.Now.TimeOfDay;
                            /*****************************************************/

                            var remisepourfacture = nouveauF1.remise;
                            bool Operfacture = false;

                            //    List<int> listrefresh = new List<int>();

                            foreach (SVC.Facture newfacture in factureselectedl)
                            {
                                newfacture.cle = nouveauF1.cle;
                                newfacture.codeclient = nouveauF1.codeclient;
                                if (remisepourfacture != 0)
                                {
                                    if (remisepourfacture >= ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite)))
                                    {
                                        newfacture.remise = ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                        remisepourfacture = remisepourfacture - ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                    }
                                    else
                                    {
                                        newfacture.remise = remisepourfacture;
                                    }

                                }
                                else
                                {
                                    newfacture.remise = 0;
                                }
                                /*  if (newfacture.codeprod != 0)
                                  {
                                      listrefresh.Add(Convert.ToInt32(newfacture.ficheproduit));
                                  }*/
                            }


                            if (nouveauF1.versement != 0)
                            {


                                SVC.Depeiment PAIEMENT = new SVC.Depeiment
                                {
                                    date = nouveauF1.date,
                                    montant = Convert.ToDecimal(nouveauF1.versement),
                                    paiem = "ESPECES" + " Vente :" + nouveauF1.nfact + " " + " date :" + nouveauF1.date,
                                    oper = memberuser.Username,
                                    dates = nouveauF1.dates,
                                    banque = "Caisse",
                                    nfact = nouveauF1.nfact,
                                    amontant = Convert.ToDecimal(nouveauF1.net),
                                    cle = nouveauF1.cle,
                                    cp = nouveauF1.Id,
                                    Multiple = false,
                                    CodeClient = nouveauF1.codeclient,
                                    RaisonClient = nouveauF1.raison,

                                };
                                SVC.Depense CAISSE = new SVC.Depense
                                {
                                    cle = nouveauF1.cle,
                                    Auto = true,
                                    Commentaires = "ESPECES" + " Vente :" + nouveauF1.nfact + " " + " date :" + nouveauF1.date,
                                    CompteDébité = "Caisse",
                                    Crédit = true,
                                    DateDebit = nouveauF1.date,
                                    DateSaisie = nouveauF1.dates,
                                    Débit = false,
                                    ModePaiement = "ESPECES",
                                    Montant = 0,
                                    MontantCrédit = nouveauF1.versement,
                                    NumCheque = Convert.ToString(nouveauF1.Id),
                                    Num_Facture = nouveauF1.nfact,
                                    RubriqueComptable = "ESPECES document de vente: " + nouveauF1.raison + " " + nouveauF1.nfact,
                                    Username = memberuser.Username,

                                };
                                bool ii = false;
                                bool depense = false;
                                bool depaiement = false;
                                List<SVC.Facture> listsanszero = new List<SVC.Facture>();
                                foreach (var item in factureselectedl)
                                {
                                    if (item.quantite != 0)
                                    {
                                        item.cle = nouveauF1.cle;
                                        listsanszero.Add(item);
                                    }
                                }
                                if (interfacefacturation == 0)
                                {
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {
                                        ii = proxy.InsertFactureSansStock(nouveauF1, listsanszero, document);
                                        Operfacture = true;
                                        if (documenttype != 6 && documenttype != 5)
                                        {
                                            proxy.InsertDepeiment(PAIEMENT);
                                            depaiement = true;
                                            proxy.InsertDepense(CAISSE);
                                            depense = true;
                                        }
                                        else
                                        {

                                            if (documenttype == 5 || documenttype == 6)
                                            {
                                                depense = true;
                                                depaiement = true;
                                            }

                                        }

                                        if (Operfacture == true && ii == true && depaiement == true && depense == true)
                                        {
                                            ts.Complete();
                                            facturemodif = true;
                                            facturenew = false;

                                        }
                                    }
                                    if (Operfacture == true && ii == true && depaiement == true && depense == true)
                                    {

                                        //   proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterSoldeF1Refresh();
                                        // proxy.AjouterDepenseRefresh();
                                        NonFacturationDesignNonStock();
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                    }
                                }
                                else
                                {
                                    /**************monture *****************************/
                                    if (interfacefacturation == 1)
                                    {
                                        bool modifmonture = false;
                                        bool bonfacture = false;
                                        var existeversement = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).Any();
                                        SVC.Depeiment depaiementclass = new SVC.Depeiment(); ;
                                        SVC.Depense depenseclass = new SVC.Depense();

                                        if (existeversement == true)
                                        {
                                            depaiementclass = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).First();
                                            depenseclass = proxy.GetAllDepenseByF1(nouveauF1.cleDossier).First();
                                        }

                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.InsertFactureSansStock(nouveauF1, listsanszero, document);

                                            Operfacture = true;
                                            if (existeversement == false)
                                            {
                                                if (documenttype == 1 || documenttype == 3)
                                                {
                                                    depaiement = false;
                                                    proxy.InsertDepeiment(PAIEMENT);
                                                    depaiement = true;
                                                    depense = false;
                                                    proxy.InsertDepense(CAISSE);
                                                    depense = true;

                                                    modifmonture = false;
                                                    MontureClass.Encaissé = nouveauF1.versement;
                                                    MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                    MontureClass.StatutVente = true;
                                                    proxy.UpdateMonture(MontureClass);
                                                    modifmonture = true;
                                                    bonfacture = true;
                                                }
                                                else
                                                {
                                                    depaiement = true;
                                                    modifmonture = true;
                                                    depense = true;
                                                }
                                            }
                                            else
                                            {
                                                if (nouveauF1.versement != 0)
                                                {
                                                    if (documenttype == 1 || documenttype == 3)
                                                    {
                                                        depaiement = false;
                                                        depaiementclass.montant = nouveauF1.versement;
                                                        depaiementclass.cle = nouveauF1.cle;
                                                        proxy.UpdateDepeiment(depaiementclass);
                                                        depaiement = true;
                                                        depense = false;
                                                        depenseclass.MontantCrédit = nouveauF1.versement;
                                                        depenseclass.cle = nouveauF1.cle;
                                                        proxy.UpdateDepense(depenseclass);
                                                        depense = true;
                                                        modifmonture = false;
                                                        MontureClass.Encaissé = nouveauF1.versement;
                                                        MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                        MontureClass.StatutVente = true;
                                                        proxy.UpdateMonture(MontureClass);
                                                        modifmonture = true;
                                                        bonfacture = true;
                                                    }
                                                    else
                                                    {
                                                        modifmonture = true;
                                                        depaiement = true;
                                                        depense = true;
                                                    }
                                                }
                                                else
                                                {
                                                    if (documenttype == 1 || documenttype == 3)
                                                    {
                                                        depaiement = false;
                                                        proxy.DeleteDepeiment(depaiementclass);

                                                        depaiement = true;
                                                        depense = false;
                                                        proxy.DeleteDepense(depenseclass);
                                                        depense = true;
                                                        modifmonture = false;
                                                        MontureClass.Encaissé = nouveauF1.versement;
                                                        MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                        MontureClass.StatutVente = true;
                                                        proxy.UpdateMonture(MontureClass);
                                                        modifmonture = true;
                                                        bonfacture = true;
                                                    }
                                                    else
                                                    {
                                                        modifmonture = true;
                                                        depaiement = true;
                                                        depense = true;

                                                    }
                                                }

                                            }


                                            if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                        {

                                            // proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();
                                            if (bonfacture == true)
                                            {
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                            }
                                            //  proxy.AjouterDepenseRefresh();
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            montureversementzero = false;
                                            NonFacturationDesignNonStock();
                                            MessageBoxResult resd2ult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        }
                                    }
                                 
                                }
                            }
                            /********************versment ==0)********/
                            else
                            {

                                bool ii = false;
                                List<SVC.Facture> listsanszero = new List<SVC.Facture>();
                                foreach (var item in factureselectedl)
                                {
                                    if (item.quantite != 0)
                                    {
                                        item.cle = nouveauF1.cle;
                                        listsanszero.Add(item);
                                    }
                                }
                                /***********Monture dossier*********************/
                                if (interfacefacturation == 1)
                                {
                                    bool modifmonture = false;
                                    bool depaiement = false;
                                    bool depense = false;
                                    bool facturebon = false;
                                    var existeversement = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).Any();
                                    SVC.Depeiment depaiementclass = new SVC.Depeiment(); ;
                                    SVC.Depense depenseclass = new SVC.Depense();

                                    if (existeversement == true)
                                    {
                                        depaiementclass = proxy.GetAllDepeimentByF1(nouveauF1.cleDossier).First();
                                        depenseclass = proxy.GetAllDepenseByF1(nouveauF1.cleDossier).First();
                                    }
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {

                                        ii = proxy.InsertFactureSansStock(nouveauF1, listsanszero, document);

                                        Operfacture = true;
                                        if (existeversement == true)
                                        {
                                            if (documenttype == 1 || documenttype == 3)
                                            {
                                                depaiement = false;
                                                proxy.DeleteDepeiment(depaiementclass);

                                                depaiement = true;
                                                depense = false;
                                                proxy.DeleteDepense(depenseclass);
                                                depense = true;
                                                modifmonture = false;
                                                MontureClass.Encaissé = nouveauF1.versement;
                                                MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                MontureClass.StatutVente = true;
                                                proxy.UpdateMonture(MontureClass);
                                                modifmonture = true;
                                                facturebon = true;
                                            }
                                            else
                                            {
                                                modifmonture = true; depense = true; depaiement = true;
                                            }
                                            if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }

                                        }
                                        else
                                        {
                                            // ii = proxy.InsertFacture(nouveauF1, listsanszero, document);

                                            //Operfacture = true;
                                            if (documenttype == 1 || documenttype == 3)
                                            {
                                                MontureClass.Encaissé = nouveauF1.versement;
                                                MontureClass.Reste = MontureClass.MontantTotal - nouveauF1.versement;
                                                MontureClass.StatutVente = true;
                                                proxy.UpdateMonture(MontureClass);
                                                modifmonture = true;
                                                facturebon = true;
                                            }
                                            else
                                            {
                                                modifmonture = true;
                                            }

                                            if (Operfacture == true && ii == true && modifmonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = false;
                                                facturenew = false;

                                            }
                                        }



                                    }
                                    if (Operfacture == true && ii == true && depaiement == true && depense == true && modifmonture == true && existeversement == true)
                                    {

                                        // proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterSoldeF1Refresh();
                                        if (facturebon == true)
                                        {
                                            proxy.AjouterMontureRefresh(Clientvv.Id);
                                        }//    proxy.AjouterDepenseRefresh();
                                        GridMonture.IsEnabled = false;
                                        GridMonture.DataContext = null;
                                        montureversementzero = false;
                                        NonFacturationDesignNonStock();
                                        MessageBoxResult resd2ult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);



                                    }
                                    else
                                    {
                                        if (Operfacture == true && ii == true && modifmonture == true && existeversement == false)
                                        {
                                            //  proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();
                                            if (facturebon == true)
                                            {
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                            }
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            MontureClass = null;
                                            montureversementzero = false;

                                            NonFacturationDesignNonStock();
                                            MessageBoxResult resDFult = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                                        }
                                    }
                                }
                                else
                                {
                                    if (interfacefacturation == 0)
                                    {
                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.InsertFactureSansStock(nouveauF1, listsanszero, document);

                                            Operfacture = true;


                                            if (Operfacture == true && ii == true)
                                            {
                                                ts.Complete();
                                                facturemodif = true;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true)
                                        {

                                            //   proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterSoldeF1Refresh();

                                            NonFacturationDesignNonStock();
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);


                                        }
                                    }
                                  
                                }
                            }






                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un autre client", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                        }
                    }
                    else
                    {
                        if (facturenew == false && facturemodif == true && memberuser.ModificationDossierClient == true)
                        {

                            /************************La partie F1***********************/
                            String document = "";
                            if (documenttype == 1)
                            {
                                document = "F";
                            }
                            else
                            {
                                if (documenttype == 2)
                                {
                                    document = "A";
                                }
                                else
                                {
                                    if (documenttype == 3)
                                    {
                                        document = "B";
                                    }
                                    else
                                    {
                                        if (documenttype == 4)
                                        {
                                            document = "C";
                                        }
                                        else
                                        {
                                            if (documenttype == 5)
                                            {
                                                document = "P";
                                            }
                                            else
                                            {
                                                if (documenttype == 6)
                                                {
                                                    document = "R";

                                                }
                                            }

                                        }
                                    }
                                }
                            }

                            if (Clientvv.Id != 0)
                            {



                                if (txtRemise.Text != "")
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) != 0)
                                    {
                                        if (ancienneF1.remise != Convert.ToDecimal(txtRemise.Text))
                                        {
                                            selectedF1.remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                    }
                                    else
                                    {
                                        selectedF1.remise = 0;
                                    }

                                }
                                else
                                {
                                    selectedF1.remise = 0;
                                }



                                /************************************************/

                                if (documenttype == 2 || documenttype == 4)
                                {
                                    decimal timbre = 0;
                                    decimal remise = 0;
                                    decimal avecremise = 0;
                                    if (txtRemise.Text != "")
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) != 0)
                                        {
                                            avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text));
                                            remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                        else
                                        {
                                            avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                            remise = 0;
                                        }
                                    }
                                    else
                                    {
                                        avecremise = (-Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))));
                                    }
                                    if (tunisie != true)
                                    {
                                        if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                        {
                                            selectedF1.timbre = (avecremise * 1 / 100);
                                            timbre = (avecremise * 1 / 100);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;

                                        }
                                    }
                                    else
                                    {
                                        if (chFactureAvoir.IsChecked == true)
                                        {
                                            selectedF1.timbre = -Convert.ToDecimal(0.6); ;
                                            timbre = -timbre;
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;
                                        }
                                    }
                                    selectedF1.net = (avecremise + timbre);
                                    selectedF1.reste = selectedF1.net - selectedF1.versement;



                                    selectedF1.tva = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                    selectedF1.ht = -(factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                    if (selectedF1.reste != 0)
                                    {
                                        selectedF1.soldé = false;
                                    }
                                    else
                                    {
                                        selectedF1.soldé = true;

                                    }
                                }
                                else
                                {
                                    decimal timbre = 0;
                                    decimal remise = 0;
                                    decimal avecremise = 0;
                                    if (txtRemise.Text != "")
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) != 0)
                                        {
                                            avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                            remise = Convert.ToDecimal(txtRemise.Text);
                                        }
                                        else
                                        {
                                            avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                            remise = 0;
                                        }
                                    }
                                    else
                                    {
                                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    }

                                    if (tunisie != true)
                                    {
                                        if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true))
                                        {
                                            selectedF1.timbre = (avecremise * 1 / 100);
                                            timbre = (avecremise * 1 / 100);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;

                                        }
                                    }
                                    else
                                    {
                                        if (chFacture.IsChecked == true)
                                        {
                                            selectedF1.timbre = Convert.ToDecimal(0.6);
                                            timbre = Convert.ToDecimal(0.6);
                                        }
                                        else
                                        {
                                            selectedF1.timbre = 0;
                                            timbre = 0;
                                        }
                                    }
                                    selectedF1.net = avecremise + timbre;
                                    selectedF1.reste = selectedF1.net - selectedF1.versement;



                                    selectedF1.tva = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite));
                                    selectedF1.ht = (factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.quantite))));
                                    if (selectedF1.reste != 0)
                                    {
                                        selectedF1.soldé = false;
                                    }
                                    else
                                    {
                                        selectedF1.soldé = true;

                                    }
                                }
                                if (selectedF1.echeance != 0)
                                {
                                    if (selectedF1.echeance != ancienneF1.echeance)
                                    {
                                        selectedF1.datecheance = selectedF1.date.Value.AddDays(Convert.ToDouble(selectedF1.echeance));
                                    }
                                }

                                /***************************************************/

                                List<SVC.Facture> NouvelleFacture = new List<SVC.Facture>();
                                List<SVC.Facture> AncienneFacture = new List<SVC.Facture>();
                                var remisepourfacture = selectedF1.remise;

                                bool Operfacture = false;


                                foreach (SVC.Facture newfacture in factureselectedl)
                                {

                                    var found = (anciennefactureselectedl).Any(itemf => itemf.ficheproduit == newfacture.ficheproduit);
                                    if (found == false)
                                    {
                                        if (newfacture.quantite != 0)
                                        {
                                            newfacture.cle = selectedF1.cle;
                                            newfacture.nfact = selectedF1.nfact;


                                            NouvelleFacture.Add(newfacture);
                                        }


                                    }
                                    else
                                    {
                                        if (remisepourfacture != 0)
                                        {
                                            if (remisepourfacture >= ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite)))
                                            {
                                                newfacture.remise = ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                                remisepourfacture = remisepourfacture - ((newfacture.privente) * (newfacture.quantite)) - ((newfacture.previent) * (newfacture.quantite));
                                            }
                                            else
                                            {
                                                newfacture.remise = remisepourfacture;
                                            }

                                        }
                                        else
                                        {
                                            newfacture.remise = 0;
                                        }
                                        AncienneFacture.Add(newfacture);

                                    }
                                }
                                bool ExisteMonture = false;
                                ExisteMonture = proxy.GetAllMonturebyDossier(Convert.ToString(selectedF1.cleDossier)).Any();
                                bool existelentille = false;
                                existelentille = proxy.GetAllLentilleClientbyDossier(Convert.ToString(selectedF1.cleDossier)).Any();

                                if (!(selectedF1.ht == 0 && selectedF1.versement != 0) && ExisteMonture == false && existelentille == false)
                                {


                                    bool ii = false;
                                    using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                    {
                                        ii = proxy.UpdateFactureSansStock(selectedF1, NouvelleFacture, AncienneFacture, document);

                                        Operfacture = true;



                                        if (Operfacture == true && ii == true)
                                        {
                                            ts.Complete();
                                            facturemodif = true;
                                            facturenew = false;

                                        }
                                    }
                                    if (Operfacture == true && ii == true)
                                    {

                                        // proxy.AjouterProdflistRefresh(listrefresh);
                                        proxy.AjouterFactureVenteRefresh(selectedF1.cle);
                                        proxy.AjouterSoldeF1Refresh();

                                        NonFacturationDesignNonStock();
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        /*******************************************************/
                                        //  selectedF1 = ListeDesDocuments.SelectedItem as SVC.F1;
                                        /*     ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                             factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                             anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact); 
                                             /************************************************************************/
                                        /*    ReceptDatagrid.ItemsSource = factureselectedl;
                                          ReceptDatagrid.DataContext = factureselectedl;
                                          CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                          RéglementGfsdfsrid.DataContext = selectedF1;
                                          var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                          string strTTC = string.Format("{0:0.00}", TTC);
                                          txtTTC.Text = strTTC;*/
                                    }
                                    else
                                    {

                                        if (anciennefactureselectedl != null)
                                        {

                                            /***************************************************/
                                            ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                            factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                            anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                            /************************************************************************/
                                            ReceptDatagrid.ItemsSource = factureselectedl;
                                            ReceptDatagrid.DataContext = factureselectedl;
                                            CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                            WindowBorderFacture.DataContext = selectedF1;
                                            var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                            string strTTC = string.Format("{0:0.00}", TTC);
                                            txtTTC.Text = strTTC;
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.Opérationéchouée, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                        }
                                    }
                                }
                                else
                                {
                                    if ((selectedF1.ht == 0 && selectedF1.versement == 0) && ExisteMonture == true && existelentille == false)
                                    {
                                        bool ii = false;
                                        bool updatemonture = false;
                                        SVC.Monture monture1 = proxy.GetAllMonturebyDossier(Convert.ToString(selectedF1.cleDossier)).Last();

                                        using (var ts = new TransactionScope(TransactionScopeOption.RequiresNew))
                                        {
                                            ii = proxy.UpdateFactureSansStock(selectedF1, NouvelleFacture, AncienneFacture, document);

                                            Operfacture = true;

                                            monture1.StatutDevis = true;
                                            monture1.StatutVente = false;
                                            proxy.UpdateMonture(monture1);
                                            updatemonture = true;

                                            if (Operfacture == true && ii == true && updatemonture == true)
                                            {
                                                ts.Complete();
                                                facturemodif = true;
                                                facturenew = false;

                                            }
                                        }
                                        if (Operfacture == true && ii == true && updatemonture == true)
                                        {

                                            //  proxy.AjouterProdflistRefresh(listrefresh);
                                            proxy.AjouterFactureVenteRefresh(selectedF1.cle);
                                            proxy.AjouterSoldeF1Refresh();
                                            NonFacturationDesignNonStock();
                                            proxy.AjouterTransactionPaiementRefresh();
                                            proxy.AjouterDepenseRefresh();
                                            proxy.AjouterMontureRefresh(Clientvv.Id);
                                            GridMonture.IsEnabled = false;
                                            GridMonture.DataContext = null;
                                            montureversementzero = false;
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.OperationSuccées, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);

                                        }
                                        else
                                        {

                                            if (anciennefactureselectedl != null)
                                            {

                                                /***************************************************/
                                                ancienneF1 = proxy.GetAllF1ByVisiteOper(selectedF1.nfact).First();
                                                factureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                                anciennefactureselectedl = proxy.GetAllFactureBycompteur(selectedF1.nfact);
                                                /************************************************************************/
                                                ReceptDatagrid.ItemsSource = factureselectedl;
                                                ReceptDatagrid.DataContext = factureselectedl;
                                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                                WindowBorderFacture.DataContext = selectedF1;
                                                var TTC = ((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                                                string strTTC = string.Format("{0:0.00}", TTC);
                                                txtTTC.Text = strTTC;
                                                NonFacturationDesign();
                                                proxy.AjouterTransactionPaiementRefresh();
                                                proxy.AjouterDepenseRefresh();
                                                proxy.AjouterMontureRefresh(Clientvv.Id);
                                                GridMonture.IsEnabled = false;
                                                GridMonture.DataContext = null;
                                                montureversementzero = false;
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.Opérationéchouée, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            }
                                        }
                                    }
                                    
                                }
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void txtRemise_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {


                if (documenttype == 2 || documenttype == 4)
                {
                    decimal timbre = 0;
                    decimal remise = 0;
                    decimal avecremise = 0;
                    decimal Benf = 0;
                    if (txtRemise.Text != "")
                    {

                        if (txtRemise.Text.Count() > 1)
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                // var net = Convert.ToDecimal((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite));
                                // if (((selectedparam.maxremisevente * net) / 100 >= Convert.ToDecimal(txtRemise.Text)))
                                //{
                                if (Convert.ToDecimal(txtRemise.Text) < 0)
                                {
                                    avecremise = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                else
                                {
                                    avecremise = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                // }
                                /*  else
                                  {
                                      txtRemise.Text = "";
                                      avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                      remise = 0;
                                      Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));
                                  }*/


                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }

                        }
                        else
                        {
                            if (txtRemise.Text.Count() == 1)
                            {
                                var letter = txtRemise.Text.Substring(0, 1);

                                if (letter == "-")
                                {

                                    avecremise = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    remise = 0;
                                    Benf = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));
                                }
                                else
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) > 0)
                                    {
                                        avecremise = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                        Benf = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }

                                }

                            }
                        }
                    }
                    else
                    {
                        txtRemise.Text = "";
                        avecremise = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                        remise = 0;
                        Benf = -Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                    }
                    //      Bénéficemont.Text = Benf.ToString();

                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                    {
                        timbre = (avecremise * 1 / 100);
                        if (timbre > 2500)
                        {
                            timbre = 2500;
                        }
                        txtTimbre.Text = Convert.ToString(timbre);
                    }
                    else
                    {
                        timbre = 0;
                        txtTimbre.Text = Convert.ToString(timbre);

                    }
                    txtNet.Text = Convert.ToString((avecremise + timbre));
                    Bénéficemont.Text = String.Format("{0:0.##}", (Benf));
                }
                else
                {
                    decimal timbre = 0;
                    decimal remise = 0;
                    decimal avecremise = 0;
                    decimal Benf = 0;
                    if (txtRemise.Text != "")
                    {
                        if (Convert.ToDecimal(txtRemise.Text) != 0)
                        {
                            var net = Convert.ToDecimal((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite));
                            if (((selectedparam.maxremisevente * net) / 100 >= Convert.ToDecimal(txtRemise.Text)))
                            {
                                avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }
                            else
                            {
                                txtRemise.Text = "";
                                avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));
                            }


                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                            remise = Convert.ToDecimal(txtRemise.Text);
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                        }
                    }
                    else
                    {
                        txtRemise.Text = "";
                        avecremise = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                        remise = 0;
                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                    }
                    Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                    if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                    {
                        timbre = (avecremise * 1 / 100);
                        if (timbre > 2500)
                        {
                            timbre = 2500;
                        }
                        txtTimbre.Text = Convert.ToString(timbre);
                    }
                    else
                    {
                        timbre = 0;
                        txtTimbre.Text = Convert.ToString(timbre);

                    }
                    txtNet.Text = Convert.ToString(avecremise + timbre);
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void txtnVersement_KeyDown(object sender, KeyEventArgs e)
        {
            switch (e.Key)
            {
                case Key.NumPad0:
                case Key.NumPad1:
                case Key.NumPad2:
                case Key.NumPad3:
                case Key.NumPad4:
                case Key.NumPad5:
                case Key.NumPad6:
                case Key.NumPad7:
                case Key.NumPad8:
                case Key.NumPad9:
                case Key.D0:
                case Key.D1:
                case Key.D2:
                case Key.D3:
                case Key.D4:
                case Key.D5:
                case Key.D6:
                case Key.D7:
                case Key.D8:
                case Key.D9:
                case Key.Tab:
                case Key.Subtract:
                case Key.Decimal:
                    break;
                default:
                    e.Handled = true;
                    break;
            }
        }


        private void chFactureNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 1;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void chFactureAvoirNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 2;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void chBonLivraisonNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 3;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void chBonLivraisonAvoirNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 4;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void chProformaNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 5;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void chFactureProvisoirNew_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                documenttype = 6;
                fermer = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }

        }
        private void annulerVENTE_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                NonFacturationDesign();
                ListeDesDocuments.ItemsSource = proxy.GetAllF1Bycode(Clientvv.Id).Where(n => n.nfact.Substring(0, 2) != "Co").OrderBy(n => n.date);
                interfacefacturation = 0;
                facturenew = false;
                facturemodif = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
       
        private void facturea4_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionfacture = 1;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void BtnReception_Click(object sender, RoutedEventArgs e)
        {

            try
            {
                if (memberuser.CreationCommande == true)
                {

                    AjouterCommande cl = new AjouterCommande(proxy, memberuser, callback, null, null, null);
                    cl.Show();


                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc1 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void BtnCreerProduit_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (memberuser.CreationFichier == true)
                {
                    AjouterProduit cl = new AjouterProduit(proxy, null, memberuser, callback);
                    cl.Show();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void BtnService_Click(object sender, RoutedEventArgs e)
        {
            #region chked



            SVC.Facture facturevente = new SVC.Facture
            {
                cab = "",
                cf = 0,
                codeprod = 0,
                date = DateTime.Now,
                datef = DateTime.Now,
                design = "Service et maintenance",
                lot = "",
                oper = memberuser.Username,
                perempt = null,
                tva = 0,
                previent = 0,
                privente = 1,
                quantite = 1,
                Total = 1 * 1,
                ficheproduit = 0,
                ff = "Service et maintenance",
                Fournisseur = "Service et maintenance",
                collisage = 1,
            };
            var found = factureselectedl.Find(item => item.ficheproduit == 0);
            if (found == null)
            {

                factureselectedl.Add(facturevente);

            }
            else
            {
                //  foreach (SVC.Prodf selectedprodf in produitavendre)
                // {

                found.quantite = found.quantite + 1;
                found.Total = found.Total + (facturevente.Total);

                // }



            }
            ReceptDatagrid.ItemsSource = factureselectedl;
            CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();

        }


        #endregion


        private void btnvente_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                dialog1 = new Window();
                dialog1.Title = "Veuillez choisir un document";
                dialog1.Template = Resources["template4"] as ControlTemplate;
                interfacefacturation = 1;
                dialog1.ResizeMode = ResizeMode.NoResize;
                dialog1.Width = 350;
                dialog1.Height = 300;
                dialog1.WindowStartupLocation = WindowStartupLocation.CenterScreen;
                dialog1.ShowDialog();
                facturenew = true;
                facturemodif = false;


            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void chcodebare_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                if (chcodebare.IsChecked == true)
                {
                    txtbarrecode.Focus();

                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void chcodebare_Unchecked(object sender, RoutedEventArgs e)
        {
            try
            {
                if (chcodebare.IsChecked == false)
                {
                    txtRecherche.Focus();
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void chcout_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                if (chcout.IsChecked == true)
                {

                    var existe = (proxy.GetAllProdf().Any(n => n.quantite != 0));
                    if (existe == true)
                    {
                        List<SVC.Prodf> listprodfcoutmoyen = new List<SVC.Prodf>();

                        var listeCPcode = (from ta in proxy.GetAllProdf()

                                           where ta.quantite != 0
                                           select ta.cp).Distinct();
                        foreach (int cp in listeCPcode)
                        {
                            SVC.Prodf pp = new SVC.Prodf
                            {
                                cp = cp,
                                quantite = 0,
                                previent = 0,
                                prixa = 0,
                                prixb = 0,
                                prixc = 0,

                            };
                            listprodfcoutmoyen.Add(pp);
                        }
                        List<SVC.Prodf> listprodf = (proxy.GetAllProdf().Where(n => n.quantite != 0).ToList());

                        foreach (var existeinfirst in listprodfcoutmoyen)
                        {

                            string ValueCompte = "";
                            if (CompteComboBox.SelectedIndex >= 0)
                            {

                                ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                                foreach (SVC.Prodf itemprodf in listprodf.Reverse<SVC.Prodf>())
                                {


                                    if (existeinfirst.cp == itemprodf.cp)
                                    {
                                        /*    existeinfirst.quantite = listprodf.AsEnumerable().Sum(n=>n.quantite);
                                            existeinfirst.previent = (listprodf.AsEnumerable().Sum(n => n.previent)) / existeinfirst.quantite;
                                            existeinfirst.privente = (listprodf.AsEnumerable().Sum(n => n.privente)) / existeinfirst.quantite;
                                        existeinfirst.prixa = (listprodf.AsEnumerable().Sum(n => n.prixa)) / existeinfirst.quantite;
                                        existeinfirst.prixb = (listprodf.AsEnumerable().Sum(n => n.prixb)) / existeinfirst.quantite;
                                        existeinfirst.prixc = (listprodf.AsEnumerable().Sum(n => n.prixc)) / existeinfirst.quantite;
                                        */

                                        existeinfirst.design = itemprodf.design;


                                        existeinfirst.design = itemprodf.design;
                                        existeinfirst.previent = ((existeinfirst.previent * existeinfirst.quantite) + (itemprodf.previent * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);

                                        existeinfirst.prixa = ((existeinfirst.prixa * existeinfirst.quantite) + (itemprodf.prixa * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);
                                        existeinfirst.prixb = ((existeinfirst.prixb * existeinfirst.quantite) + (itemprodf.prixb * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);
                                        existeinfirst.prixc = ((existeinfirst.prixc * existeinfirst.quantite) + (itemprodf.prixc * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);
                                        existeinfirst.quantite = existeinfirst.quantite + itemprodf.quantite;





                                        switch (ValueCompte)
                                        {
                                            case "Prixa":

                                                existeinfirst.privente = ((existeinfirst.prixa * existeinfirst.quantite) + (itemprodf.prixa * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);


                                                break;
                                            case "Prixb":

                                                existeinfirst.privente = ((existeinfirst.prixb * existeinfirst.quantite) + (itemprodf.prixb * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);

                                                break;

                                            case "Prixc":

                                                existeinfirst.privente = ((existeinfirst.prixc * existeinfirst.quantite) + (itemprodf.prixc * itemprodf.quantite)) / (existeinfirst.quantite + itemprodf.quantite);

                                                break;

                                            default:


                                                break;
                                        }


                                    }
                                }
                            }




                            NomenclatureProduit.ItemsSource = listprodfcoutmoyen;
                        }



                    }
                }
            }

            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void chcout_Unchecked(object sender, RoutedEventArgs e)
        {
            try
            {
                NomenclatureProduit.ItemsSource = (proxy.GetAllProdf().OrderBy(n => n.design));
                string ValueCompte = "";
                if (CompteComboBox.SelectedIndex >= 0)
                {

                    var test = NomenclatureProduit.ItemsSource as IEnumerable;



                    ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                    switch (ValueCompte)
                    {
                        case "Prixa":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixa;
                            }

                            break;
                        case "Prixb":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixb;
                            }
                            break;

                        case "Prixc":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixc;
                            }
                            break;

                        default:


                            break;
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void chfacturationmonture_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                facturenonstock = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void chfacturationmonture_Unchecked(object sender, RoutedEventArgs e)
        {
            try
            {
                facturenonstock = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void chfacturation_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                facturenonstock = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void chfacturation_Unchecked(object sender, RoutedEventArgs e)
        {
            try
            {
                facturenonstock = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void chimpression_Checked_2(object sender, RoutedEventArgs e)
        {
            try
            {
                visualiserFacture = true;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }

        }

        private void chimpression_Unchecked_2(object sender, RoutedEventArgs e)
        {
            try
            {
                visualiserFacture = false;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void facturea5_Checked(object sender, RoutedEventArgs e)
        {
            try
            {
                interfaceimpressionfacture = 2;
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        private void btnCreerImpressionDocument_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (visualiserFacture == true)
                {

                    if (tunisie != true)
                    {
                        if (ListeDesDocuments.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                        {
                            SVC.F1 SelectedClient = ListeDesDocuments.SelectedItem as SVC.F1;
                            List<SVC.F1> facturelist = new List<SVC.F1>();
                            facturelist.Add(SelectedClient);
                            ImpressionFacture cl = new ImpressionFacture(proxy, facturelist, Clientvv, interfaceimpressionfacture);
                            cl.Show();
                            dialog1.Close();
                        }
                    }
                    else
                    {
                        if (ListeDesDocuments.SelectedItem != null && memberuser.ImpressionDossierClient == true)
                        {
                            SVC.F1 SelectedClient = ListeDesDocuments.SelectedItem as SVC.F1;
                            List<SVC.F1> facturelist = new List<SVC.F1>();
                            facturelist.Add(SelectedClient);
                            ImpressionFactureTunisie cl = new ImpressionFactureTunisie(proxy, facturelist, Clientvv, interfaceimpressionfacture);
                            cl.Show();
                            dialog1.Close();
                        }
                    }

                }
                else
                {
                    if (visualiserFacture == false)
                    {
                        if (tunisie != true)
                        {
                            SVC.F1 SelectedClient = ListeDesDocuments.SelectedItem as SVC.F1;
                            List<SVC.F1> facturelist = new List<SVC.F1>();
                            facturelist.Add(SelectedClient);
                            RunFacture(proxy, facturelist, Clientvv, interfaceimpressionfacture);
                            dialog1.Close();
                        }
                        else
                        {
                            SVC.F1 SelectedClient = ListeDesDocuments.SelectedItem as SVC.F1;
                            List<SVC.F1> facturelist = new List<SVC.F1>();
                            facturelist.Add(SelectedClient);
                            RunFactureTunisie(proxy, facturelist, Clientvv, interfaceimpressionfacture);
                            dialog1.Close();
                        }
                    }
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void RunFactureTunisie(SVC.ServiceCliniqueClient proxyrecu, List<SVC.F1> Nfact, SVC.ClientV CLIENRECU, int interfaceimm)
        {
            try
            {
                LocalReport reportViewer1 = new LocalReport();
                var selpara = new List<SVC.Param>();
                SVC.Param selectpara = proxy.GetAllParamétre();
                /******************************/
                string nfact = Nfact.First().nfact.Substring(0, 1);
                string arrété = "";
                string document = "";
                switch (nfact)
                {
                    case "F":

                        document = "Facture";
                        arrété = "Arrétée la présente facture à la somme de";

                        selectpara.ImpressionCollisage = false;
                        break;
                    case "A":

                        arrété = "Arrétée la présente facture d'Avoir à la somme de";
                        document = "Facture d'Avoir";

                        selectpara.ImpressionCollisage = false;
                        break;
                    case "B":

                        arrété = "Arrétée le présent Bon de Livraison à la somme de";
                        document = "Bon de Livraison";

                        // selectpara.ImpressionCollisage = false;
                        break;
                    case "C":

                        arrété = "Arrétée le présent Avoir de Bon de Livraison à la somme de";
                        document = "Bon d'Avoir";


                        break;
                    case "P":

                        arrété = "Arrétée la présente facture Proforma à la somme de";
                        document = "Facture Proforma";

                        selectpara.ImpressionCollisage = false;
                        break;
                    case "R":

                        arrété = "Arrétée la présente facture à la somme de";
                        document = "Facture";

                        selectpara.ImpressionCollisage = false;
                        break;
                }

                /******************Dataset1 parametre****************************/

                selpara.Add(selectpara);

                /****************Convertion*****************/
                string Montant = "";



                /************************************/
                if (interfaceimm == 2)
                {

                    if (Nfact.First().net > 0)
                    {
                        Montant = (Convert.ToDecimal(Nfact.First().net)).ToText(Nut.Currency.EUR, Nut.Language.French);

                    }
                    else
                    {
                        if (Nfact.First().net < 0)
                        {
                            var mm = -Nfact.First().net;
                            Montant = "Moin " + (Convert.ToDecimal(mm)).ToText(Nut.Currency.EUR, Nut.Language.French);
                        }
                    }
                    Montant = Montant.Replace("euro", selpara.First().Limon.ToString());
                    Montant = Montant.Replace("centime", "millime");


                    MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.BonDeLivraisonDemiTunisie), false);

                    reportViewer1.LoadReportDefinition(MyRptStream);


                }
                else
                {
                    if (interfaceimm == 1)
                    {
                        if (selectpara.FactureSansTva == false)
                        {
                            if (Nfact.First().net > 0)
                            {
                                Montant = (Convert.ToDecimal(Nfact.First().net)).ToText(Nut.Currency.EUR, Nut.Language.French);

                            }
                            else
                            {
                                if (Nfact.First().net < 0)
                                {
                                    var mm = -Nfact.First().net;
                                    Montant = "Moin " + (Convert.ToDecimal(mm)).ToText(Nut.Currency.EUR, Nut.Language.French);
                                }
                            }
                            Montant = Montant.Replace("euro", selpara.First().Limon.ToString());
                            Montant = Montant.Replace("centime", "millime");
                            MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.FactureTunisienne), false);

                            reportViewer1.LoadReportDefinition(MyRptStream);


                        }
                        else
                        {
                            if (selectpara.FactureSansTva == true)
                            {
                                if (Nfact.First().net > 0)
                                {
                                    Montant = (Convert.ToDecimal(Nfact.First().net)).ToText(Nut.Currency.EUR, Nut.Language.French);

                                }
                                else
                                {
                                    if (Nfact.First().net < 0)
                                    {
                                        var mm = -Nfact.First().net;
                                        Montant = "Moin " + (Convert.ToDecimal(mm)).ToText(Nut.Currency.EUR, Nut.Language.French);
                                    }
                                }
                                Montant = Montant.Replace("euro", selpara.First().Limon.ToString());
                                Montant = Montant.Replace("centime", "millime");
                                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.FactureSansTva), false);

                                reportViewer1.LoadReportDefinition(MyRptStream);
                            }

                        }
                    }
                }

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                                      //            listerecu=proxy.GetAllSalleDattente();         // rds.Value = proxy1.GetAllMembership();
                rds.Value = Nfact;
                reportViewer1.DataSources.Add(rds);
                /**************************************************/
                var ClientList = new List<SVC.ClientV>();
                ClientList.Add(CLIENRECU);
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet4", ClientList));
                /********************************************/
                var FactureList = proxy.GetAllFactureBycompteur(Nfact.First().nfact);

                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", FactureList.ToList()));
                /*********************************************/

                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", selpara));
                /*****************dataset 5***************/
                List<TVACLASS> listrva = new List<TVACLASS>();
                foreach (var facture in FactureList)
                {
                    if (listrva.Any(n => n.TVA == facture.tva) == false)
                    {
                        TVACLASS tt = new TVACLASS
                        {
                            TVA = Convert.ToDecimal(facture.tva),
                            BASE = Convert.ToDecimal(facture.privente * facture.quantite),
                            MONTANT = Convert.ToDecimal(((facture.privente * facture.quantite) * facture.tva) / 100),
                        };
                        if (tt.TVA != 0)
                        {
                            listrva.Add(tt);
                        }
                    }
                    else
                    {

                        var found = listrva.Find(n => n.TVA == facture.tva);
                        if (found.TVA != 0)
                        {
                            found.BASE = found.BASE + Convert.ToDecimal(facture.privente * facture.quantite);
                            found.MONTANT = found.MONTANT + (Convert.ToDecimal(((facture.privente * facture.quantite) * facture.tva) / 100));
                        }
                    }

                }
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet5", listrva));

                /********************************/
                /********ImagePath************************************/
                reportViewer1.EnableExternalImages = true;
                ReportParameter paramLogo = new ReportParameter();
                paramLogo.Name = "ImagePath";
                String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                paramLogo.Values.Add(@"file:///" + photolocation);
                reportViewer1.SetParameters(paramLogo);
                /**************************************************************/
                ReportParameter paramDocument = new ReportParameter();
                paramDocument.Name = "Document";
                paramDocument.Values.Add(document);
                reportViewer1.SetParameters(paramDocument);
                /*************************************************************/
                ReportParameter paramArrettee = new ReportParameter();
                paramArrettee.Name = "Arrettee";
                paramArrettee.Values.Add(arrété);
                reportViewer1.SetParameters(paramArrettee);
                /*************************************************/
                ReportParameter paramMontantString = new ReportParameter();
                paramMontantString.Name = "MontantString";
                paramMontantString.Values.Add(Montant);
                reportViewer1.SetParameters(paramMontantString);
                /*********************************************************/
                /*************************************************/
                //List<SVC.F1> ListF1 = new List<SVC.F1>();
                var soldeexiste = proxy.GetAllF1All().Any(n => (n.codeclient == CLIENRECU.Id || n.cle == CLIENRECU.cle) && (n.nfact.Substring(0, 1) != "P" && n.nfact.Substring(0, 1) != "R") && n.reste != 0);// proxy.GetAllF1Bycode(CLIENRECU.Id).Any(n => n.reste != 0);
                decimal existe = 0;
                if (soldeexiste == true)
                {
                    existe = Convert.ToDecimal(proxy.GetAllF1All().Where(n => (n.codeclient == CLIENRECU.Id || n.cle == CLIENRECU.cle) && (n.nfact.Substring(0, 1) != "P" && n.nfact.Substring(0, 1) != "R") && n.reste != 0).AsEnumerable().Sum(n => n.reste));

                }
                else
                {
                    existe = 0;
                }


                ReportParameter paramSoldeClient = new ReportParameter();
                paramSoldeClient.Name = "SoldeClient";
                paramSoldeClient.Values.Add(existe.ToString());
                reportViewer1.SetParameters(paramSoldeClient);
                /*********************************************************/
                reportViewer1.Refresh();
                if (interfaceimm == 2)
                {
                    Export(reportViewer1);
                    Print(false);
                }
                else
                {
                    if (interfaceimm == 1)
                    {
                        ExportA4(reportViewer1);
                        Print(false);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }

        }

        private void RunFacture(SVC.ServiceCliniqueClient proxyrecu, List<SVC.F1> Nfact, SVC.ClientV CLIENRECU, int interfaceimm)
        {
            try
            {

                LocalReport reportViewer1 = new LocalReport();
                var selpara = new List<SVC.Param>();
                SVC.Param selectpara = proxy.GetAllParamétre();
                selpara.Add((selectpara));

                string nfact = Nfact.First().nfact.Substring(0, 1);
                string arrété = "";
                string document = "";
                switch (nfact)
                {
                    case "F":
                        arrété = "Arrétée la présente facture à la somme de";
                        document = "Facture";
                        selectpara.ImpressionCollisage = false;
                        break;
                    case "A":
                        arrété = "Arrétée la présente facture d'Avoir à la somme de";
                        document = "Facture d'Avoir";
                        selectpara.ImpressionCollisage = false;
                        break;
                    case "B":
                        arrété = "Arrétée le présent Bon de Livraison à la somme de";
                        document = "Bon de Livraison";
                        break;
                    case "C":
                        arrété = "Arrétée le présent Avoir de Bon de Livraison à la somme de";
                        document = "Bon d'Avoir";

                        break;
                    case "P":
                        arrété = "Arrétée la présente facture Proforma à la somme de";
                        document = "Facture Proforma";
                        selectpara.ImpressionCollisage = false;
                        break;
                    case "R":
                        arrété = "Arrétée la présente facture à la somme de";
                        document = "Facture";
                        selectpara.ImpressionCollisage = false;
                        break;
                }

                /******************Dataset1 parametre****************************/

                /****************Convertion*****************/
                string Montant = "";

                if (Nfact.First().net > 0)
                {
                    Montant = (Convert.ToDecimal(Nfact.First().net)).ToText(Nut.Currency.EUR, Nut.Language.French);

                }
                else
                {
                    if (Nfact.First().net < 0)
                    {
                        var mm = -Nfact.First().net;
                        Montant = "Moin " + (Convert.ToDecimal(mm)).ToText(Nut.Currency.EUR, Nut.Language.French);
                    }
                }
                Montant = Montant.Replace("euro", selpara.First().Limon.ToString());

                /************************************/
                if (interfaceimm == 2)
                {
                    MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.BonDeLivraisonDemi), false);

                    reportViewer1.LoadReportDefinition(MyRptStream);
                }
                else
                {
                    if (interfaceimm == 1)
                    {
                        if (selectpara.FactureSansTva == false)
                        {
                            MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.Facture), false);

                            reportViewer1.LoadReportDefinition(MyRptStream);
                        }
                        else
                        {
                            if (selectpara.FactureSansTva == true)
                            {
                                MemoryStream MyRptStream = new MemoryStream((NewOptics.Properties.Resources.FactureSansTva), false);

                                reportViewer1.LoadReportDefinition(MyRptStream);
                            }
                        }
                    }
                }

                ReportDataSource rds = new ReportDataSource();
                rds.Name = "DataSet2";//This refers to the dataset name in the RDLC file
                                      //            listerecu=proxy.GetAllSalleDattente();         // rds.Value = proxy1.GetAllMembership();
                rds.Value = Nfact;
                reportViewer1.DataSources.Add(rds);
                /**************************************************/
                var ClientList = new List<SVC.ClientV>();
                ClientList.Add(CLIENRECU);
                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet4", ClientList));
                /********************************************/
                var FactureList = proxy.GetAllFactureBycompteur(Nfact.First().nfact);

                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet3", FactureList.ToList()));
                /*********************************************/

                reportViewer1.DataSources.Add(new Microsoft.Reporting.WinForms.ReportDataSource("DataSet1", selpara));
                /********ImagePath************************************/
                reportViewer1.EnableExternalImages = true;
                ReportParameter paramLogo = new ReportParameter();
                paramLogo.Name = "ImagePath";
                String photolocation = System.Environment.CurrentDirectory + "/Logo.png";

                paramLogo.Values.Add(@"file:///" + photolocation);
                reportViewer1.SetParameters(paramLogo);
                /**************************************************************/
                ReportParameter paramDocument = new ReportParameter();
                paramDocument.Name = "Document";
                paramDocument.Values.Add(document);
                reportViewer1.SetParameters(paramDocument);
                /*************************************************************/
                ReportParameter paramArrettee = new ReportParameter();
                paramArrettee.Name = "Arrettee";
                paramArrettee.Values.Add(arrété);
                reportViewer1.SetParameters(paramArrettee);
                /*************************************************/
                ReportParameter paramMontantString = new ReportParameter();
                paramMontantString.Name = "MontantString";
                paramMontantString.Values.Add(Montant);
                reportViewer1.SetParameters(paramMontantString);
                /*********************************************************/
                /*************************************************/
                var soldeexiste = proxy.GetAllF1All().Any(n => (n.codeclient == CLIENRECU.Id || n.cle == CLIENRECU.cle) && (n.nfact.Substring(0, 1) != "P" && n.nfact.Substring(0, 1) != "R") && n.reste != 0);// proxy.GetAllF1Bycode(CLIENRECU.Id).Any(n => n.reste != 0);
                decimal existe = 0;
                if (soldeexiste == true)
                {
                    existe = Convert.ToDecimal(proxy.GetAllF1All().Where(n => (n.codeclient == CLIENRECU.Id || n.cle == CLIENRECU.cle) && (n.nfact.Substring(0, 1) != "P" && n.nfact.Substring(0, 1) != "R") && n.reste != 0).AsEnumerable().Sum(n => n.reste));

                }
                else
                {
                    existe = 0;
                }

                ReportParameter paramSoldeClient = new ReportParameter();
                paramSoldeClient.Name = "SoldeClient";
                paramSoldeClient.Values.Add(existe.ToString());
                reportViewer1.SetParameters(paramSoldeClient);


                if (interfaceimm == 2)
                {
                    Export(reportViewer1);
                    Print(false);
                }
                else
                {
                    if (interfaceimm == 1)
                    {
                        ExportA4(reportViewer1);
                        Print(false);
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc10 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void CompteComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {

        }

        private void CompteComboBox_DropDownClosed(object sender, EventArgs e)
        {
            try
            {

                string ValueCompte = "";
                if (CompteComboBox.SelectedIndex >= 0)
                {

                    var test = NomenclatureProduit.ItemsSource as IEnumerable;



                    ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                    switch (ValueCompte)
                    {
                        case "Prixa":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixa;
                            }

                            break;
                        case "Prixb":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixb;
                            }
                            break;

                        case "Prixc":
                            foreach (SVC.Prodf item in test)
                            {
                                item.privente = item.prixc;
                            }
                            break;

                        default:


                            break;
                    }


                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }
        
       
        private void ConfirmerDocument_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (memberuser.CreationDossierClient == true)
                {
                    if (facturenonstock == false)
                    {
                        if (fermer == true)
                        {
                            txtnVersement.IsEnabled = true;
                            FacturationDesign();
                            factureselectedl = new List<SVC.Facture>();
                            ReceptDatagrid.DataContext = factureselectedl;
                            ReceptDatagrid.ItemsSource = factureselectedl;
                            ReceptDatagrid.IsEnabled = true;
                            txtTTC.Text = "0";
                            txtnfact.IsEnabled = false;


                            if (documenttype == 3)
                            {
                                NomDocumentLabel.Content = "bon de livraison";
                                chBonLivraison.IsChecked = true;
                                txtnVersement.IsEnabled = true;
                                selectedparam = proxy.GetAllParamétre();

                                if (selectedparam.AffichPrixAchatVente == true)
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                }
                                else
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                }
                                if (selectedparam.ModiPrix == true)
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = false;
                                }
                                else
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = true;
                                }
                                if (selectedparam.modidate == true)
                                {
                                    txtDateOper.IsEnabled = true;
                                }
                                if (selectedparam.affiben == true)
                                {
                                    Bénéfice.Visibility = Visibility.Visible;
                                    Bénéficemont.Visibility = Visibility.Visible;

                                }
                            }
                            else
                            {
                                if (documenttype == 4)
                                {
                                    NomDocumentLabel.Content = "avoir bon de livraison";
                                    chBonLivraisonAvoir.IsChecked = true;
                                    txtnVersement.IsEnabled = true;
                                    selectedparam = proxy.GetAllParamétre();

                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                }
                                else
                                {
                                    if (documenttype == 1)
                                    {
                                        NomDocumentLabel.Content = "Nouvelle Facture";
                                        chFacture.IsChecked = true;
                                        txtnVersement.IsEnabled = true;
                                        selectedparam = proxy.GetAllParamétre();

                                        if (selectedparam.AffichPrixAchatVente == true)
                                        {
                                            NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                        }
                                        else
                                        {
                                            NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                        }
                                        if (selectedparam.ModiPrix == true)
                                        {
                                            ReceptDatagrid.Columns[2].IsReadOnly = false;
                                        }
                                        else
                                        {
                                            ReceptDatagrid.Columns[2].IsReadOnly = true;
                                        }
                                        if (selectedparam.modidate == true)
                                        {
                                            txtDateOper.IsEnabled = true;
                                        }
                                        if (selectedparam.affiben == true)
                                        {
                                            Bénéfice.Visibility = Visibility.Visible;
                                            Bénéficemont.Visibility = Visibility.Visible;
                                            //   Bénéficemont.Text = Convert.ToString(((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                        }
                                    }
                                    else
                                    {
                                        if (documenttype == 2)
                                        {
                                            NomDocumentLabel.Content = "Facture d'avoir";
                                            chFactureAvoir.IsChecked = true;
                                            txtnVersement.IsEnabled = true;
                                            selectedparam = proxy.GetAllParamétre();

                                            if (selectedparam.AffichPrixAchatVente == true)
                                            {
                                                NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                            }
                                            else
                                            {
                                                NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                            }
                                            if (selectedparam.ModiPrix == true)
                                            {
                                                ReceptDatagrid.Columns[2].IsReadOnly = false;
                                            }
                                            else
                                            {
                                                ReceptDatagrid.Columns[2].IsReadOnly = true;
                                            }
                                            if (selectedparam.modidate == true)
                                            {
                                                txtDateOper.IsEnabled = true;
                                            }
                                            if (selectedparam.affiben == true)
                                            {
                                                Bénéfice.Visibility = Visibility.Visible;
                                                Bénéficemont.Visibility = Visibility.Visible;

                                            }
                                        }
                                        else
                                        {
                                            if (documenttype == 6)
                                            {
                                                NomDocumentLabel.Content = "Facture provisoir";
                                                chFactureProvisoir.IsChecked = true;
                                                txtnVersement.IsEnabled = true;



                                                ReceptDatagrid.Columns[2].IsReadOnly = false;


                                                txtDateOper.IsEnabled = true;


                                            }
                                            else
                                            {
                                                if (documenttype == 5)
                                                {
                                                    NomDocumentLabel.Content = "Nouvelle Proforma";
                                                    chProforma.IsChecked = true;
                                                    txtnVersement.IsEnabled = false;
                                                    ReceptDatagrid.Columns[2].IsReadOnly = false;


                                                    txtDateOper.IsEnabled = true;
                                                }
                                            }

                                        }
                                    }
                                }
                            }



                            CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                            nouveauF1 = new SVC.F1
                            {
                                codeclient = Clientvv.Id,
                                date = DateTime.Now,
                                dates = DateTime.Now,
                                raison = Clientvv.Raison,
                                timbre = 0,
                                echeance = 0,
                                ht = 0,
                                net = 0,
                                oper = memberuser.Username,
                                tva = 0,
                                versement = 0,
                                reste = 0,
                                modep = "A TERME",
                                remise = 0,

                            };
                            WindowBorderFacture.DataContext = nouveauF1;
                            dialog1.Close();
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un document de vente", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                        }
                    }
                    else
                    {
                        if (facturenonstock == true)
                        {
                            if (fermer == true)
                            {
                                txtnVersement.IsEnabled = true;
                                FacturationDesignNonStock();
                                factureselectedl = new List<SVC.Facture>();
                                ReceptDatagrid.DataContext = factureselectedl;
                                ReceptDatagrid.ItemsSource = factureselectedl;
                                ReceptDatagrid.IsEnabled = true;
                                txtTTC.Text = "0";
                                txtnfact.IsEnabled = false;


                                if (documenttype == 3)
                                {
                                    NomDocumentLabel.Content = "bon de livraison";
                                    chBonLivraison.IsChecked = true;
                                    txtnVersement.IsEnabled = true;
                                    selectedparam = proxy.GetAllParamétre();

                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;

                                    }
                                }
                                else
                                {
                                    if (documenttype == 4)
                                    {
                                        NomDocumentLabel.Content = "avoir bon de livraison";
                                        chBonLivraisonAvoir.IsChecked = true;
                                        txtnVersement.IsEnabled = true;
                                        selectedparam = proxy.GetAllParamétre();

                                        if (selectedparam.AffichPrixAchatVente == true)
                                        {
                                            NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                        }
                                        else
                                        {
                                            NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                        }
                                        if (selectedparam.ModiPrix == true)
                                        {
                                            ReceptDatagrid.Columns[2].IsReadOnly = false;
                                        }
                                        else
                                        {
                                            ReceptDatagrid.Columns[2].IsReadOnly = true;
                                        }
                                        if (selectedparam.modidate == true)
                                        {
                                            txtDateOper.IsEnabled = true;
                                        }
                                        if (selectedparam.affiben == true)
                                        {
                                            Bénéfice.Visibility = Visibility.Visible;
                                            Bénéficemont.Visibility = Visibility.Visible;

                                        }
                                    }
                                    else
                                    {
                                        if (documenttype == 1)
                                        {
                                            NomDocumentLabel.Content = "Nouvelle Facture";
                                            chFacture.IsChecked = true;
                                            txtnVersement.IsEnabled = true;
                                            selectedparam = proxy.GetAllParamétre();

                                            if (selectedparam.AffichPrixAchatVente == true)
                                            {
                                                NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                            }
                                            else
                                            {
                                                NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                            }
                                            if (selectedparam.ModiPrix == true)
                                            {
                                                ReceptDatagrid.Columns[2].IsReadOnly = false;
                                            }
                                            else
                                            {
                                                ReceptDatagrid.Columns[2].IsReadOnly = true;
                                            }
                                            if (selectedparam.modidate == true)
                                            {
                                                txtDateOper.IsEnabled = true;
                                            }
                                            if (selectedparam.affiben == true)
                                            {
                                                Bénéfice.Visibility = Visibility.Visible;
                                                Bénéficemont.Visibility = Visibility.Visible;
                                                //   Bénéficemont.Text = Convert.ToString(((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                            }
                                        }
                                        else
                                        {
                                            if (documenttype == 2)
                                            {
                                                NomDocumentLabel.Content = "Facture d'avoir";
                                                chFactureAvoir.IsChecked = true;
                                                txtnVersement.IsEnabled = true;
                                                selectedparam = proxy.GetAllParamétre();

                                                if (selectedparam.AffichPrixAchatVente == true)
                                                {
                                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                                }
                                                else
                                                {
                                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                                }
                                                if (selectedparam.ModiPrix == true)
                                                {
                                                    ReceptDatagrid.Columns[2].IsReadOnly = false;
                                                }
                                                else
                                                {
                                                    ReceptDatagrid.Columns[2].IsReadOnly = true;
                                                }
                                                if (selectedparam.modidate == true)
                                                {
                                                    txtDateOper.IsEnabled = true;
                                                }
                                                if (selectedparam.affiben == true)
                                                {
                                                    Bénéfice.Visibility = Visibility.Visible;
                                                    Bénéficemont.Visibility = Visibility.Visible;

                                                }
                                            }
                                            else
                                            {
                                                if (documenttype == 6)
                                                {
                                                    NomDocumentLabel.Content = "Facture provisoir";
                                                    chFactureProvisoir.IsChecked = true;
                                                    txtnVersement.IsEnabled = true;



                                                    ReceptDatagrid.Columns[2].IsReadOnly = false;


                                                    txtDateOper.IsEnabled = true;


                                                }
                                                else
                                                {
                                                    if (documenttype == 5)
                                                    {
                                                        NomDocumentLabel.Content = "Nouvelle Proforma";
                                                        chProforma.IsChecked = true;
                                                        txtnVersement.IsEnabled = false;
                                                        ReceptDatagrid.Columns[2].IsReadOnly = false;


                                                        txtDateOper.IsEnabled = true;
                                                    }
                                                }

                                            }
                                        }
                                    }
                                }



                                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
                                nouveauF1 = new SVC.F1
                                {
                                    codeclient = Clientvv.Id,
                                    date = DateTime.Now,
                                    dates = DateTime.Now,
                                    raison = Clientvv.Raison,
                                    timbre = 0,
                                    echeance = 0,
                                    ht = 0,
                                    net = 0,
                                    oper = memberuser.Username,
                                    tva = 0,
                                    versement = 0,
                                    reste = 0,
                                    modep = "A TERME",
                                    remise = 0,
                                    Auto = true,
                                };
                                WindowBorderFacture.DataContext = nouveauF1;
                                dialog1.Close();
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void MenuItem_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (NomenclatureProduit.SelectedItem != null)
                {
                    SVC.Prodf selectedprodf = NomenclatureProduit.SelectedItem as SVC.Prodf;
                    var produit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedprodf.cp)).First();
                    ImageProduit cl = new ImageProduit(proxy, produit, memberuser, callback);
                    cl.Show();

                }
            }
            catch (Exception ex)
            {
                MessageBoxResult resultc1 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
        private void ConfirmerDocument1_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (memberuser.CreationDossierClient == true)
                {
                    if (facturenonstock != true)
                    {




                        string cle = "";
                        bool monture = false;
                        bool lentille = false;
                        decimal versementdossier = 0; decimal remise = 0;

                        if (interfacefacturation == 1)
                        {
                            creationstock();
                            cle = MontureClass.Cle;
                            monture = true;
                            lentille = false;
                            versementdossier = Convert.ToDecimal(MontureClass.Encaissé);
                            remise = Convert.ToDecimal(MontureClass.Remise);
                        }
                        else
                        {
                            
                                remise = 0;
                           
                        }


                        nouveauF1 = new SVC.F1
                        {
                            codeclient = Clientvv.Id,
                            date = DateTime.Now,
                            dates = DateTime.Now,
                            raison = Clientvv.Raison,
                            modep = "A TERME",
                            oper = memberuser.Username,
                            cleDossier = cle,
                            Monture = monture,
                            Lentille = lentille,
                            versement = versementdossier,
                            // ht= 0,
                            // net= 0,
                            /*  timbre = 0,
                              echeance = 0,
                              ht = 0,
                              net = 0,

                              tva = 0,
                              versement = 0,
                              reste = 0,
                              */
                            remise = remise,
                            Auto = false,
                        };
                        tsdffgent.IsSelected = true;

                        //    selectchanged();
                        WindowBorderFacture.DataContext = nouveauF1;
                        if (fermer == true)
                        {
                            txtnVersement.IsEnabled = true;
                            FacturationDesign();
                            ReceptDatagrid.DataContext = factureselectedl;
                            ReceptDatagrid.ItemsSource = factureselectedl;
                            ReceptDatagrid.IsEnabled = true;
                            txtTTC.Text = "0";
                            txtnfact.IsEnabled = false;


                            if (documenttype == 3)
                            {
                                NomDocumentLabel.Content = "bon de livraison";
                                chBonLivraison.IsChecked = true;
                                txtnVersement.IsEnabled = true;
                                selectedparam = proxy.GetAllParamétre();

                                if (selectedparam.AffichPrixAchatVente == true)
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                }
                                else
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                }
                                if (selectedparam.ModiPrix == true)
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = false;
                                }
                                else
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = true;
                                }
                                if (selectedparam.modidate == true)
                                {
                                    txtDateOper.IsEnabled = true;
                                }
                                if (selectedparam.affiben == true)
                                {
                                    Bénéfice.Visibility = Visibility.Visible;
                                    Bénéficemont.Visibility = Visibility.Visible;

                                }
                            }
                            else
                            {


                                if (documenttype == 1)
                                {
                                    NomDocumentLabel.Content = "Nouvelle Facture";
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = true;
                                    selectedparam = proxy.GetAllParamétre();

                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;
                                        //   Bénéficemont.Text = Convert.ToString(((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                    }
                                }
                                else
                                {
                                    if (documenttype == 5)
                                    {
                                        NomDocumentLabel.Content = "Nouvelle Proforma";
                                        chProforma.IsChecked = true;
                                        txtnVersement.IsEnabled = false;
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                        txtDateOper.IsEnabled = true;


                                    }
                                }
                            }



                            //    txtRemise.Text=remise.ToString();
                            ///    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(interfacefacturation.ToString(), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                            //    calculef1();
                            dialog1.Close();

                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un document de vente", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                        }
                    }
                    else
                    {



                        string cle = "";
                        bool monture = false;
                        bool lentille = false;
                        decimal versementdossier = 0; decimal remise = 0;

                        if (interfacefacturation == 1)
                        {
                            creationSansStock();
                            cle = MontureClass.Cle;
                            monture = true;
                            lentille = false;
                            versementdossier = Convert.ToDecimal(MontureClass.Encaissé);
                            remise = Convert.ToDecimal(MontureClass.Remise);
                        }
                        else
                        {
                           
                                remise = 0;
                       
                        }


                        nouveauF1 = new SVC.F1
                        {
                            codeclient = Clientvv.Id,
                            date = DateTime.Now,
                            dates = DateTime.Now,
                            raison = Clientvv.Raison,
                            modep = "A TERME",
                            oper = memberuser.Username,
                            cleDossier = cle,
                            Monture = monture,
                            Lentille = lentille,
                            versement = versementdossier,
                            // ht= 0,
                            // net= 0,
                            /*  timbre = 0,
                              echeance = 0,
                              ht = 0,
                              net = 0,

                              tva = 0,
                              versement = 0,
                              reste = 0,
                              */
                            remise = remise,
                            Auto = true,
                        };
                        tsdffgent.IsSelected = true;

                        //    selectchanged();
                        WindowBorderFacture.DataContext = nouveauF1;
                        if (fermer == true)
                        {
                            txtnVersement.IsEnabled = true;
                            FacturationDesignNonStock();
                            ReceptDatagrid.DataContext = factureselectedl;
                            ReceptDatagrid.ItemsSource = factureselectedl;
                            ReceptDatagrid.IsEnabled = true;
                            txtTTC.Text = "0";
                            txtnfact.IsEnabled = false;


                            if (documenttype == 3)
                            {
                                NomDocumentLabel.Content = "bon de livraison";
                                chBonLivraison.IsChecked = true;
                                txtnVersement.IsEnabled = true;
                                selectedparam = proxy.GetAllParamétre();

                                if (selectedparam.AffichPrixAchatVente == true)
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                }
                                else
                                {
                                    NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                }
                                if (selectedparam.ModiPrix == true)
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = false;
                                }
                                else
                                {
                                    ReceptDatagrid.Columns[2].IsReadOnly = true;
                                }
                                if (selectedparam.modidate == true)
                                {
                                    txtDateOper.IsEnabled = true;
                                }
                                if (selectedparam.affiben == true)
                                {
                                    Bénéfice.Visibility = Visibility.Visible;
                                    Bénéficemont.Visibility = Visibility.Visible;

                                }
                            }
                            else
                            {


                                if (documenttype == 1)
                                {
                                    NomDocumentLabel.Content = "Nouvelle Facture";
                                    chFacture.IsChecked = true;
                                    txtnVersement.IsEnabled = true;
                                    selectedparam = proxy.GetAllParamétre();

                                    if (selectedparam.AffichPrixAchatVente == true)
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Visible;
                                    }
                                    else
                                    {
                                        NomenclatureProduit.Columns[4].Visibility = Visibility.Collapsed;
                                    }
                                    if (selectedparam.ModiPrix == true)
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                    }
                                    else
                                    {
                                        ReceptDatagrid.Columns[2].IsReadOnly = true;
                                    }
                                    if (selectedparam.modidate == true)
                                    {
                                        txtDateOper.IsEnabled = true;
                                    }
                                    if (selectedparam.affiben == true)
                                    {
                                        Bénéfice.Visibility = Visibility.Visible;
                                        Bénéficemont.Visibility = Visibility.Visible;
                                        //   Bénéficemont.Text = Convert.ToString(((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((comptoircalcu.listcomptoir).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                    }
                                }
                                else
                                {
                                    if (documenttype == 5)
                                    {
                                        NomDocumentLabel.Content = "Nouvelle Proforma";
                                        chProforma.IsChecked = true;
                                        txtnVersement.IsEnabled = false;
                                        ReceptDatagrid.Columns[2].IsReadOnly = false;
                                        txtDateOper.IsEnabled = true;


                                    }
                                }
                            }



                            //    txtRemise.Text=remise.ToString();
                            ///    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(interfacefacturation.ToString(), NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Information);
                            //    calculef1();
                            dialog1.Close();

                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous devez choisir un document de vente", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        void creationSansStock()
        {
            try
            {
                factureselectedl = new List<SVC.Facture>();
                /****************************Accessoire 01***********************************/
                #region Accessoire1
                if (MontureClass.IdAccessoires1 != 0 && MontureClass.AccessoiresQuantite1 > 0)
                {
                    if (MontureClass.Accessoires1Statut == 0)
                    {
                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdAccessoires1)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            // cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            // lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.AccessoiresPrix1,
                            quantite = MontureClass.AccessoiresQuantite1,
                            Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,

                            ficheproduit = selectedtropuvé.Id,
                            //  ff = selectedtropuvé.nfact,
                            //Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {


                            found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                            found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;

                        }




                    }
                    else
                    {
                        if (MontureClass.Accessoires1Statut == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdAccessoires1)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdAccessoires1)).First();
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    //   cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //  lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    //   perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.AccessoiresPrix1,
                                    quantite = MontureClass.AccessoiresQuantite1,
                                    Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,
                                    ficheproduit = selectedtropuvé.Id,
                                    //  ff = selectedtropuvé.nfact,
                                    //   Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {
                                    factureselectedl.Add(facturevente);
                                }
                                else
                                {
                                    found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                                    found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;
                                }



                            }

                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.Accessoires1 + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }

                    }

                }
                #endregion

                /************************Accesoires 2****************************/
                #region Accessoires2
                if (MontureClass.IdAccessoires2 != 0 && MontureClass.AccessoiresQuantite2 > 0)
                {
                    if (MontureClass.Accessoires2Statut == 0)
                    {
                        // SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdAccessoires2)).First();
                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdAccessoires2)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();



                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //  cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            //  lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.AccessoiresPrix2,
                            quantite = MontureClass.AccessoiresQuantite2,
                            Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                            ficheproduit = selectedtropuvé.Id,
                            //     ff = selectedtropuvé.nfact,
                            //   Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {

                            found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                            found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;


                        }



                    }
                    else
                    {
                        if (MontureClass.Accessoires2Statut == 1)
                        {

                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdAccessoires2)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdAccessoires2)).First();

                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    //   cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //  lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    //  perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.AccessoiresPrix2,
                                    quantite = MontureClass.AccessoiresQuantite2,
                                    Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                                    ficheproduit = selectedtropuvé.Id,
                                    ///  ff = selectedtropuvé.nfact,
                                    //  Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                                    found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;


                                }





                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.Accessoires2 + " ce produit n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }
                    }
                }
                #endregion
                /*********************************Verre Loin droit*****************************/
                #region DroiteVerreLoin
                if (MontureClass.IdDroiteVerreLoin > 0)
                {
                    if (MontureClass.DroiteStatutLoinVerre == 0)
                    {

                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //   cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            //    lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.DroitPrixVerreLoin,
                            quantite = 1,
                            Total = MontureClass.DroitPrixVerreLoin * 1,
                            ficheproduit = selectedtropuvé.Id,
                            //   ff = selectedtropuvé.nfact,
                            //   Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {

                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;

                        }



                    }
                    if (MontureClass.DroiteStatutLoinVerre == 1)
                    {
                        var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).Any();

                        if (existeaccessoire1)
                        {
                            SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).First();

                            SVC.Facture facturevente = new SVC.Facture
                            {
                                cab = selectedtropuvé.cab,
                                //    cf = selectedtropuvé.cf,
                                codeprod = selectedtropuvé.Id,
                                dates = DateTime.Now,
                                datef = DateTime.Now,
                                design = selectedtropuvé.design,
                                // lot = selectedtropuvé.lot,
                                oper = memberuser.Username,
                                //   perempt = selectedtropuvé.perempt,
                                tva = 0,
                                previent = selectedtropuvé.PrixRevient,
                                privente = MontureClass.DroitPrixVerreLoin,
                                quantite = 1,
                                Total = MontureClass.DroitPrixVerreLoin * 1,
                                ficheproduit = selectedtropuvé.Id,
                                //   ff = selectedtropuvé.nfact,
                                //  Fournisseur = selectedtropuvé.fourn,
                                codeclient = Clientvv.Id,
                                Client = Clientvv.Raison,
                                collisage = 1,
                                Auto = true,
                            };
                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                            if (found == null)
                            {

                                factureselectedl.Add(facturevente);

                            }
                            else
                            {

                                found.quantite = found.quantite + 1;
                                found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;

                            }



                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.DroiteVerreLoinDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                        }
                    }
                }
                #endregion
                #region GaucheVerreLoin
                if (MontureClass.IdGaucheVerreLoin > 0)
                {
                    if (MontureClass.GaucheStatutLoinVerre == 0)
                    {

                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            // cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            // lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //   perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.GauchePrixVerreLoin,
                            quantite = 1,
                            Total = MontureClass.GauchePrixVerreLoin * 1,
                            ficheproduit = selectedtropuvé.Id,
                            //   ff = selectedtropuvé.nfact,
                            //  Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {
                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                        }



                    }
                    else
                    {
                        if (MontureClass.GaucheStatutLoinVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).First();

                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    //    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //      lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    //  perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.GauchePrixVerreLoin,
                                    quantite = 1,
                                    Total = MontureClass.GauchePrixVerreLoin * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    //  ff = selectedtropuvé.nfact,
                                    //   Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                                }



                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.GaucheVerreLoinDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }
                    }
                }
                #endregion
                /**********************************************MontureLoin*********************/
                #region MontureLoin
                if (MontureClass.IdMontureLoin > 0)
                {
                    if (MontureClass.DroiteStatutLoinMonture == 0)
                    {

                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdMontureLoin)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //   cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            // lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //    perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.PrixMontureLoin,
                            quantite = 1,
                            Total = MontureClass.PrixMontureLoin * 1,
                            ficheproduit = selectedtropuvé.Id,
                            // ff = selectedtropuvé.nfact,
                            // Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            Auto = true,
                            collisage = 1,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {

                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                        }



                    }
                    if (MontureClass.DroiteStatutLoinMonture == 1)
                    {
                        var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdMontureLoin)).Any();

                        if (existeaccessoire1)
                        {
                            SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdMontureLoin)).First();

                            SVC.Facture facturevente = new SVC.Facture
                            {
                                cab = selectedtropuvé.cab,
                                //   cf = selectedtropuvé.cf,
                                codeprod = selectedtropuvé.Id,
                                dates = DateTime.Now,
                                datef = DateTime.Now,
                                design = selectedtropuvé.design,
                                // lot = selectedtropuvé.lot,
                                oper = memberuser.Username,
                                //   perempt = selectedtropuvé.perempt,
                                tva = 0,
                                previent = selectedtropuvé.PrixRevient,
                                privente = MontureClass.PrixMontureLoin,
                                quantite = 1,
                                Total = MontureClass.PrixMontureLoin * 1,
                                ficheproduit = selectedtropuvé.Id,
                                //   ff = selectedtropuvé.nfact,
                                //   Fournisseur = selectedtropuvé.fourn,
                                codeclient = Clientvv.Id,
                                Client = Clientvv.Raison,
                                collisage = 1,
                                Auto = true,
                            };
                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                            if (found == null)
                            {

                                factureselectedl.Add(facturevente);

                            }
                            else
                            {

                                found.quantite = found.quantite + 1;
                                found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                            }



                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.MontureDesignationLoin + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                        }
                    }
                }
                #endregion
                /*******************************DroiteVerre Pres*************************/
                #region DroiteVERREPRESS
                if (MontureClass.IdDroiteVerrePres > 0)
                {
                    if (MontureClass.DroiteStatutPresVerre == 0)
                    {


                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //   cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            //  lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.DroitPrixVerrePres,
                            quantite = 1,
                            Total = MontureClass.DroitPrixVerrePres * 1,
                            ficheproduit = selectedtropuvé.Id,
                            //   ff = selectedtropuvé.nfact,
                            //   Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {

                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;


                        }



                    }
                    else
                    {
                        if (MontureClass.DroiteStatutPresVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).First();

                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    // cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //   lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    // perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.DroitPrixVerrePres,
                                    quantite = 1,
                                    Total = MontureClass.DroitPrixVerrePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    //   ff = selectedtropuvé.nfact,
                                    //   Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;


                                }



                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.DroiteVerrePresDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                            }
                        }
                    }
                }
                #endregion
                /****************************************Gauche verre pres**********///////
                #region GaucheVerrePres
                if (MontureClass.IdGaucheVerrePres > 0)
                {
                    if (MontureClass.GaucheStatutPresVerre == 0)
                    {

                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //   cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            //  lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.GauchePrixVerrePres,
                            quantite = 1,
                            Total = MontureClass.GauchePrixVerrePres * 1,
                            ficheproduit = selectedtropuvé.Id,
                            // ff = selectedtropuvé.nfact,
                            // Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {
                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                        }



                    }
                    else
                    {
                        if (MontureClass.GaucheStatutPresVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).First();

                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    //  cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //  lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    //  perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.GauchePrixVerrePres,
                                    quantite = 1,
                                    Total = MontureClass.GauchePrixVerrePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    //   ff = selectedtropuvé.nfact,
                                    //    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                                }



                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.GaucheVerrePresDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                            }
                        }
                    }
                }
                #endregion
                /********************************Monture Pres**************************/
                #region MonturePres
                if (MontureClass.IdMonturePres > 0)
                {
                    if (MontureClass.DroiteStatutPresMonture == 0)
                    {

                        SVC.Prodf selectedtropuvé1 = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdMonturePres)).First();
                        SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé1.cp)).First();

                        SVC.Facture facturevente = new SVC.Facture
                        {
                            cab = selectedtropuvé.cab,
                            //  cf = selectedtropuvé.cf,
                            codeprod = selectedtropuvé.Id,
                            dates = DateTime.Now,
                            datef = DateTime.Now,
                            design = selectedtropuvé.design,
                            //  lot = selectedtropuvé.lot,
                            oper = memberuser.Username,
                            //  perempt = selectedtropuvé.perempt,
                            tva = 0,
                            previent = selectedtropuvé.PrixRevient,
                            privente = MontureClass.PrixMonturePres,
                            quantite = 1,
                            Total = MontureClass.PrixMonturePres * 1,
                            ficheproduit = selectedtropuvé.Id,
                            //   ff = selectedtropuvé.nfact,
                            //Fournisseur = selectedtropuvé.fourn,
                            codeclient = Clientvv.Id,
                            Client = Clientvv.Raison,
                            collisage = 1,
                            Auto = true,
                        };
                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                        if (found == null)
                        {

                            factureselectedl.Add(facturevente);

                        }
                        else
                        {
                            found.quantite = found.quantite + 1;
                            found.Total = found.Total + 1 * MontureClass.PrixMonturePres;
                        }


                    }
                    else
                    {
                        if (MontureClass.DroiteStatutPresMonture == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdMonturePres)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Produit selectedtropuvé = proxy.GetAllProduitbyid(Convert.ToInt32(MontureClass.IdMonturePres)).First();

                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    //    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.Id,
                                    dates = DateTime.Now,
                                    datef = DateTime.Now,
                                    design = selectedtropuvé.design,
                                    //  lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    //    perempt = selectedtropuvé.perempt,
                                    tva = 0,
                                    previent = selectedtropuvé.PrixRevient,
                                    privente = MontureClass.PrixMonturePres,
                                    quantite = 1,
                                    Total = MontureClass.PrixMonturePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    // ff = selectedtropuvé.nfact,
                                    //   Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = 1,
                                    Auto = true,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.PrixMonturePres;
                                }



                            }
                        }
                    }
                }
                #endregion

                ReceptDatagrid.ItemsSource = factureselectedl;
                ReceptDatagrid.DataContext = factureselectedl;

                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        void creationstock()
        {
            try
            {
                factureselectedl = new List<SVC.Facture>();
                /****************************Accessoire 01***********************************/
                #region Accessoire1
                if (MontureClass.IdAccessoires1 != 0 && MontureClass.AccessoiresQuantite1 > 0)
                {
                    if (MontureClass.Accessoires1Statut == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdAccessoires1)).First();
                        if (selectedtropuvé.quantite > 0 && selectedtropuvé.quantite >= MontureClass.AccessoiresQuantite1)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.AccessoiresPrix1,
                                        quantite = MontureClass.AccessoiresQuantite1,
                                        Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {


                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                                        found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;



                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.AccessoiresPrix1,
                                    quantite = MontureClass.AccessoiresQuantite1,
                                    Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,

                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {


                                    found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                                    found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;

                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                        }
                    }
                    else
                    {
                        if (MontureClass.Accessoires1Statut == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdAccessoires1)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Prodf selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdAccessoires1)).First();
                                if (selectedtropuvé.quantite > 0 && selectedtropuvé.quantite >= MontureClass.AccessoiresQuantite1)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.AccessoiresPrix1,
                                                quantite = MontureClass.AccessoiresQuantite1,
                                                Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {
                                                factureselectedl.Add(facturevente);
                                            }
                                            else
                                            {
                                                found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                                                found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;
                                            }


                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.AccessoiresPrix1,
                                            quantite = MontureClass.AccessoiresQuantite1,
                                            Total = MontureClass.AccessoiresPrix1 * MontureClass.AccessoiresQuantite1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,
                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {
                                            factureselectedl.Add(facturevente);
                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + MontureClass.AccessoiresQuantite1;
                                            found.Total = found.Total + MontureClass.AccessoiresQuantite1 * MontureClass.AccessoiresPrix1;
                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }

                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.Accessoires1 + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }

                    }

                }
                #endregion
                /************************Accesoires 2****************************/
                #region Accessoires2
                if (MontureClass.IdAccessoires2 != 0 && MontureClass.AccessoiresQuantite2 > 0)
                {
                    if (MontureClass.Accessoires2Statut == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdAccessoires2)).First();
                        if (selectedtropuvé.quantite > 0 && selectedtropuvé.quantite >= MontureClass.AccessoiresQuantite2)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.AccessoiresPrix2,
                                        quantite = MontureClass.AccessoiresQuantite2,
                                        Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {


                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {


                                        found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                                        found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;






                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.AccessoiresPrix2,
                                    quantite = MontureClass.AccessoiresQuantite2,
                                    Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                                    found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;


                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    else
                    {
                        if (MontureClass.Accessoires2Statut == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdAccessoires2)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Prodf selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdAccessoires2)).First();
                                if (selectedtropuvé.quantite > 0 && selectedtropuvé.quantite >= MontureClass.AccessoiresQuantite2)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.AccessoiresPrix2,
                                                quantite = MontureClass.AccessoiresQuantite2,
                                                Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {


                                                factureselectedl.Add(facturevente);

                                            }
                                            else
                                            {


                                                found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                                                found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;






                                            }


                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.AccessoiresPrix2,
                                            quantite = MontureClass.AccessoiresQuantite2,
                                            Total = MontureClass.AccessoiresPrix2 * MontureClass.AccessoiresQuantite2,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {

                                            found.quantite = found.quantite + MontureClass.AccessoiresQuantite2;
                                            found.Total = found.Total + MontureClass.AccessoiresQuantite2 * MontureClass.AccessoiresPrix2;


                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }

                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.Accessoires2 + " ce produit n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }
                    }
                }
                #endregion
                /*********************************Verre Loin droit*****************************/
                #region DroiteVerreLoin
                if (MontureClass.IdDroiteVerreLoin > 0)
                {
                    if (MontureClass.DroiteStatutLoinVerre == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).First();
                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.DroitPrixVerreLoin,
                                        quantite = 1,
                                        Total = MontureClass.DroitPrixVerreLoin * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {
                                        factureselectedl.Add(facturevente);
                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;
                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.DroitPrixVerreLoin,
                                    quantite = 1,
                                    Total = MontureClass.DroitPrixVerreLoin * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;

                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    if (MontureClass.DroiteStatutLoinVerre == 1)
                    {
                        var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).Any();

                        if (existeaccessoire1)
                        {
                            SVC.Prodf selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdDroiteVerreLoin)).First();
                            if (selectedtropuvé.quantite > 0)
                            {
                                if (selectedtropuvé.perempt != null)
                                {
                                    if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.DroitPrixVerreLoin,
                                            quantite = 1,
                                            Total = MontureClass.DroitPrixVerreLoin * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,
                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {
                                            factureselectedl.Add(facturevente);
                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;
                                        }


                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                    }
                                }
                                else
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.DroitPrixVerreLoin,
                                        quantite = 1,
                                        Total = MontureClass.DroitPrixVerreLoin * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,

                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {

                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {

                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.DroitPrixVerreLoin;

                                    }


                                }
                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.DroiteVerreLoinDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                        }
                    }
                }
                #endregion
                /****************************Gauche verre loin********************/
                #region GaucheVerreLoin
                if (MontureClass.IdGaucheVerreLoin > 0)
                {
                    if (MontureClass.GaucheStatutLoinVerre == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).First();

                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.GauchePrixVerreLoin,
                                        quantite = 1,
                                        Total = MontureClass.GauchePrixVerreLoin * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,

                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {
                                        factureselectedl.Add(facturevente);
                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.GauchePrixVerreLoin,
                                    quantite = 1,
                                    Total = MontureClass.GauchePrixVerreLoin * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    else
                    {
                        if (MontureClass.GaucheStatutLoinVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Prodf selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdGaucheVerreLoin)).First();
                                if (selectedtropuvé.quantite > 0)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.GauchePrixVerreLoin,
                                                quantite = 1,
                                                Total = MontureClass.GauchePrixVerreLoin * 1,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                collisage = selectedtropuvé.collisage,
                                                Client = Clientvv.Raison,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {
                                                factureselectedl.Add(facturevente);
                                            }
                                            else
                                            {
                                                found.quantite = found.quantite + 1;
                                                found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                                            }


                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.GauchePrixVerreLoin,
                                            quantite = 1,
                                            Total = MontureClass.GauchePrixVerreLoin * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.GauchePrixVerreLoin;
                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.GaucheVerreLoinDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                            }
                        }
                    }
                }
                #endregion
                /**********************************************MontureLoin*********************/
                #region MontureLoin
                if (MontureClass.IdMontureLoin > 0)
                {
                    if (MontureClass.DroiteStatutLoinMonture == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdMontureLoin)).First();
                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.PrixMontureLoin,
                                        quantite = 1,
                                        Total = MontureClass.PrixMontureLoin * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {


                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.PrixMontureLoin,
                                    quantite = 1,
                                    Total = MontureClass.PrixMontureLoin * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,

                                    collisage = selectedtropuvé.collisage,
                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    if (MontureClass.DroiteStatutLoinMonture == 1)
                    {
                        var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdMontureLoin)).Any();

                        if (existeaccessoire1)
                        {
                            var selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdMontureLoin)).Where(n => n.quantite != 0).First();
                            if (selectedtropuvé.quantite > 0)
                            {
                                if (selectedtropuvé.perempt != null)
                                {
                                    if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.PrixMontureLoin,
                                            quantite = 1,
                                            Total = MontureClass.PrixMontureLoin * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,
                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {


                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                                        }


                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                    }
                                }
                                else
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.PrixMontureLoin,
                                        quantite = 1,
                                        Total = MontureClass.PrixMontureLoin * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,

                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {

                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {

                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.PrixMontureLoin;

                                    }


                                }
                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.MontureDesignationLoin + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Exclamation);

                        }
                    }
                }
                #endregion
                /*******************************DroiteVerre Pres*************************/
                #region DroiteVERREPRESS
                if (MontureClass.IdDroiteVerrePres > 0)
                {
                    if (MontureClass.DroiteStatutPresVerre == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).First();
                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.DroitPrixVerrePres,
                                        quantite = 1,
                                        Total = MontureClass.DroitPrixVerrePres * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {


                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;

                                    }

                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.DroitPrixVerrePres,
                                    quantite = 1,
                                    Total = MontureClass.DroitPrixVerrePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {

                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;


                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    else
                    {
                        if (MontureClass.DroiteStatutPresVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).Any();

                            if (existeaccessoire1)
                            {
                                var selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdDroiteVerrePres)).Where(n => n.quantite != 0).First();
                                if (selectedtropuvé.quantite > 0)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.DroitPrixVerrePres,
                                                quantite = 1,
                                                Total = MontureClass.DroitPrixVerrePres * 1,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {


                                                factureselectedl.Add(facturevente);

                                            }
                                            else
                                            {
                                                found.quantite = found.quantite + 1;
                                                found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;

                                            }

                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.DroitPrixVerrePres,
                                            quantite = 1,
                                            Total = MontureClass.DroitPrixVerrePres * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {

                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.DroitPrixVerrePres;


                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.DroiteVerrePresDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                            }
                        }
                    }
                }
                #endregion
                /****************************************Gauche verre pres**********///////
                #region GaucheVerrePres
                if (MontureClass.IdGaucheVerrePres > 0)
                {
                    if (MontureClass.GaucheStatutPresVerre == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).First();
                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.GauchePrixVerrePres,
                                        quantite = 1,
                                        Total = MontureClass.GauchePrixVerrePres * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {
                                        factureselectedl.Add(facturevente);
                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.GauchePrixVerrePres,
                                    quantite = 1,
                                    Total = MontureClass.GauchePrixVerrePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    else
                    {
                        if (MontureClass.GaucheStatutPresVerre == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).Any();

                            if (existeaccessoire1)
                            {
                                var selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdGaucheVerrePres)).Where(n => n.quantite != 0).First();
                                if (selectedtropuvé.quantite > 0)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.GauchePrixVerrePres,
                                                quantite = 1,
                                                Total = MontureClass.GauchePrixVerrePres * 1,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {
                                                factureselectedl.Add(facturevente);
                                            }
                                            else
                                            {
                                                found.quantite = found.quantite + 1;
                                                found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                                            }


                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.GauchePrixVerrePres,
                                            quantite = 1,
                                            Total = MontureClass.GauchePrixVerrePres * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.GauchePrixVerrePres;
                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(MontureClass.GaucheVerrePresDesignation + " n'existe pas dans le stock vente impossible", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                            }
                        }
                    }
                }
                #endregion
                /********************************Monture Pres**************************/
                #region MonturePres
                if (MontureClass.IdMonturePres > 0)
                {
                    if (MontureClass.DroiteStatutPresMonture == 0)
                    {
                        SVC.Prodf selectedtropuvé = proxy.GetAllProdfbyfiche(Convert.ToInt32(MontureClass.IdMonturePres)).First();
                        if (selectedtropuvé.quantite > 0)
                        {
                            if (selectedtropuvé.perempt != null)
                            {
                                if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        dates = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = MontureClass.PrixMonturePres,
                                        quantite = 1,
                                        Total = MontureClass.PrixMonturePres * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        codeclient = Clientvv.Id,
                                        Client = Clientvv.Raison,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {


                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + 1 * MontureClass.PrixMonturePres;

                                    }


                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                            else
                            {
                                SVC.Facture facturevente = new SVC.Facture
                                {
                                    cab = selectedtropuvé.cab,
                                    cf = selectedtropuvé.cf,
                                    codeprod = selectedtropuvé.cp,
                                    dates = DateTime.Now,
                                    datef = selectedtropuvé.datef,
                                    design = selectedtropuvé.design,
                                    lot = selectedtropuvé.lot,
                                    oper = memberuser.Username,
                                    perempt = selectedtropuvé.perempt,
                                    tva = selectedtropuvé.tva,
                                    previent = selectedtropuvé.previent,
                                    privente = MontureClass.PrixMonturePres,
                                    quantite = 1,
                                    Total = MontureClass.PrixMonturePres * 1,
                                    ficheproduit = selectedtropuvé.Id,
                                    ff = selectedtropuvé.nfact,
                                    Fournisseur = selectedtropuvé.fourn,
                                    codeclient = Clientvv.Id,
                                    Client = Clientvv.Raison,
                                    collisage = selectedtropuvé.collisage,

                                };
                                var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                if (found == null)
                                {

                                    factureselectedl.Add(facturevente);

                                }
                                else
                                {
                                    found.quantite = found.quantite + 1;
                                    found.Total = found.Total + 1 * MontureClass.PrixMonturePres;
                                }


                            }
                        }
                        else
                        {
                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                        }
                    }
                    else
                    {
                        if (MontureClass.DroiteStatutPresMonture == 1)
                        {
                            var existeaccessoire1 = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdMonturePres)).Any();

                            if (existeaccessoire1)
                            {
                                SVC.Prodf selectedtropuvé = proxy.GetAllProdfbycode(Convert.ToInt32(MontureClass.IdMonturePres)).First();
                                if (selectedtropuvé.quantite > 0)
                                {
                                    if (selectedtropuvé.perempt != null)
                                    {
                                        if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))
                                        {
                                            SVC.Facture facturevente = new SVC.Facture
                                            {
                                                cab = selectedtropuvé.cab,
                                                cf = selectedtropuvé.cf,
                                                codeprod = selectedtropuvé.cp,
                                                dates = DateTime.Now,
                                                datef = selectedtropuvé.datef,
                                                design = selectedtropuvé.design,
                                                lot = selectedtropuvé.lot,
                                                oper = memberuser.Username,
                                                perempt = selectedtropuvé.perempt,
                                                tva = selectedtropuvé.tva,
                                                previent = selectedtropuvé.previent,
                                                privente = MontureClass.PrixMonturePres,
                                                quantite = 1,
                                                Total = MontureClass.PrixMonturePres * 1,
                                                ficheproduit = selectedtropuvé.Id,
                                                ff = selectedtropuvé.nfact,
                                                Fournisseur = selectedtropuvé.fourn,
                                                codeclient = Clientvv.Id,
                                                Client = Clientvv.Raison,
                                                collisage = selectedtropuvé.collisage,
                                            };
                                            var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                            if (found == null)
                                            {


                                                factureselectedl.Add(facturevente);

                                            }
                                            else
                                            {
                                                found.quantite = found.quantite + 1;
                                                found.Total = found.Total + 1 * MontureClass.PrixMonturePres;

                                            }


                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Ce produit est interdit en vente date de péremption proche", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                    else
                                    {
                                        SVC.Facture facturevente = new SVC.Facture
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            codeprod = selectedtropuvé.cp,
                                            dates = DateTime.Now,
                                            datef = selectedtropuvé.datef,
                                            design = selectedtropuvé.design,
                                            lot = selectedtropuvé.lot,
                                            oper = memberuser.Username,
                                            perempt = selectedtropuvé.perempt,
                                            tva = selectedtropuvé.tva,
                                            previent = selectedtropuvé.previent,
                                            privente = MontureClass.PrixMonturePres,
                                            quantite = 1,
                                            Total = MontureClass.PrixMonturePres * 1,
                                            ficheproduit = selectedtropuvé.Id,
                                            ff = selectedtropuvé.nfact,
                                            Fournisseur = selectedtropuvé.fourn,
                                            codeclient = Clientvv.Id,
                                            Client = Clientvv.Raison,
                                            collisage = selectedtropuvé.collisage,

                                        };
                                        var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                        if (found == null)
                                        {

                                            factureselectedl.Add(facturevente);

                                        }
                                        else
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + 1 * MontureClass.PrixMonturePres;
                                        }


                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Le produit " + selectedtropuvé.design + " avec quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                        }
                    }
                }
                #endregion
                ReceptDatagrid.ItemsSource = factureselectedl;
                ReceptDatagrid.DataContext = factureselectedl;

                CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void NomenclatureProduit_MouseRightButtonUp(object sender, MouseButtonEventArgs e)
        {
            if (facturenonstock != true)
            {
                NomenclatureProduit.ItemsSource = proxy.GetAllProdf().OrderBy(n => n.design);
            }
            else
            {
                NomenclatureProduit.ItemsSource = proxy.GetAllProduit().OrderBy(n => n.design);
            }
        }
        private string getCurrentCellValue(TextBox txtCurCell)
        {
            return txtCurCell.Text;
        }
        private void ReceptDatagrid_CellEditEnding(object sender, DataGridCellEditEndingEventArgs e)
        {
            try
            {
                if (facturenonstock == false)
                {
                    int col1 = e.Column.DisplayIndex;
                    //int row1 = Convert.ToInt32(e.Row.Header);
                    if (getCurrentCellValue((TextBox)e.EditingElement) == "" && (col1 == 2 || col1 == 3 || col1 == 4))
                    {
                        var el = e.EditingElement as TextBox;
                        el.Text = "0.00";
                        e.Cancel = true;
                        //   CONFIRMERVENTE.IsEnabled = false;
                        // MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous ne pouvez pas laisser les champs vide,", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                    }
                    else
                    {
                        CONFIRMERVENTE.IsEnabled = true;
                    }

                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;
                    var testprodf = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;
                    //var testprodf = selectedtropuvé;
                    if (ReceptDatagrid.SelectedItem != null && testprodf.Count() > 0)
                    {
                        SVC.Facture selectedrecept = ReceptDatagrid.SelectedItem as SVC.Facture;
                        //  SVC.Prodf objectmodifed = (testprodf.ToList()).Find(n => n.Id == selectedrecept.ficheproduit);
                        SVC.Prodf objectmodifed = selectedtropuvé;



                        NomenclatureProduit.SelectedItem = objectmodifed;
                        if (getCurrentCellValue((TextBox)e.EditingElement) != "" && (col1 == 3) && facturenew == true && facturemodif == false)
                        {
                            if (documenttype == 1 || documenttype == 3)
                            {
                                var el = e.EditingElement as TextBox;
                                if (Convert.ToDecimal(el.Text) > objectmodifed.quantite)
                                {
                                    el.Text = "0.00";
                                    // e.Cancel = true;
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantite insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                }
                            }
                        }
                        else
                        {
                            if (getCurrentCellValue((TextBox)e.EditingElement) != "" && (col1 == 3) && facturenew == false && facturemodif == true)
                            {
                                if (documenttype == 1 || documenttype == 3)
                                {
                                    var el = e.EditingElement as TextBox;

                                    bool found = (anciennefactureselectedl.ToList()).Any(n => n.Id == selectedrecept.Id);

                                    if (found == true)
                                    {
                                        SVC.Facture ancienfacturemodifed = (anciennefactureselectedl.ToList()).Find(n => n.Id == selectedrecept.Id);

                                        if (objectmodifed.quantite < Convert.ToDecimal(el.Text) - ancienfacturemodifed.quantite)
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantite insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                            el.Text = Convert.ToString(ancienfacturemodifed.quantite);
                                        }
                                    }
                                    else
                                    {
                                        if (Convert.ToDecimal(el.Text) > objectmodifed.quantite)
                                        {
                                            el.Text = "0.00";
                                            // e.Cancel = true;
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantite insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }
                                    }
                                }
                                else
                                {
                                    if (documenttype == 2 || documenttype == 4)
                                    {
                                        var el = e.EditingElement as TextBox;
                                        bool found = (anciennefactureselectedl.ToList()).Any(n => n.Id == selectedrecept.Id);
                                        if (found)
                                        {
                                            SVC.Facture ancienfacturemodifed = (anciennefactureselectedl.ToList()).Find(n => n.Id == selectedrecept.Id);
                                            if (objectmodifed.quantite < ancienfacturemodifed.quantite - Convert.ToDecimal(el.Text))
                                            {
                                                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantite insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                                                el.Text = Convert.ToString(ancienfacturemodifed.quantite);
                                            }
                                        }

                                    }
                                }

                            }
                        }
                    }

                    try
                    {



                        foreach (var item in test)
                        {
                            item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                        }






                        if (documenttype == 2 || documenttype == 4)
                        {
                            var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                            string strht = string.Format("{0:0.00}", ht);
                            txtht.Text = strht;
                            //////////////////////////////////
                            var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                            string strtva = string.Format("{0:0.00}", tva);
                            txttva.Text = strtva;
                            /////////////////////////////////
                            var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                            string strttc = string.Format("{0:0.00}", ttc);
                            txtTTC.Text = strttc;

                            decimal timbre = 0;
                            decimal remise = 0;
                            decimal avecremise = 0;
                            decimal Benf = 0;
                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) > 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                    else
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) < 0)
                                        {
                                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                            remise = -Convert.ToDecimal(txtRemise.Text);
                                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                        }
                                    }
                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    remise = 0;
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }

                            if (tunisie != true)
                            {
                                if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                {
                                    //   var timbres = (avecremise * 1 / 100);
                                    timbre = (avecremise * 1 / 100);

                                    if (timbre > 2500)
                                    {
                                        timbre = 2500;
                                    }
                                    string strtimbre = string.Format("{0:0.00}", -timbre);

                                    txtTimbre.Text = strtimbre;
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);

                                }
                            }
                            else
                            {
                                if (chFactureAvoir.IsChecked == true)
                                {
                                    timbre = -Convert.ToDecimal(0.6);
                                    txtTimbre.Text = Convert.ToString(-timbre);
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                            }
                            var Net = (-(avecremise + timbre));
                            string strNet = string.Format("{0:0.00}", Net);
                            txtNet.Text = strNet;
                            Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                        }
                        else
                        {
                            var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                            string strht = string.Format("{0:0.00}", ht);
                            txtht.Text = strht;
                            //////////////////////////////////
                            var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                            string strtva = string.Format("{0:0.00}", tva);
                            txttva.Text = strtva;
                            /////////////////////////////////
                            var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                            string strttc = string.Format("{0:0.00}", ttc);
                            txtTTC.Text = strttc;

                            decimal timbre = 0;
                            decimal remise = 0;
                            decimal avecremise = 0;
                            decimal Benf = 0;
                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    remise = 0;
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                            if (tunisie != true)
                            {
                                if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                                {

                                    // var timbres = (avecremise * 1 / 100);

                                    timbre = (avecremise * 1 / 100);
                                    if (timbre > 2500)
                                    {
                                        timbre = 2500;
                                    }
                                    string strtimbre = string.Format("{0:0.00}", timbre);
                                    txtTimbre.Text = strtimbre;
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);

                                }
                            }
                            else
                            {
                                if (chFacture.IsChecked == true)
                                {
                                    timbre = Convert.ToDecimal(0.6);
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                            }
                            var Net = ((avecremise + timbre));
                            string strNet = string.Format("{0:0.00}", Net);
                            txtNet.Text = strNet;

                            Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                        }





                        ReceptDatagrid.ItemsSource = test;


                    }
                    catch (Exception ex)
                    {
                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                    }
                }
                else
                {
                    int col1 = e.Column.DisplayIndex;
                    //int row1 = Convert.ToInt32(e.Row.Header);
                    if (getCurrentCellValue((TextBox)e.EditingElement) == "" && (col1 == 2 || col1 == 3 || col1 == 4))
                    {
                        var el = e.EditingElement as TextBox;
                        el.Text = "0.00";
                        e.Cancel = true;
                        //   CONFIRMERVENTE.IsEnabled = false;
                        // MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Vous ne pouvez pas laisser les champs vide,", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                    }
                    else
                    {
                        CONFIRMERVENTE.IsEnabled = true;
                    }

                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;


                    try
                    {



                        foreach (var item in test)
                        {
                            item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                        }






                        if (documenttype == 2 || documenttype == 4)
                        {
                            var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                            string strht = string.Format("{0:0.00}", ht);
                            txtht.Text = strht;
                            //////////////////////////////////
                            var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                            string strtva = string.Format("{0:0.00}", tva);
                            txttva.Text = strtva;
                            /////////////////////////////////
                            var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                            string strttc = string.Format("{0:0.00}", ttc);
                            txtTTC.Text = strttc;

                            decimal timbre = 0;
                            decimal remise = 0;
                            decimal avecremise = 0;
                            decimal Benf = 0;
                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) > 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                        remise = Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                    else
                                    {
                                        if (Convert.ToDecimal(txtRemise.Text) < 0)
                                        {
                                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                            remise = -Convert.ToDecimal(txtRemise.Text);
                                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                        }
                                    }
                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    remise = 0;
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }

                            if (tunisie != true)
                            {
                                if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                                {
                                    // var timbres = (avecremise * 1 / 100);
                                    timbre = (avecremise * 1 / 100);

                                    if (timbre > 2500)
                                    {
                                        timbre = 2500;
                                    }
                                    string strtimbre = string.Format("{0:0.00}", -timbre);
                                    txtTimbre.Text = strtimbre;
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);

                                }
                            }
                            else
                            {
                                if (chFactureAvoir.IsChecked == true)
                                {
                                    timbre = -Convert.ToDecimal(0.6);
                                    txtTimbre.Text = Convert.ToString(-timbre);
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                            }
                            var Net = (-(avecremise + timbre));
                            string strNet = string.Format("{0:0.00}", Net);
                            txtNet.Text = strNet;
                            Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                        }
                        else
                        {
                            var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                            string strht = string.Format("{0:0.00}", ht);
                            txtht.Text = strht;
                            //////////////////////////////////
                            var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                            string strtva = string.Format("{0:0.00}", tva);
                            txttva.Text = strtva;
                            /////////////////////////////////
                            var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                            string strttc = string.Format("{0:0.00}", ttc);
                            txtTTC.Text = strttc;

                            decimal timbre = 0;
                            decimal remise = 0;
                            decimal avecremise = 0;
                            decimal Benf = 0;
                            if (txtRemise.Text != "")
                            {
                                if (Convert.ToDecimal(txtRemise.Text) != 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                                }
                                else
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                    remise = 0;
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                            if (tunisie != true)
                            {
                                if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                                {

                                    //  var timbres = (avecremise * 1 / 100);
                                    timbre = (avecremise * 1 / 100);
                                    if (timbre > 2500)
                                    {
                                        timbre = 2500;
                                    }
                                    string strtimbre = string.Format("{0:0.00}", timbre);
                                    txtTimbre.Text = strtimbre;

                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);

                                }
                            }
                            else
                            {
                                if (chFacture.IsChecked == true)
                                {
                                    timbre = Convert.ToDecimal(0.6);
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                                else
                                {
                                    timbre = 0;
                                    txtTimbre.Text = Convert.ToString(timbre);
                                }
                            }
                            var Net = ((avecremise + timbre));
                            string strNet = string.Format("{0:0.00}", Net);
                            txtNet.Text = strNet;

                            Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                        }





                        ReceptDatagrid.ItemsSource = test;


                    }
                    catch (Exception ex)
                    {
                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void ReceptDatagrid_CurrentCellChanged(object sender, EventArgs e)
        {
            try
            {
                if (facturenonstock == false)
                {
                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;
                    var testprodf = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;


                    if (ReceptDatagrid.SelectedItem != null && testprodf.Count() > 0)
                    {
                        SVC.Facture selectedrecept = ReceptDatagrid.SelectedItem as SVC.Facture;
                        //  SVC.Prodf objectmodifed = (testprodf.ToList()).Find(n => n.Id == selectedrecept.ficheproduit);

                        SVC.Prodf objectmodifed = selectedtropuvé;



                        NomenclatureProduit.SelectedItem = objectmodifed;

                    }

                    foreach (var item in test)
                    {
                        item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                    }
                    if (documenttype == 2 || documenttype == 4)
                    {
                        var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                if (Convert.ToDecimal(txtRemise.Text) > 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                else
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) < 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                        remise = -Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                            {
                                // var timbres = (avecremise * 1 / 100);
                                timbre = (avecremise * 1 / 100);

                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", -timbre);
                                txtTimbre.Text = strtimbre;
                                /* timbre = (avecremise * 1 / 100);
                                 txtTimbre.Text = Convert.ToString(-timbre);*/
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFactureAvoir.IsChecked == true)
                            {
                                timbre = -Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(-timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = (-(avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;
                        Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                    }
                    else
                    {
                        var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                            {
                                // timbre = (avecremise * 1 / 100);
                                //txtTimbre.Text = Convert.ToString(timbre);
                                //  var timbres = (avecremise * 1 / 100);

                                timbre = (avecremise * 1 / 100);
                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", timbre);
                                txtTimbre.Text = strtimbre;
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFacture.IsChecked == true)
                            {
                                timbre = Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = ((avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;

                        Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                    }
                    ReceptDatagrid.ItemsSource = test;
                }
                else
                {
                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;




                    foreach (var item in test)
                    {
                        item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                    }
                    if (documenttype == 2 || documenttype == 4)
                    {
                        var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                if (Convert.ToDecimal(txtRemise.Text) > 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                else
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) < 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                        remise = -Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                            {
                                //  var timbres = (avecremise * 1 / 100);
                                timbre = (avecremise * 1 / 100);

                                /* timbre = (avecremise * 1 / 100);
                                 txtTimbre.Text = Convert.ToString(-timbre);*/
                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", -timbre);
                                txtTimbre.Text = strtimbre;
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFactureAvoir.IsChecked == true)
                            {
                                timbre = -Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(-timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = (-(avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;
                        Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                    }
                    else
                    {
                        var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                            {
                                // timbre = (avecremise * 1 / 100);
                                //txtTimbre.Text = Convert.ToString(timbre);
                                //   var timbres = (avecremise * 1 / 100);

                                timbre = (avecremise * 1 / 100);
                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", timbre);
                                txtTimbre.Text = strtimbre;
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFacture.IsChecked == true)
                            {
                                timbre = Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = ((avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;

                        Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                    }
                    ReceptDatagrid.ItemsSource = test;
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }

        }
        private void ReceptDatagrid_SelectedCellsChanged(object sender, SelectedCellsChangedEventArgs e)
        {
            try
            {
                if (facturenonstock == false)
                {
                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;
                    var testprodf = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;

                    if (ReceptDatagrid.SelectedItem != null && testprodf.Count() > 0)
                    {
                        SVC.Facture selectedrecept = ReceptDatagrid.SelectedItem as SVC.Facture;
                        //   SVC.Prodf objectmodifed = (testprodf.ToList()).Find(n => n.Id == selectedrecept.ficheproduit);
                        SVC.Prodf objectmodifed = selectedtropuvé;

                        NomenclatureProduit.SelectedItem = objectmodifed;

                    }

                    foreach (var item in test)
                    {
                        item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                    }

                    if (documenttype == 2 || documenttype == 4)
                    {
                        var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                if (Convert.ToDecimal(txtRemise.Text) > 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                else
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) < 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                        remise = -Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                            {
                                //  var timbres = (avecremise * 1 / 100);
                                timbre = (avecremise * 1 / 100);

                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", -timbre);
                                txtTimbre.Text = strtimbre;
                                /* timbre = (avecremise * 1 / 100);
                                 txtTimbre.Text = Convert.ToString(-timbre);*/
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFactureAvoir.IsChecked == true)
                            {
                                timbre = -Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(-timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = (-(avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;
                        Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                    }
                    else
                    {
                        var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                            {
                                // timbre = (avecremise * 1 / 100);
                                //txtTimbre.Text = Convert.ToString(timbre);
                                //    var timbres = (avecremise * 1 / 100);

                                timbre = (avecremise * 1 / 100);
                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", timbre);
                                txtTimbre.Text = strtimbre;
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFacture.IsChecked == true)
                            {
                                timbre = Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = ((avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;

                        Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                    }



                    ReceptDatagrid.ItemsSource = test;

                }
                else
                {
                    var test = ReceptDatagrid.ItemsSource as IEnumerable<SVC.Facture>;



                    foreach (var item in test)
                    {
                        item.Total = (item.privente * item.quantite) + (((item.privente * item.quantite) * item.tva) / 100);
                    }

                    if (documenttype == 2 || documenttype == 4)
                    {
                        var ht = ((-test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = (-(test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = (-(test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                if (Convert.ToDecimal(txtRemise.Text) > 0)
                                {
                                    avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                    remise = Convert.ToDecimal(txtRemise.Text);
                                    Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                }
                                else
                                {
                                    if (Convert.ToDecimal(txtRemise.Text) < 0)
                                    {
                                        avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) + Convert.ToDecimal(txtRemise.Text);
                                        remise = -Convert.ToDecimal(txtRemise.Text);
                                        Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));
                                    }
                                }
                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && (chFacture.IsChecked == true || chFactureAvoir.IsChecked == true))
                            {
                                //  var timbres = (avecremise * 1 / 100);
                                timbre = (avecremise * 1 / 100);

                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", -timbre);
                                txtTimbre.Text = strtimbre;
                                /* timbre = (avecremise * 1 / 100);
                                 txtTimbre.Text = Convert.ToString(-timbre);*/
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFactureAvoir.IsChecked == true)
                            {
                                timbre = -Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(-timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = (-(avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;
                        Bénéficemont.Text = String.Format("{0:0.##}", (-Benf));
                    }
                    else
                    {
                        var ht = ((test.AsEnumerable().Sum(o => o.privente * o.quantite)));
                        string strht = string.Format("{0:0.00}", ht);
                        txtht.Text = strht;
                        //////////////////////////////////
                        var tva = ((test).AsEnumerable().Sum(o => ((o.privente * o.tva) / 100) * o.quantite));
                        string strtva = string.Format("{0:0.00}", tva);
                        txttva.Text = strtva;
                        /////////////////////////////////
                        var ttc = ((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)));
                        string strttc = string.Format("{0:0.00}", ttc);
                        txtTTC.Text = strttc;

                        decimal timbre = 0;
                        decimal remise = 0;
                        decimal avecremise = 0;
                        decimal Benf = 0;
                        if (txtRemise.Text != "")
                        {
                            if (Convert.ToDecimal(txtRemise.Text) != 0)
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite)))) - Convert.ToDecimal(txtRemise.Text);
                                remise = Convert.ToDecimal(txtRemise.Text);
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)) - Convert.ToDecimal(txtRemise.Text));

                            }
                            else
                            {
                                avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                                remise = 0;
                                Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                            }
                        }
                        else
                        {
                            avecremise = Convert.ToDecimal(((test).AsEnumerable().Sum(o => (((o.privente * o.tva) / 100) * o.quantite) + (o.privente * o.quantite))));
                            Benf = Convert.ToDecimal(((factureselectedl).AsEnumerable().Sum(o => o.privente * o.quantite)) - ((factureselectedl).AsEnumerable().Sum(o => o.previent * o.quantite)));

                        }
                        if (tunisie != true)
                        {
                            if (((ComboBoxItem)Modep.SelectedItem).Content.ToString() == "ESPECES" && chFacture.IsChecked == true)
                            {
                                // timbre = (avecremise * 1 / 100);
                                //txtTimbre.Text = Convert.ToString(timbre);
                                //var timbres = (avecremise * 1 / 100);

                                timbre = (avecremise * 1 / 100);
                                if (timbre > 2500)
                                {
                                    timbre = 2500;
                                }
                                string strtimbre = string.Format("{0:0.00}", timbre);
                                txtTimbre.Text = strtimbre;
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);

                            }
                        }
                        else
                        {
                            if (chFacture.IsChecked == true)
                            {
                                timbre = Convert.ToDecimal(0.6);
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                            else
                            {
                                timbre = 0;
                                txtTimbre.Text = Convert.ToString(timbre);
                            }
                        }
                        var Net = ((avecremise + timbre));
                        string strNet = string.Format("{0:0.00}", Net);
                        txtNet.Text = strNet;

                        Bénéficemont.Text = String.Format("{0:0.##}", Benf);
                    }



                    ReceptDatagrid.ItemsSource = test;
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(NewOptics.Properties.Resources.MessageBoxPrivilége, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void txtbarrecode_GotFocus(object sender, RoutedEventArgs e)
        {
            try
            {
                txtbarrecode.Text = "";
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }

        private void txtbarrecode_LostFocus_1(object sender, RoutedEventArgs e)
        {
            try
            {

                ((TextBox)sender).Text = "123456789";

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        private void txtbarrecode_KeyDown(object sender, KeyEventArgs e)
        {
            try
            {
                switch (e.Key)
                {
                    case Key.Enter:
                        if (/*txtbarrecode.Text.Count() == txtbarrecode.MaxLength && */CompteComboBox.SelectedIndex >= 0)
                        {
                            if (facturenonstock != true)
                            {
                                SVC.Prodf selectedtropuvé = retournercodebarreprodffirst(txtbarrecode.Text);
                                var existeproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).Any();
                                SVC.Produit selectedproduit = new SVC.Produit();
                                if (existeproduit)
                                {
                                    selectedproduit = proxy.GetAllProduitbyid(Convert.ToInt32(selectedtropuvé.cp)).First();
                                }
                                if (selectedtropuvé != null && selectedtropuvé.Id != 0 && selectedtropuvé.quantite > 0)
                                {
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.cp,
                                        date = DateTime.Now,
                                        datef = selectedtropuvé.datef,
                                        design = selectedtropuvé.design,
                                        lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        perempt = selectedtropuvé.perempt,
                                        tva = selectedtropuvé.tva,
                                        previent = selectedtropuvé.previent,
                                        privente = selectedtropuvé.privente,
                                        quantite = 1,
                                        Total = selectedtropuvé.privente * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        ff = selectedtropuvé.nfact,
                                        Fournisseur = selectedtropuvé.fourn,
                                        collisage = selectedtropuvé.collisage,
                                    };
                                    if (existeproduit)
                                    {
                                        facturevente.serialnumber = selectedproduit.marque;
                                    }
                                    else
                                    {
                                        facturevente.serialnumber = "";
                                    }
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {

                                        SVC.Prodf produitadd = new SVC.Prodf
                                        {
                                            cab = selectedtropuvé.cab,
                                            cf = selectedtropuvé.cf,
                                            cp = selectedtropuvé.cp,
                                            datef = selectedtropuvé.datef,
                                            dates = selectedtropuvé.dates,
                                            design = selectedtropuvé.design,
                                            famille = selectedtropuvé.famille,
                                            fourn = selectedtropuvé.fourn,
                                            IdFamille = selectedtropuvé.IdFamille,
                                            Id = selectedtropuvé.Id,
                                            lot = selectedtropuvé.lot,
                                            nfact = selectedtropuvé.nfact,
                                            perempt = selectedtropuvé.perempt,
                                            previent = selectedtropuvé.previent,
                                            privente = selectedtropuvé.privente,
                                            prixa = selectedtropuvé.quantite,
                                            prixb = selectedtropuvé.prixb,
                                            prixc = selectedtropuvé.prixc,
                                            quantite = 1,
                                            tva = selectedtropuvé.tva,
                                            collisage = selectedtropuvé.collisage,
                                        };
                                        produitadd.quantite = 1;
                                        produitavendre.Add(produitadd);
                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        SVC.Prodf selectedprodf = produitavendre.Find(n => n.Id == selectedtropuvé.Id);

                                        if (selectedprodf.Id == found.ficheproduit && found.quantite < selectedtropuvé.quantite)
                                        {
                                            found.quantite = found.quantite + 1;
                                            found.Total = found.Total + (facturevente.Total);
                                            selectedprodf.quantite = selectedprodf.quantite + 1;

                                        }
                                        else
                                        {
                                            MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        }




                                    }
                                    if (factureselectedl.Count > 0)
                                    {
                                        ReceptDatagrid.ItemsSource = factureselectedl;
                                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();





                                        txtbarrecode.Text = "";
                                        txtbarrecode.Focus();
                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Produit n'existe pas", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        txtbarrecode.Text = "";
                                        txtbarrecode.Focus();
                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Produit n'existe pas quantité quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                    txtbarrecode.Text = "";
                                    txtbarrecode.Focus();

                                }
                            }
                            else
                            {
                                SVC.Produit selectedtropuvé = retournercodebarreproduitfirst(txtbarrecode.Text);
                                if (selectedtropuvé != null && selectedtropuvé.Id != 0)
                                {
                                    if (selectedtropuvé.PrixRevient == null)
                                    {
                                        selectedtropuvé.PrixRevient = 0;
                                    }
                                    if (selectedtropuvé.PrixVente == null)
                                    {
                                        selectedtropuvé.PrixVente = 0;
                                    }
                                    SVC.Facture facturevente = new SVC.Facture
                                    {
                                        cab = selectedtropuvé.cab,
                                        //   cf = selectedtropuvé.cf,
                                        codeprod = selectedtropuvé.Id,
                                        date = DateTime.Now,
                                        datef = DateTime.Now,
                                        design = selectedtropuvé.design,
                                        // lot = selectedtropuvé.lot,
                                        oper = memberuser.Username,
                                        //   perempt = selectedtropuvé.perempt,
                                        tva = 0,
                                        previent = selectedtropuvé.PrixRevient,
                                        privente = selectedtropuvé.PrixVente,
                                        quantite = 1,
                                        Total = selectedtropuvé.PrixVente * 1,
                                        ficheproduit = selectedtropuvé.Id,
                                        //   ff = selectedtropuvé.nfact,
                                        //   Fournisseur = selectedtropuvé.fourn,
                                        collisage = 1,
                                        serialnumber = selectedtropuvé.marque,
                                    };

                                    //   factureselectedl.Add(facturevente);
                                    var found = factureselectedl.Find(item => item.ficheproduit == selectedtropuvé.Id);
                                    if (found == null)
                                    {

                                        factureselectedl.Add(facturevente);

                                    }
                                    else
                                    {
                                        found.quantite = found.quantite + 1;
                                        found.Total = found.Total + (facturevente.Total);
                                    }

                                    if (factureselectedl.Count > 0)
                                    {
                                        ReceptDatagrid.ItemsSource = factureselectedl;
                                        CollectionViewSource.GetDefaultView(ReceptDatagrid.ItemsSource).Refresh();





                                        txtbarrecode.Text = "";
                                        txtbarrecode.Focus();
                                    }
                                    else
                                    {
                                        MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Produit n'existe pas", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                        txtbarrecode.Text = "";
                                        txtbarrecode.Focus();
                                    }
                                }
                                else
                                {
                                    MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show("Produit n'existe pas quantité quantité insuffisante", NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
                                    txtbarrecode.Text = "";
                                    txtbarrecode.Focus();

                                }
                            }
                        }
                        break;
                }

            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);

            }
        }
        SVC.Produit retournercodebarreproduitfirst(string codeabarre)
        {

            var ll = proxy.GetAllTcabbycode(codeabarre).ToList();
            var test = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Produit>;
            SVC.Produit produit = new SVC.Produit();
            if (ll.Count > 0)
            {
                foreach (var itemcode in ll)
                {

                    var tte = test.Any(n => n.cab == itemcode.cleproduit);
                    if (tte == true)
                    {

                        var produitexiste = test.Where(n => n.cab == itemcode.cleproduit);

                        foreach (var prodff in produitexiste)
                        {



                            produit = prodff;
                            break;

                        }
                    }
                }
            }


            return produit;
        }
        SVC.Prodf retournercodebarreprodffirst(string codeabarre)
        {

            var ll = proxy.GetAllTcabbycode(codeabarre).ToList();
            var test = NomenclatureProduit.ItemsSource as IEnumerable<SVC.Prodf>;
            SVC.Prodf produit = new SVC.Prodf();
            if (ll.Count > 0)
            {
                foreach (var itemcode in ll)
                {

                    var tte = test.Any(n => n.cab == itemcode.cleproduit && n.quantite > 0);
                    if (tte == true)
                    {

                        var produitexiste = test.Where(n => n.cab == itemcode.cleproduit && n.quantite > 0);

                        foreach (var prodff in produitexiste)
                        {

                            bool selectedprodfexiste = produitavendre.Any(n => n.Id == prodff.Id);

                            if (prodff.perempt != null)
                            {

                                if (selectedprodfexiste)
                                {
                                    var selectedprodf = produitavendre.Find(n => n.Id == prodff.Id);

                                    if (prodff.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)) && selectedprodf.prixa > selectedprodf.quantite)
                                    {

                                        produit = prodff;
                                        break;
                                    }
                                }
                                else
                                {

                                    produit = prodff;
                                    break;

                                }
                            }
                            else
                            {
                                if (selectedprodfexiste)
                                {
                                    var selectedprodf = produitavendre.Find(n => n.Id == prodff.Id);
                                    if (selectedprodf.prixa > selectedprodf.quantite)
                                    {
                                        // if (selectedtropuvé.perempt.Value >= DateTime.Now.Date.AddDays(Convert.ToDouble(selectedparam.interdirperempt)))

                                        produit = prodff;
                                        break;
                                    }

                                }
                                else
                                {
                                    produit = prodff;
                                    break;
                                }
                            }



                        }
                    }
                }
            }


            return produit;
        }

        private void txtDateOper_SelectedDateChanged(object sender, SelectionChangedEventArgs e)
        {

        }
        private void txteche_KeyDown(object sender, KeyEventArgs e)
        {
            switch (e.Key)
            {
                case Key.NumPad0:
                case Key.NumPad1:
                case Key.NumPad2:
                case Key.NumPad3:
                case Key.NumPad4:
                case Key.NumPad5:
                case Key.NumPad6:
                case Key.NumPad7:
                case Key.NumPad8:
                case Key.NumPad9:
                case Key.D0:
                case Key.D1:
                case Key.D2:
                case Key.D3:
                case Key.D4:
                case Key.D5:
                case Key.D6:
                case Key.D7:
                case Key.D8:
                case Key.D9:
                case Key.Tab:
                    break;
                default:
                    e.Handled = true;
                    break;
            }
        }
        private void txtRemise_KeyDown(object sender, KeyEventArgs e)
        {
            switch (e.Key)
            {
                case Key.NumPad0:
                case Key.NumPad1:
                case Key.NumPad2:
                case Key.NumPad3:
                case Key.NumPad4:
                case Key.NumPad5:
                case Key.NumPad6:
                case Key.NumPad7:
                case Key.NumPad8:
                case Key.NumPad9:
                case Key.D0:
                case Key.D1:
                case Key.D2:
                case Key.D3:
                case Key.D4:
                case Key.D5:
                case Key.D6:
                case Key.D7:
                case Key.D8:
                case Key.D9:
                case Key.Decimal:
                case Key.Tab:
                case Key.Subtract:
                    break;
                default:
                    e.Handled = true;
                    break;
            }
        }

        private void CompteComboBox_DropDownClosed_1(object sender, EventArgs e)
        {
            try
            {
                if (facturenonstock != true)
                {
                    string ValueCompte = "";
                    if (CompteComboBox.SelectedIndex >= 0)
                    {

                        var test = NomenclatureProduit.ItemsSource as IEnumerable;



                        ValueCompte = ((ComboBoxItem)CompteComboBox.SelectedItem).Content.ToString();
                        switch (ValueCompte)
                        {
                            case "Prixa":
                                foreach (SVC.Prodf item in test)
                                {
                                    item.privente = item.prixa;
                                }

                                break;
                            case "Prixb":
                                foreach (SVC.Prodf item in test)
                                {
                                    item.privente = item.prixb;
                                }
                                break;

                            case "Prixc":
                                foreach (SVC.Prodf item in test)
                                {
                                    item.privente = item.prixc;
                                }
                                break;

                            default:
                                break;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBoxResult result = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Stop);
            }
        }

        private void txtPresSphereDroite_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                decimal LoinAddDroite, LoinSphereDroite, PresSphereDroite = 0;


                /*     if (txtLoinAddDroite.Text != "")
                     {
                         if (decimal.TryParse(txtLoinAddDroite.Text, out LoinAddDroite))
                             LoinAddDroite = Convert.ToDecimal(txtLoinAddDroite.Text);
                         else
                             LoinAddDroite = 0;
                     }
                     else
                     {*/
                if (txtLoinSphereDroite.Text != "")
                {
                    if (decimal.TryParse(txtLoinSphereDroite.Text, out LoinSphereDroite))
                        LoinSphereDroite = Convert.ToDecimal(txtLoinSphereDroite.Text);
                    else
                        LoinSphereDroite = 0;
                }
                else
                {
                    txtLoinSphereDroite.Text = "";
                    LoinSphereDroite = 0;
                }
                if (txtPresSphereDroite.Text != "")
                {
                    if (decimal.TryParse(txtPresSphereDroite.Text, out PresSphereDroite))
                    {
                        PresSphereDroite = Convert.ToDecimal(txtPresSphereDroite.Text);


                    }
                    else
                    {
                        PresSphereDroite = 0;


                    }
                }
                else
                {
                    PresSphereDroite = 0;
                    txtPresSphereDroite.Text = "";
                }

                if (PresSphereDroite != 0 && LoinSphereDroite != 0)
                {
                    LoinAddDroite = (PresSphereDroite - LoinSphereDroite);
                    txtLoinAddDroite.Text = (PresSphereDroite - LoinSphereDroite).ToString();
                }
                else
                {
                    LoinAddDroite = 0;
                    txtLoinAddDroite.Text = "";
                }

                //  txtLoinAddDroite.Text = "";
                //LoinAddDroite = 0;
                // }
                //   txtLoinAddDroite.Text = (PresSphereDroite - LoinSphereDroite).ToString();

            }
            catch (Exception ex)
            {
                MessageBoxResult resultc1 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }

        private void txtPresSphereGauche_TextChanged(object sender, TextChangedEventArgs e)
        {
            try
            {

                decimal LoinAddGauche, LoinSphereGauche, PresSphereGauche = 0;


                /*     if (txtLoinAddDroite.Text != "")
                     {
                         if (decimal.TryParse(txtLoinAddDroite.Text, out LoinAddDroite))
                             LoinAddDroite = Convert.ToDecimal(txtLoinAddDroite.Text);
                         else
                             LoinAddDroite = 0;
                     }
                     else
                     {*/
                if (txtLoinSphereGauche.Text != "")
                {
                    if (decimal.TryParse(txtLoinSphereGauche.Text, out LoinSphereGauche))
                        LoinSphereGauche = Convert.ToDecimal(txtLoinSphereGauche.Text);
                    else
                        LoinSphereGauche = 0;
                }
                else
                {
                    txtLoinSphereGauche.Text = "";
                    LoinSphereGauche = 0;
                }
                if (txtPresSphereGauche.Text != "")
                {
                    if (decimal.TryParse(txtPresSphereGauche.Text, out PresSphereGauche))
                    {
                        PresSphereGauche = Convert.ToDecimal(txtPresSphereGauche.Text);


                    }
                    else
                    {
                        PresSphereGauche = 0;


                    }
                }
                else
                {
                    PresSphereGauche = 0;
                    txtPresSphereGauche.Text = "";
                }

                if (PresSphereGauche != 0 && LoinSphereGauche != 0)
                {
                    LoinAddGauche = (PresSphereGauche - LoinSphereGauche);
                    txtLoinAddGauche.Text = (PresSphereGauche - LoinSphereGauche).ToString();
                }
                else
                {
                    LoinAddGauche = 0;
                    txtLoinAddGauche.Text = "";
                }

                //  txtLoinAddDroite.Text = "";
                //LoinAddDroite = 0;
                // }
                //   txtLoinAddDroite.Text = (PresSphereDroite - LoinSphereDroite).ToString();

            }
            catch (Exception ex)
            {
                MessageBoxResult resultc1 = Xceed.Wpf.Toolkit.MessageBox.Show(ex.Message, NewOptics.Properties.Resources.SiteWeb, MessageBoxButton.OK, MessageBoxImage.Error);

            }
        }
    }
}
